{% extends 'base.html' %}

{% block content %}
<style>
    /* Estilos adicionales si fueran necesarios */
    /* Estilos para el botón flotante (FAB) */
    .fab-container {
        position: fixed;
        bottom: 70px; /* Distancia desde abajo para alinearse con ver_caminatas */
        right: 20px; /* Distancia desde la derecha */
        z-index: 1000; /* Asegura que esté por encima de otros elementos */
    }
    .fab-container.left { /* Contenedor para el botón flotante de la izquierda */
        left: 20px; /* Distancia desde la izquierda */
        right: auto; /* Anula la distancia derecha */
    }
    .fab-button {
        width: 60px; /* Tamaño del botón */
        height: 60px; /* Tamaño del botón */
        border-radius: 50%; /* Hacerlo circular */
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem; /* Tamaño del icono */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Sombra para que se vea flotante */
        transition: all 0.3s ease;
    }
    .fab-button:hover {
        transform: scale(1.05); /* Pequeño efecto al pasar el ratón */
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }
    .totals-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
    /* Estilos para la tarjeta de historial */
    .historial-card {
        border: 1px solid #dee2e6;
        border-left-width: 5px;
        transition: box-shadow 0.3s ease-in-out;
    }
    .historial-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .historial-card-header {
        background-color: rgba(0,0,0,0.03);
        padding: 0.75rem 1.25rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
</style>

<div class="container">
    <div class="p-4 mb-5">
        <h2 class="card-title text-center mb-4 text-warning mt-4">Recibo para Caminante</h2>

        <div class="row mb-4">
            <div class="col-md-6">
                <p><strong>Caminata:</strong> {{ caminata.nombre }}</p>
                <p><strong>Fecha de Caminata:</strong> {{ caminata.fecha.strftime('%d-%m-%Y') }}</p>
                <p><strong>Actividad:</strong> {{ caminata.actividad }}</p>
                <p><strong>Dificultad:</strong> {{ caminata.dificultad if caminata.dificultad else 'N/A' }}</p>
                <p><strong>Distancia:</strong> {{ "%.1f km"|format(caminata.distancia) if caminata.distancia is not none else 'N/A' }}</p>
            </div>
            <div class="col-md-6 text-md-end">
                <p><strong>Participante:</strong> {{ participante.nombre }} {{ participante.primer_apellido }}</p>
                <p><strong>Precio por Persona:</strong> {% if caminata.moneda == 'USD' %}${% else %}¢{% endif %}{{ caminata.precio | int }}</p>
                
                {# Se definen variables para hacer el código más claro y robusto #}
                {% set price = caminata.precio | float %}
                {% set paid_crc_from_db = total_abonado_crc | default(0) | float %}
                {% set paid_usd_from_db = total_abonado_usd | default(0) | float %}
                {% set exchange_rate = abonos[0].tipo_cambio_bcr | float if abonos and abonos[0].tipo_cambio_bcr else 0 %}

                {# Lógica de cálculo de saldos restantes #}
                {% if caminata.moneda == 'USD' %}
                    {% set price_in_crc = price * exchange_rate if exchange_rate > 0 else 0 %}
                    {% set remaining_usd = price - paid_usd_from_db %}
                {% else %}
                    {% set price_in_crc = price %}
                    {% set remaining_usd = 0 - paid_usd_from_db %}
                {% endif %}

                {% set total_paid_in_crc = paid_crc_from_db + (paid_usd_from_db * exchange_rate) %}
                {% set remaining_crc = price_in_crc - total_paid_in_crc %}

                {% set is_cancelled = false %}
                {% if caminata.moneda == 'USD' %}
                    {% if price_in_crc > 0 and total_paid_in_crc >= price_in_crc %}
                        {% set is_cancelled = true %}
                    {% elif paid_usd_from_db >= price %}
                        {% set is_cancelled = true %}
                    {% endif %}
                {% else %} 
                    {% if total_paid_in_crc >= price %}
                        {% set is_cancelled = true %}
                    {% endif %}
                {% endif %}

                <div class="totals-grid mt-3">
                    <div>
                        <h5 class="text-success">Total Abonado CRC:</h5>
                        <h4><strong id="display_total_crc">¢{{ total_paid_in_crc | int }}</strong></h4>
                    </div>
                    <div>
                        <h5 class="text-success">Total Abonado USD:</h5>
                        <h4><strong>${{ paid_usd_from_db | int }}</strong></h4>
                    </div>
                    <div>
                        <h5 class="text-danger">Monto Restante CRC:</h5>
                        {% if is_cancelled %}
                            <h4><strong id="display_remaining_crc" class="text-success">CANCELADO</strong></h4>
                        {% else %}
                            <h4><strong id="display_remaining_crc">¢{{ remaining_crc | int }}</strong></h4>
                        {% endif %}
                    </div>
                    <div>
                        <h5 class="text-danger">Monto Restante USD:</h5>
                        {% if is_cancelled %}
                            <h4><strong id="display_remaining_usd" class="text-success">CANCELADO</strong></h4>
                        {% else %}
                            <h4><strong id="display_remaining_usd">${{ remaining_usd | int }}</strong></h4>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <hr>

        <h4 class="mb-3 text-warning">Registrar Nuevo Abono</h4>
        <form id="abonoForm" method="POST" action="{{ url_for('caminatas.abono_caminata', caminata_id=caminata.id, user_id=participante.id) }}">
            <input type="hidden" name="add_abono" value="true">
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label for="opcion" class="form-label">Opción <span class="text-danger">*</span>:</label>
                    <select class="form-select" id="opcion" name="opcion" required>
                        <option value="">Seleccionar Opción</option>
                        <option value="Abono">Abono</option>
                        <option value="Reserva">Reserva</option>
                        <option value="Cancelación">Cancelación</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="cantidad_acompanantes" class="form-label">Cantidad Acompañantes:</label>
                    <select class="form-select" id="cantidad_acompanantes" name="cantidad_acompanantes" required>
                        {% for i in range(10) %}
                        <option value="{{ i }}">{{ i }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-6">
                    <label for="fecha_abono" class="form-label">Fecha de Abono <span class="text-danger">*</span>:</label>
                    <input type="date" class="form-control" id="fecha_abono" name="fecha_abono" required>
                </div>
                <!-- INICIO DE LA MODIFICACIÓN: Añadir campo "Periodo que Cancela" -->
                <div class="col-md-6">
                    <label for="periodo_cancela" class="form-label">Periodo que Cancela:</label>
                    <input type="date" class="form-control" id="periodo_cancela" name="periodo_cancela">
                </div>
                <!-- FIN DE LA MODIFICACIÓN -->

                <div class="col-md-4">
                    <label for="tipo_cambio_bcr" class="form-label">Tipo de Cambio USD-BCCR:</label>
                    <input type="number" step="0.01" class="form-control" id="tipo_cambio_bcr" name="tipo_cambio_bcr" placeholder="Ej: 515.50" {% if caminata.moneda == 'CRC' %}disabled{% endif %}>
                </div>
                <div class="col-md-4">
                    <label for="monto_abono_crc" class="form-label">Monto Abonado CRC:</label>
                    <div class="input-group">
                        <span class="input-group-text">¢</span>
                        <input type="number" step="1" class="form-control" id="monto_abono_crc" name="monto_abono_crc" min="0" value="0" {% if caminata.moneda == 'USD' %}disabled{% endif %}>
                    </div>
                </div>
                <div class="col-md-4">
                    <label for="monto_abono_usd" class="form-label">Monto Abonado USD:</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" step="1" class="form-control" id="monto_abono_usd" name="monto_abono_usd" min="0" value="0" {% if caminata.moneda == 'CRC' %}disabled{% endif %}>
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label for="nombres_acompanantes_raw" class="form-label">Nombres de Acompañantes o Detalles (separados por comas):</label>
                <textarea class="form-control" id="nombres_acompanantes_raw" name="nombres_acompanantes_raw" rows="2" placeholder="Ej: Juan Pérez, María Gómez"></textarea>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-warning">Agregar Abono</button>
            </div>
        </form>

        <hr>

        <h4 class="mb-3 text-warning">Historial de Abonos</h4>
        {% if abonos %}
        <div id="historial-abonos-bloques">
            {% for abono in abonos %}
            <div class="card mb-3 historial-card border-warning">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="card-title">
                                <strong>{{ abono.opcion }}</strong> - <span class="text-muted">{{ abono.fecha_abono.strftime('%d-%m-%Y') }}</span>
                            </h5>
                            <p class="card-text mb-1">
                                {% set crc_val = abono.monto_abono_crc | default(0) | float %}
                                {% set usd_val = abono.monto_abono_usd | default(0) | float %}
                                {% set tc_val = abono.tipo_cambio_bcr | float if abono.tipo_cambio_bcr else 0 %}
                                {% set display_crc = crc_val + (usd_val * tc_val) %}
                                <strong>Monto Total (calculado en CRC):</strong> ¢{{ display_crc | int }}
                                {% if usd_val > 0 %}
                                    (Abono original: ${{ usd_val | int }} a T.C. {{ tc_val }})
                                {% endif %}
                            </p>
                            <p class="card-text mb-1">
                                <strong>Acompañantes:</strong> {{ abono.cantidad_acompanantes }}
                            </p>
                            <p class="card-text">
                                {% set nombres_acom = abono.nombres_acompanantes|from_json %}
                                <strong>Detalles:</strong> {{ nombres_acom|join(', ') if nombres_acom else 'N/A' }}
                            </p>
                            <!-- INICIO DE LA MODIFICACIÓN: Mostrar "Periodo que Cancela" si existe -->
                            {% if abono.periodo_cancela %}
                            <p class="card-text">
                                <strong>Periodo que Cancela:</strong> {{ abono.periodo_cancela.strftime('%d-%m-%Y') }}
                            </p>
                            {% endif %}
                            <!-- FIN DE LA MODIFICACIÓN -->
                        </div>
                        <div class="col-md-4 d-flex align-items-center justify-content-end">
                             <form action="{{ url_for('caminatas.abono_caminata', caminata_id=caminata.id, user_id=participante.id) }}" method="POST" class="d-inline">
                                <input type="hidden" name="delete_abono" value="true">
                                <input type="hidden" name="abono_id" value="{{ abono.id }}">
                                <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('¿Estás seguro de que quieres eliminar este abono?');">
                                    <i class="fas fa-trash-alt"></i> Borrar
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-warning text-center" role="alert">
            No hay abonos registrados para este participante en esta caminata aún.
        </div>
        {% endif %}

        <hr>

        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-2 mt-4">
            <div class="col">
                <a href="{{ url_for('caminatas.exportar_abono_pdf', caminata_id=caminata.id, user_id=participante.id) }}" class="btn btn-warning w-100" style="color: black;">Exportar PDF</a>
            </div>
            <div class="col">
                <a href="{{ url_for('caminatas.exportar_abono_jpg', caminata_id=caminata.id, user_id=participante.id) }}" class="btn btn-warning w-100" style="color: black;">Exportar JPG</a>
            </div>
            <div class="col">
                <a href="{{ url_for('caminatas.exportar_abono_txt', caminata_id=caminata.id, user_id=participante.id) }}" class="btn btn-warning w-100" style="color: black;">Exportar TXT</a>
            </div>
        </div>
    </div>
</div>

{# Se pasa el último tipo de cambio y los valores base a JS #}
{% set latest_exchange_rate = abonos[0].tipo_cambio_bcr if abonos and abonos[0].tipo_cambio_bcr else None %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Poner fecha actual en los campos de fecha
        const fechaAbonoInput = document.getElementById('fecha_abono');
        const periodoCancelaInput = document.getElementById('periodo_cancela');
        
        if (fechaAbonoInput) {
            const today = new Date().toISOString().split('T')[0];
            fechaAbonoInput.value = today;
        }
        if (periodoCancelaInput) {
            const today = new Date().toISOString().split('T')[0];
            periodoCancelaInput.value = today;
        }

        // Bloque para mantener los valores del formulario entre recargas
        const nombresAcompanantesInput = document.getElementById('nombres_acompanantes_raw');
        const cantidadAcompanantesSelect = document.getElementById('cantidad_acompanantes');
        const abonoForm = document.getElementById('abonoForm');
        const nombresStorageKey = 'lastNombresAcompanantes_' + window.location.pathname;
        const cantidadStorageKey = 'lastCantidadAcompanantes_' + window.location.pathname;
        if (nombresAcompanantesInput) {
            const savedNombres = sessionStorage.getItem(nombresStorageKey);
            if (savedNombres) { nombresAcompanantesInput.value = savedNombres; }
        }
        if (cantidadAcompanantesSelect) {
            const savedCantidad = sessionStorage.getItem(cantidadStorageKey);
            if (savedCantidad) { cantidadAcompanantesSelect.value = savedCantidad; }
        }
        if (abonoForm) {
            abonoForm.addEventListener('submit', function() {
                if (nombresAcompanantesInput) { sessionStorage.setItem(nombresStorageKey, nombresAcompanantesInput.value); }
                if (cantidadAcompanantesSelect) { sessionStorage.setItem(cantidadStorageKey, cantidadAcompanantesSelect.value); }
            });
        }

        // Lógica de conversión de moneda
        const exchangeRateInput = document.getElementById('tipo_cambio_bcr');
        const totalCrcElement = document.getElementById('display_total_crc');
        const remainingCrcElement = document.getElementById('display_remaining_crc');

        const initialTotalCrc = totalCrcElement.textContent;
        const initialRemainingCrc = remainingCrcElement.textContent;

        const paid_crc_from_db = {{ total_abonado_crc | default(0) | tojson }};
        const paid_usd_from_db = {{ total_abonado_usd | default(0) | tojson }};
        const price = {{ caminata.precio | float | tojson }};
        const isUsdCurrency = {{ caminata.moneda == 'USD' | tojson }};

        function updateCrcValues(rate) {
            const exchangeRate = parseFloat(rate);

            if (!isNaN(exchangeRate) && exchangeRate > 0) {
                const totalPaidInCrc = paid_crc_from_db + (paid_usd_from_db * exchangeRate);
                let priceInCrc = isUsdCurrency ? price * exchangeRate : price;
                const remainingCrc = priceInCrc - totalPaidInCrc;

                totalCrcElement.textContent = '¢' + Math.round(totalPaidInCrc);
                
                if (remainingCrc <= 0) {
                    remainingCrcElement.textContent = 'CANCELADO';
                    remainingCrcElement.classList.add('text-success');
                    const remainingUsdElement = document.getElementById('display_remaining_usd');
                    if(remainingUsdElement) {
                        remainingUsdElement.textContent = 'CANCELADO';
                        remainingUsdElement.classList.add('text-success');
                    }
                } else {
                    remainingCrcElement.textContent = '¢' + Math.round(remainingCrc);
                    remainingCrcElement.classList.remove('text-success');
                }
            } else {
                totalCrcElement.textContent = initialTotalCrc;
                remainingCrcElement.textContent = initialRemainingCrc;
                remainingCrcElement.classList.remove('text-success');
            }
        }

        exchangeRateInput.addEventListener('input', function() {
            updateCrcValues(this.value);
        });

        const latestExchangeRate = {{ latest_exchange_rate | tojson }};
        if (latestExchangeRate) {
            exchangeRateInput.value = latestExchangeRate;
        }
    });
</script>

<div class="fab-container left">
    <a href="{{ url_for('caminatas.detalle_caminata', caminata_id=caminata.id) }}" class="btn btn-primary fab-button" title="Volver al Detalle de la Caminata">
        <i class="fas fa-arrow-left"></i>
    </a>
</div>
{% endblock %}
