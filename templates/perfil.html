{% extends 'base.html' %}

{% block title %}Mi Perfil{% endblock %}

{% block head_content %}
<style>
    /* --- ESTILOS DEL PERFIL DETALLADO (DE TU ARCHIVO) --- */
    .hidden-for-capture {
        visibility: hidden !important;
    }
    .fab-container {
        position: fixed;
        z-index: 1000;
    }
    .fab-button {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        transition: all 0.3s ease;
        border: none;
        text-decoration: none;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .fab-button:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }
    .fab-container-back { bottom: 70px; left: 20px; }
    .fab-button-back { background-color: #007bff; color: #ffffff; }
    .fab-button-back:hover { background-color: #0056b3; }
    .fab-container-backup { bottom: 70px; right: 20px; }
    .fab-button-backup { background-color: #6f42c1; color: #ffffff; }
    .fab-button-backup:hover { background-color: #5a359a; }
    .fab-container-stats { bottom: 140px; right: 20px; }
    .fab-button-stats { background-color: #28a745; color: #ffffff; }
    .fab-button-stats:hover { background-color: #218838; }
    .fab-container-change-password { bottom: 210px; right: 20px; }
    .fab-button-change-password { background-color: #17a2b8; color: #ffffff; }
    .fab-button-change-password:hover { background-color: #117a8b; }
    .fab-container-upload-db { bottom: 280px; right: 20px; }
    .fab-button-upload-db { background-color: #ffc107; color: #212529; }
    .fab-button-upload-db:hover { background-color: #e0a800; }

    #profile-details-card {
        background-color: transparent; /* Fondo transparente */
        padding: 0;
        box-shadow: none !important;
        border: none !important;
    }
    .profile-avatar {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 50%;
        border: 4px solid #ffc107 !important;
    }
    .list-group-item {
        border: none !important;
        padding: 8px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .list-group-item:not(:last-child) {
        border-bottom: 1px dotted #e9ecef !important;
    }
    #export-buttons-container {
        margin-bottom: 80px;
    }
    .img-thumbnail {
        border: none !important;
    }
    body {
        padding-top: 70px;
    }

    /* --- NUEVOS ESTILOS PARA EL DASHBOARD DE ENLACES --- */
    .dashboard-header {
        text-align: center;
        margin-bottom: 2.5rem;
    }
    .dashboard-section {
        margin-bottom: 2.5rem;
    }
    .dashboard-section h3 {
        text-align: center;
        margin-bottom: 1.5rem;
        font-weight: 600;
        color: #343a40;
    }
    .dashboard-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem; /* Espacio reducido entre enlaces */
    }
    .dashboard-link {
        display: flex; /* Cambiado a flex para alinear icono y texto */
        align-items: center; /* Alinear verticalmente */
        padding: 0.75rem 1rem;
        background-color: #f8f9fa;
        border: 1px solid transparent;
        border-radius: 8px;
        text-decoration: none;
        color: #212529;
        font-weight: 500;
        transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        text-align: left;
    }
    .dashboard-link.btn-warning {
        background-color: transparent;
        border: 1px solid #ffc107;
        color: #212529;
    }
    .dashboard-link.btn-warning:hover {
        background-color: #ffc107;
        color: #212529;
    }
    .dashboard-link i {
        font-size: 1em; /* Icono más pequeño */
        margin-right: 1rem; /* Espacio entre icono y texto */
        width: 20px; /* Ancho fijo para alineación */
        text-align: center;
        color: #6c757d;
    }
    .dashboard-link.btn-warning i {
        color: #e0a800;
    }
    .dashboard-link span {
        font-size: 1rem;
    }
    .superuser-section {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 2px dashed #ffc107;
    }
    .superuser-section h3 {
        color: #c82333;
    }

    @media (max-width: 768px) {
        .fab-container-back { bottom: 60px; left: 15px; }
        .fab-container-backup { bottom: 60px; right: 15px; }
        .fab-container-stats { bottom: calc(60px + 60px + 5px); right: 15px; }
        .fab-container-change-password { bottom: calc(125px + 60px + 5px); right: 15px; }
        .fab-container-upload-db { bottom: calc(190px + 60px + 5px); right: 15px; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-9 col-lg-8">
            <div id="profile-details-card" class="p-4">
                <div class="dashboard-header">
                    {% if user.avatar_url %}
                        <img src="{{ url_for('static', filename=user.avatar_url) }}" alt="Avatar de {{ user.username }}" class="profile-avatar">
                    {% else %}
                        <img src="{{ url_for('static', filename='uploads/avatars/default.png') }}" alt="Avatar por defecto" class="profile-avatar">
                    {% endif %}
                    <h1 class="h3 mt-3">Bienvenido, {{ user.username }}</h1>
                    <p class="text-muted">@{{ user.username }}</p>
                </div>

                <!-- SECCIÓN DE NAVEGACIÓN RÁPIDA -->
                <div class="dashboard-section">
                    <h3>Navegación Rápida</h3>
                    <div class="dashboard-list">
                        <a href="{{ url_for('caminatas.ver_caminatas') }}" class="dashboard-link btn-warning">
                            <i class="fas fa-hiking"></i>
                            <span>Caminatas</span>
                        </a>
                        <a href="{{ url_for('player.show_player') }}" class="dashboard-link btn-warning">
                            <i class="fas fa-music"></i>
                            <span>Música</span>
                        </a>
                        <a href="{{ url_for('rutas.ver_rutas') }}" class="dashboard-link btn-warning">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>Rutas</span>
                        </a>
                        <a href="{{ url_for('aboutus.ver_aboutus') }}" class="dashboard-link btn-warning">
                            <i class="fas fa-info-circle"></i>
                            <span>Acerca de</span>
                        </a>
                    </div>
                </div>

                <!-- SECCIÓN DE ACCIONES PERSONALES -->
                <div class="dashboard-section" id="personal-actions-section">
                    <h3>Acciones Personales</h3>
                    <div class="dashboard-list">
                        <a href="{{ url_for('perfil.editar_perfil') }}" class="dashboard-link btn-warning">
                            <i class="fas fa-user-edit"></i>
                            <span>Editar mi Información</span>
                        </a>
                        
                        {% set first_digit = user.telefono[0] if user.telefono else '' %}
                        {% set disable_whatsapp = first_digit in ['1', '2', '3', '4', '5', '9', '0'] %}
                        {% if disable_whatsapp %}
                            <a href="#" class="dashboard-link btn-warning disabled" title="Este número de teléfono no es compatible con WhatsApp.">
                                <i class="fab fa-whatsapp"></i>
                                <span>Compartir por WhatsApp</span>
                            </a>
                        {% else %}
                            <a href="https://wa.me/{{ user.telefono }}?text={{ ('Hola, te comparto tu información de perfil: ' + user.nombre + ' ' + user.primer_apellido + ((' ' + user.segundo_apellido) if user.segundo_apellido else '') + '. Tu teléfono es ' + user.telefono + '.')|urlencode }}" target="_blank" class="dashboard-link btn-warning">
                                <i class="fab fa-whatsapp"></i>
                                <span>Compartir por WhatsApp</span>
                            </a>
                        {% endif %}

                        {% if session.get('role') == 'Superuser' %}
                        <a href="{{ url_for('files.ver_files') }}" class="dashboard-link btn-warning">
                            <i class="fas fa-folder"></i>
                            <span>Mis Archivos</span>
                        </a>
                        {% endif %}

                        <a href="#" id="exportMyProfileJpgBtn" class="dashboard-link btn-warning">
                            <i class="fas fa-file-export"></i>
                            <span>Exportar Perfil (JPG)</span>
                        </a>
                    </div>
                </div>

                {% if session.role == 'Superuser' %}
                <div class="dashboard-section superuser-section">
                    <h3>Panel de Superusuario</h3>
                    <div class="dashboard-list">
                        <a href="{{ url_for('pagos.ver_pagos') }}" class="dashboard-link btn-warning">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>Pagos</span>
                        </a>
                        <a href="{{ url_for('polizas.ver_polizas') }}" class="dashboard-link btn-warning">
                            <i class="fas fa-file-shield"></i>
                            <span>Pólizas</span>
                        </a>
                        <a href="{{ url_for('calendario.ver_calendario') }}" class="dashboard-link btn-warning">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Calendario</span>
                        </a>
                        <a href="{{ url_for('instrucciones.ver_instrucciones') }}" class="dashboard-link btn-warning">
                            <i class="fas fa-list-ol"></i>
                            <span>Instrucciones</span>
                        </a>
                        <a href="{{ url_for('contactos.ver_contactos') }}" class="dashboard-link btn-warning">
                            <i class="fas fa-address-book"></i>
                            <span>Contactos</span>
                        </a>
                        <a href="{{ url_for('proyecto.ver_proyectos') }}" class="dashboard-link btn-warning">
                            <i class="fas fa-project-diagram"></i>
                            <span>Proyectos</span>
                        </a>
                        <a href="{{ url_for('notas.ver_notas') }}" class="dashboard-link btn-warning">
                            <i class="fas fa-sticky-note"></i>
                            <span>Notas</span>
                        </a>
                        <a href="{{ url_for('intern.index') }}" class="dashboard-link btn-warning">
                            <i class="fas fa-globe-americas"></i>
                            <span>Internacional</span>
                        </a>
                        <a href="{{ url_for('btns.crear_btns') }}" class="dashboard-link btn-warning">
                            <i class="fas fa-toggle-on"></i>
                            <span>Botones Flotantes</span>
                        </a>
                        <a href="{{ url_for('contactos.admin_manage_roles') }}" class="dashboard-link btn-warning">
                            <i class="fas fa-user-shield"></i>
                            <span>Administrar Roles</span>
                        </a>
                    </div>
                </div>
                {% endif %}

                <hr class="my-4">

                <!-- INFORMACIÓN DETALLADA DEL PERFIL -->
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <h4 class="text-warning mb-3">Información de Contacto</h4>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                <strong>Teléfono:</strong>
                                <span>{{ user.telefono }}</span>
                            </li>
                            {% if user.email %}
                            <li class="list-group-item">
                                <strong>Email:</strong>
                                <span>{{ user.email }}</span>
                            </li>
                            {% endif %}
                            {% if user.telefono_emergencia %}
                            <li class="list-group-item">
                                <strong>Tel. Emergencia:</strong>
                                <span>{{ user.telefono_emergencia }}</span>
                            </li>
                            {% endif %}
                            {% if user.nombre_emergencia %}
                            <li class="list-group-item">
                                <strong>Contacto Emergencia:</strong>
                                <span>{{ user.nombre_emergencia }}</span>
                            </li>
                            {% endif %}
                            {% if user.direccion %}
                            <li class="list-group-item">
                                <strong>Provincia:</strong>
                                <span>{{ user.direccion }}</span>
                            </li>
                            {% endif %}
                        </ul>
                    </div>

                    <div class="col-md-6 mb-4">
                        <h4 class="text-warning mb-3">Información Adicional</h4>
                        <ul class="list-group list-group-flush">
                            {% if user.cedula %}
                            <li class="list-group-item">
                                <strong>Cédula:</strong>
                                <span>{{ user.cedula }}</span>
                            </li>
                            {% endif %}
                            {% if user.empresa %}
                            <li class="list-group-item">
                                <strong>Empresa:</strong>
                                <span>{{ user.empresa }}</span>
                            </li>
                            {% endif %}
                            {% if session.role == 'Superuser' and user.actividad %}
                            <li class="list-group-item">
                                <strong>Actividad:</strong>
                                <span>{{ user.actividad }}</span>
                            </li>
                            {% endif %}
                            {% if session.role == 'Superuser' and user.capacidad %}
                            <li class="list-group-item">
                                <strong>Capacidad:</strong>
                                <span>{{ user.capacidad }}</span>
                            </li>
                            {% endif %}
                            {% if session.role == 'Superuser' and user.participacion %}
                            <li class="list-group-item">
                                <strong>Participación:</strong>
                                <span>{{ user.participacion }}</span>
                            </li>
                            {% endif %}
                            {% if user.fecha_cumpleanos %}
                            <li class="list-group-item">
                                <strong>Cumpleaños:</strong>
                                <span>{{ user.fecha_cumpleanos.strftime('%d/%m/%Y') }}</span>
                            </li>
                            {% endif %}
                            {% if user.tipo_sangre %}
                            <li class="list-group-item">
                                <strong>Tipo de Sangre:</strong>
                                <span>{{ user.tipo_sangre }}</span>
                            </li>
                            {% endif %}
                            {% if user.poliza %}
                            <li class="list-group-item">
                                <strong>Póliza:</strong>
                                <span>{{ user.poliza }}</span>
                            </li>
                            {% endif %}
                            {% if user.aseguradora %}
                            <li class="list-group-item">
                                <strong>Aseguradora:</strong>
                                <span>{{ user.aseguradora }}</span>
                            </li>
                            {% endif %}
                            {% if user.alergias %}
                            <li class="list-group-item">
                                <strong>Alergias:</strong>
                                <span>{{ user.alergias }}</span>
                            </li>
                            {% endif %}
                            {% if user.enfermedades_cronicas %}
                            <li class="list-group-item">
                                <strong>Enf. Crónicas:</strong>
                                <span>{{ user.enfermedades_cronicas }}</span>
                            </li>
                            {% endif %}
                             <li class="list-group-item">
                                <strong>Fecha de Registro:</strong>
                                <span>
                                    {% set reg_date = user.fecha_registro | to_datetime %}
                                    {% if reg_date %}
                                        {{ reg_date.strftime('%d/%m/%Y %H:%M') }}
                                    {% else %}
                                        Fecha inválida
                                    {% endif %}
                                </span>
                            </li>
                            {% if user.fecha_actualizacion %}
                            <li class="list-group-item">
                                <strong>Última Actualización:</strong>
                                <span>
                                    {% set upd_date = user.fecha_actualizacion | to_datetime %}
                                    {% if upd_date %}
                                        {{ upd_date.strftime('%d/%m/%Y %H:%M') }}
                                    {% else %}
                                        Fecha inválida
                                    {% endif %}
                                </span>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>

                <div class="d-flex flex-wrap justify-content-center gap-2 mt-4" id="export-buttons-container" style="display: none !important;">
                    <!-- Este contenedor ahora está oculto y solo se usa como referencia para el script de captura -->
                </div>
            </div>
        </div>
    </div>

    <!-- BOTONES FLOTANTES -->
    <div class="fab-container fab-container-back">
        <a href="{{ url_for('home') }}" class="fab-button fab-button-back" title="Volver a Inicio">
            <i class="fas fa-arrow-left"></i>
        </a>
    </div>
    {% if session.get('role') == 'Superuser' %}
    <div class="fab-container fab-container-backup">
        <button type="button" class="fab-button fab-button-backup" title="Hacer Backup de la Base de Datos" onclick="performBackup()">
            <i class="fas fa-database"></i>
        </button>
    </div>
    {% endif %}
    {% if session.role == 'Superuser' %}
    <div class="fab-container fab-container-stats">
        <a href="{{ url_for('perfil.dashboard_stats') }}" class="fab-button fab-button-stats" title="Ver Estadísticas del Sitio">
            <i class="fas fa-chart-bar"></i>
        </a>
    </div>
    {% endif %}
    {% if session.get('logged_in') %}
    <div class="fab-container fab-container-change-password">
        <a href="{{ url_for('perfil.change_password') }}" class="fab-button fab-button-change-password" title="Cambiar Contraseña">
            <i class="fas fa-key"></i>
        </a>
    </div>
    {% endif %}
    {% if session.get('role') == 'Superuser' %}
    <div class="fab-container fab-container-upload-db">
        <button type="button" class="fab-button fab-button-upload-db" title="Subir y Reemplazar Base de Datos" onclick="triggerDbUpload()">
            <i class="fas fa-upload"></i>
        </button>
        <input type="file" id="dbUploadInput" accept=".db" style="display: none;">
    </div>
    {% endif %}

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const exportMyProfileJpgBtn = document.getElementById('exportMyProfileJpgBtn');
        const profileElement = document.getElementById('profile-details-card');
        const actionButtons = document.getElementById('personal-actions-section');

        if (exportMyProfileJpgBtn && profileElement && actionButtons) {
            exportMyProfileJpgBtn.addEventListener('click', function(e) {
                e.preventDefault();
                actionButtons.classList.add('hidden-for-capture');
                
                setTimeout(() => {
                    html2canvas(profileElement, {
                        scale: 2,
                        useCORS: true,
                        logging: false
                    }).then(function(canvas) {
                        actionButtons.classList.remove('hidden-for-capture');
                        const link = document.createElement('a');
                        link.download = 'mi_perfil_{{ user.username }}.jpg';
                        link.href = canvas.toDataURL('image/jpeg', 0.9);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }).catch(err => {
                        console.error('Error al generar la imagen JPG del perfil:', err);
                        actionButtons.classList.remove('hidden-for-capture');
                    });
                }, 50);
            });
        }
    });

    function performBackup() {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("perfil.backup_database") }}';
        document.body.appendChild(form);
        form.submit();
    }

    function triggerDbUpload() {
        const dbUploadInput = document.getElementById('dbUploadInput');
        dbUploadInput.click();
        dbUploadInput.onchange = function() {
            if (dbUploadInput.files.length > 0) {
                const file = dbUploadInput.files[0];
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("perfil.upload_database") }}';
                form.enctype = 'multipart/form-data';
                const fileInputHidden = document.createElement('input');
                fileInputHidden.type = 'file';
                fileInputHidden.name = 'db_file';
                fileInputHidden.style.display = 'none';
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInputHidden.files = dataTransfer.files;
                form.appendChild(fileInputHidden);
                document.body.appendChild(form);
                form.submit();
            }
        };
    }
</script>
{% endblock %}
