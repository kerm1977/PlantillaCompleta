{% extends 'base.html' %}

{% block title %}Editar Plan de Viaje Internacional{% endblock %}

{% block head_content %}
<style>
    .main-container {
        padding-top: 80px;
        padding-bottom: 80px; /* Aumentar espacio para el botón flotante */
    }
    .section-container {
        margin-bottom: 2.5rem;
        border: 1px solid #dee2e6;
        border-radius: .375rem;
        padding: 1.5rem;
        background-color: #fff;
    }
    .section-header {
        font-weight: bold;
        padding: 0.75rem 1.25rem;
        margin: -1.5rem -1.5rem 1.5rem -1.5rem;
        border-bottom: 1px solid #dee2e6;
        border-top-left-radius: .375rem;
        border-top-right-radius: .375rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .bg-warning {
        background-color: #ffc107 !important;
        color: #000;
    }
    .total-field {
        font-weight: bold;
        font-size: 1.2rem;
        text-align: right;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #dee2e6;
    }
    .dynamic-item {
        border: 1px dashed #ccc;
        padding: 1.5rem;
        padding-top: 2rem;
        margin-bottom: 1rem;
        background-color: #f8f9fa;
        position: relative;
        border-radius: .375rem;
    }
    .item-counter {
        position: absolute;
        top: -12px;
        left: -12px;
        background-color: #ffc107;
        color: black;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        border: 2px solid white;
    }
    .btn-remove-item {
        position: absolute;
        top: 10px;
        right: 10px;
    }
    .current-flyer {
        max-width: 150px;
        height: auto;
        border-radius: 5px;
        margin-top: 10px;
        border: 1px solid #dee2e6;
    }
    .details-toggle {
        margin-top: 1rem;
    }

    /* --- ESTILOS PARA BOTÓN FLOTANTE DE VOLVER --- */
    .fab-container-back {
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 1000;
    }
    .fab-button-back {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        transition: all 0.3s ease;
        background-color: #0d6efd;
        color: white;
        border: none;
        text-decoration: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .fab-button-back:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        background-color: #0b5ed7;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5 mb-5 main-container">
    <h1 class="mb-4 text-center">Editar Plan de Viaje: {{ viaje.nombre_viaje }}</h1>
    
    <form action="{{ url_for('intern.editar_intern', id=viaje.id) }}" method="POST" enctype="multipart/form-data">
        
        <!-- SECCIÓN DESTINO -->
        <div class="section-container">
            <div class="section-header bg-warning">DESTINO</div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="nombre_viaje" class="form-label">Nombre del Viaje</label>
                    <input type="text" class="form-control" id="nombre_viaje" name="nombre_viaje" value="{{ viaje.nombre_viaje }}" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="flyer_file" class="form-label">Cambiar Flyer (Imagen)</label>
                    <input type="file" class="form-control" id="flyer_file" name="flyer_file" accept="image/png, image/jpeg, image/gif">
                    {% if viaje.flyer %}
                        <div class="mt-2">
                            <p class="mb-1 small text-muted">Flyer actual:</p>
                            <img src="{{ url_for('static', filename=viaje.flyer) }}" alt="Flyer actual" class="current-flyer">
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label for="precio_paquete" class="form-label">Precio Paquete (por persona)</label>
                    <input type="number" step="0.01" class="form-control" id="precio_paquete" name="precio_paquete" value="{{ viaje.precio_paquete or 0 }}" oninput="updateGrandTotals()">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="capacidad" class="form-label">Capacidad</label>
                    <input type="number" class="form-control" id="capacidad" name="capacidad" value="{{ viaje.capacidad or 1 }}">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="tipo_moneda" class="form-label">Tipo de Moneda</label>
                    <select class="form-select" id="tipo_moneda" name="tipo_moneda">
                        <option value="CRC" {% if viaje.tipo_moneda == 'CRC' %}selected{% endif %}>Colones (CRC)</option>
                        <option value="USD" {% if viaje.tipo_moneda == 'USD' %}selected{% endif %}>Dólares (USD)</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3" id="tipo-cambio-wrapper">
                    <label for="tipo_cambio" class="form-label">Tipo de Cambio (a CRC)</label>
                    <input type="number" step="0.01" class="form-control" id="tipo_cambio" name="tipo_cambio" value="{{ viaje.tipo_cambio or 500 }}" oninput="updateGrandTotals()">
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="pais" class="form-label">País</label>
                    <select class="form-select" id="pais" name="pais" required>
                        <option value="" disabled>Seleccione un destino</option>
                        {% for p in paises %}
                        <option value="{{ p }}" {% if viaje.pais == p %}selected{% endif %}>{{ p }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- SECCIÓN PRE-ALERTAS -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>LLAMADO PRE-ALERTA</span>
                <button type="button" class="btn btn-sm btn-dark" onclick="addPreAlerta()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="prealertas-container">
                {% for prealerta in viaje.prealertas %}
                <div class="dynamic-item" id="prealerta-{{ loop.index }}">
                    <span class="item-counter">{{ loop.index }}</span>
                    <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('prealerta-{{ loop.index }}')"></button>
                    <input type="hidden" name="prealerta_id[]" value="{{ prealerta.id }}">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Banco</label>
                            <select name="prealerta_banco[]" class="form-select">
                                {% for banco in bancos %}
                                <option value="{{ banco }}" {% if prealerta.banco == banco %}selected{% endif %}>{{ banco }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Teléfono Entidad Financiera</label>
                            <input type="text" name="prealerta_telefono[]" class="form-control" value="{{ prealerta.telefono_entidad or '' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Fecha de la prealerta</label>
                            <input type="date" name="prealerta_fecha[]" class="form-control" value="{{ prealerta.fecha_prealerta.strftime('%Y-%m-%d') if prealerta.fecha_prealerta else '' }}">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Nombre del Asesor Bancario</label>
                            <input type="text" name="prealerta_asesor[]" class="form-control" value="{{ prealerta.asesor or '' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Hora de la Prealerta</label>
                            <input type="time" name="prealerta_hora[]" class="form-control" value="{{ prealerta.hora_prealerta.strftime('%H:%M') if prealerta.hora_prealerta else '' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Número de la prealerta</label>
                            <input type="text" name="prealerta_numero[]" class="form-control" value="{{ prealerta.numero_prealerta or '' }}">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fecha prealertada desde</label>
                            <input type="date" name="prealerta_desde[]" class="form-control" value="{{ prealerta.fecha_desde.strftime('%Y-%m-%d') if prealerta.fecha_desde else '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fecha prealertada hasta</label>
                            <input type="date" name="prealerta_hasta[]" class="form-control" value="{{ prealerta.fecha_hasta.strftime('%Y-%m-%d') if prealerta.fecha_hasta else '' }}">
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- SECCIÓN LUGARES A VISITAR -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>Atracciones</span>
                 <button type="button" class="btn btn-sm btn-dark" onclick="addLugar()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="lugares-container">
                {% for lugar in viaje.lugares %}
                <div class="dynamic-item" id="lugar-{{ loop.index }}">
                    <span class="item-counter">{{ loop.index }}</span>
                    <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('lugar-{{ loop.index }}', updateTotalAtracciones)"></button>
                    <input type="hidden" name="lugar_id[]" value="{{ lugar.id }}">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tipo de Lugar</label>
                            <select name="lugar_tipo[]" class="form-select">
                                <option {% if lugar.tipo_lugar == 'Volcán' %}selected{% endif %}>Volcán</option>
                                <option {% if lugar.tipo_lugar == 'Montaña' %}selected{% endif %}>Montaña</option>
                                <option {% if lugar.tipo_lugar == 'Playa' %}selected{% endif %}>Playa</option>
                                <option {% if lugar.tipo_lugar == 'Ciudad' %}selected{% endif %}>Ciudad</option>
                                <option {% if lugar.tipo_lugar == 'Parque Nacional' %}selected{% endif %}>Parque Nacional</option>
                                <option {% if lugar.tipo_lugar == 'Camino' %}selected{% endif %}>Camino</option>
                                <option {% if lugar.tipo_lugar == 'Otros' %}selected{% endif %}>Otros</option>
                            </select>
                        </div>
                        <div class="col-md-5 mb-3">
                            <label class="form-label">Nombre de Sitio</label>
                            <input type="text" name="lugar_nombre[]" class="form-control" value="{{ lugar.nombre_sitio or '' }}">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label price-label">Precio Entrada (por persona)</label>
                            <input type="number" step="0.01" name="lugar_precio[]" class="form-control price-atraccion" value="{{ lugar.precio_entrada or 0 }}" oninput="updateTotalAtracciones()">
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary details-toggle" data-bs-toggle="collapse" data-bs-target="#lugar-details-{{ loop.index }}">
                        Más Detalles <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="collapse mt-3" id="lugar-details-{{ loop.index }}">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Fecha de Reserva</label>
                                <input type="date" name="lugar_fecha_reserva[]" class="form-control" value="{{ lugar.fecha_reserva.strftime('%Y-%m-%d') if lugar.fecha_reserva else '' }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Teléfono del Lugar</label>
                                <input type="text" name="lugar_telefono_lugar[]" class="form-control" value="{{ lugar.telefono_lugar or '' }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Teléfono de Contacto</label>
                                <input type="text" name="lugar_telefono_contacto[]" class="form-control" value="{{ lugar.telefono_contacto or '' }}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">WhatsApp</label>
                                <input type="text" name="lugar_whatsapp_contacto[]" class="form-control" value="{{ lugar.whatsapp_contacto or '' }}">
                            </div>
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" name="lugar_email[]" class="form-control" value="{{ lugar.email or '' }}">
                            </div>
                        </div>
                         <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="lugar_guia_local_checkbox" value="lugar-{{loop.index}}-guia-local" id="guia-local-check-{{ loop.index }}" onchange="toggleGuiaLocal(this, 'guia-local-nombre-{{ loop.index }}')" {% if lugar.guia_local %}checked{% endif %}>
                                    <label class="form-check-label" for="guia-local-check-{{ loop.index }}">¿Incluye Guía Local?</label>
                                </div>
                            </div>
                            <div class="col-md-12 mb-3" id="guia-local-nombre-{{ loop.index }}" style="display: {% if lugar.guia_local %}block{% else %}none{% endif %};">
                                <label class="form-label">Nombre del Guía</label>
                                <input type="text" name="lugar_nombre_guia[]" class="form-control" value="{{ lugar.nombre_guia or '' }}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Enlaces de Interés</label>
                                <textarea name="lugar_enlaces[]" class="form-control" rows="2">{{ lugar.enlaces or '' }}</textarea>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Notas</label>
                                <textarea name="lugar_nota[]" class="form-control" rows="2">{{ lugar.nota or '' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="total-field">TOTAL DE ATRACCIONES POR PERSONA: <span class="currency-label">CRC</span> <span id="total-atracciones">0.00</span></div>
        </div>

        <!-- SECCIÓN TRANSPORTES LOCALES -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>Transportes Locales</span>
                <button type="button" class="btn btn-sm btn-dark" onclick="addTransporte()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="transportes-container">
                {% for transporte in viaje.transportes %}
                <div class="dynamic-item" id="transporte-{{ loop.index }}">
                    <span class="item-counter">{{ loop.index }}</span>
                    <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('transporte-{{ loop.index }}', updateTotalTransporte)"></button>
                    <input type="hidden" name="transporte_id[]" value="{{ transporte.id }}">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tipo</label>
                            <select name="transporte_tipo[]" class="form-select">
                                <option {% if transporte.tipo_transporte == 'Buseta' %}selected{% endif %}>Buseta</option>
                                <option {% if transporte.tipo_transporte == 'Bus' %}selected{% endif %}>Bus</option>
                                <option {% if transporte.tipo_transporte == 'Taxi' %}selected{% endif %}>Taxi</option>
                                <option {% if transporte.tipo_transporte == 'Uber' %}selected{% endif %}>Uber</option>
                                <option {% if transporte.tipo_transporte == 'Auto' %}selected{% endif %}>Auto</option>
                                <option {% if transporte.tipo_transporte == 'Lancha' %}selected{% endif %}>Lancha</option>
                                <option {% if transporte.tipo_transporte == 'Avión' %}selected{% endif %}>Avión</option>
                            </select>
                        </div>
                        <div class="col-md-5 mb-3">
                            <label class="form-label">Nombre del Transporte</label>
                            <input type="text" name="transporte_nombre[]" class="form-control" value="{{ transporte.nombre_transporte or '' }}">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label price-label">Precio Transporte (por persona)</label>
                            <input type="number" step="0.01" name="transporte_precio[]" class="form-control price-transporte" value="{{ transporte.precio or 0 }}" oninput="updateTotalTransporte()">
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary details-toggle" data-bs-toggle="collapse" data-bs-target="#transporte-details-{{ loop.index }}">
                        Más Detalles <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="collapse mt-3" id="transporte-details-{{ loop.index }}">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nombre del Conductor</label>
                                <input type="text" name="transporte_conductor[]" class="form-control" value="{{ transporte.conductor or '' }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha de Contratación</label>
                                <input type="date" name="transporte_fecha_contratacion[]" class="form-control" value="{{ transporte.fecha_contratacion.strftime('%Y-%m-%d') if transporte.fecha_contratacion else '' }}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Teléfono del Lugar</label>
                                <input type="text" name="transporte_telefono_lugar[]" class="form-control" value="{{ transporte.telefono_lugar or '' }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Teléfono del Contacto</label>
                                <input type="text" name="transporte_telefono_contacto[]" class="form-control" value="{{ transporte.telefono_contacto or '' }}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">WhatsApp del Contacto</label>
                                <input type="text" name="transporte_whatsapp[]" class="form-control" value="{{ transporte.whatsapp or '' }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" name="transporte_email[]" class="form-control" value="{{ transporte.email or '' }}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Enlaces</label>
                                <textarea name="transporte_enlaces[]" class="form-control" rows="2">{{ transporte.enlaces or '' }}</textarea>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Nota</label>
                                <textarea name="transporte_nota[]" class="form-control" rows="2">{{ transporte.nota or '' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="total-field">TOTAL DE TRANSPORTE POR PERSONA: <span class="currency-label">CRC</span> <span id="total-transporte">0.00</span></div>
        </div>

        <!-- SECCIÓN GUÍAS -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>Guías</span>
                <button type="button" class="btn btn-sm btn-dark" onclick="addGuia()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="guias-container">
                {% for guia in viaje.guias %}
                <div class="dynamic-item" id="guia-{{ loop.index }}">
                    <span class="item-counter">{{ loop.index }}</span>
                    <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('guia-{{ loop.index }}', updateTotalGuias)"></button>
                    <input type="hidden" name="guia_id[]" value="{{ guia.id }}">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre</label>
                            <input type="text" name="guia_nombre[]" class="form-control" value="{{ guia.nombre or '' }}">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label price-label">Precio Guía PP</label>
                            <input type="number" step="0.01" name="guia_precio_pp[]" class="form-control price-guia-pp" value="{{ guia.precio_guia_pp or 0 }}" oninput="updateTotalGuias()">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label price-label">Precio Acarreo</label>
                            <input type="number" step="0.01" name="guia_acarreo[]" class="form-control price-guia-acarreo" value="{{ guia.precio_acarreo or 0 }}" oninput="updateTotalGuias()">
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary details-toggle" data-bs-toggle="collapse" data-bs-target="#guia-details-{{ loop.index }}">
                        Más Detalles <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="collapse mt-3" id="guia-details-{{ loop.index }}">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Operador</label>
                                <input type="text" name="guia_operador[]" class="form-control" value="{{ guia.operador or '' }}">
                            </div>
                             <div class="col-md-4 mb-3">
                                <label class="form-label">Teléfono</label>
                                <input type="text" name="guia_telefono[]" class="form-control" value="{{ guia.telefono or '' }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">WhatsApp</label>
                                <input type="text" name="guia_whatsapp[]" class="form-control" value="{{ guia.whatsapp or '' }}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" name="guia_email[]" class="form-control" value="{{ guia.email or '' }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">CPL</label>
                                <input type="text" name="guia_cpl[]" class="form-control" value="{{ guia.cpl or '' }}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Fecha Disponible</label>
                                <input type="date" name="guia_fecha_disponible[]" class="form-control" value="{{ guia.fecha_disponible.strftime('%Y-%m-%d') if guia.fecha_disponible else '' }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Fecha Reserva</label>
                                <input type="date" name="guia_fecha_reserva[]" class="form-control" value="{{ guia.fecha_reserva.strftime('%Y-%m-%d') if guia.fecha_reserva else '' }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Reserva</label>
                                <input type="text" name="guia_reserva[]" class="form-control" value="{{ guia.reserva or '' }}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Enlaces</label>
                                <textarea name="guia_enlaces[]" class="form-control" rows="2">{{ guia.enlaces or '' }}</textarea>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Nota</label>
                                <textarea name="guia_nota[]" class="form-control" rows="2">{{ guia.nota or '' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="total-field">TOTAL DE GUÍAS POR PERSONA: <span class="currency-label">CRC</span> <span id="total-guias">0.00</span></div>
        </div>
        
        <!-- SECCIÓN ESTADÍAS -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>Estadías</span>
                <button type="button" class="btn btn-sm btn-dark" onclick="addEstadia()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="estadias-container">
                {% for estadia in viaje.estadias %}
                <div class="dynamic-item" id="estadia-{{ loop.index }}">
                    <span class="item-counter">{{ loop.index }}</span>
                    <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('estadia-{{ loop.index }}', updateTotalEstadia)"></button>
                    <input type="hidden" name="estadia_id[]" value="{{ estadia.id }}">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Nombre</label>
                            <input type="text" name="estadia_nombre[]" class="form-control" value="{{ estadia.nombre or '' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tipo de Estadía</label>
                            <select name="estadia_tipo[]" class="form-select">
                                <option {% if estadia.tipo_estadia == 'Hotel' %}selected{% endif %}>Hotel</option>
                                <option {% if estadia.tipo_estadia == 'Hostel' %}selected{% endif %}>Hostel</option>
                                <option {% if estadia.tipo_estadia == 'Airbnb' %}selected{% endif %}>Airbnb</option>
                                <option {% if estadia.tipo_estadia == 'Casa/Apto' %}selected{% endif %}>Casa/Apto</option>
                                <option {% if estadia.tipo_estadia == 'Otro' %}selected{% endif %}>Otro</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label price-label">Precio PP Noche</label>
                            <input type="number" step="0.01" name="estadia_precio_pp[]" class="form-control price-estadia-pp" value="{{ estadia.precio_pp or 0 }}" oninput="updateTotalEstadia()">
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label"># Noches</label>
                            <input type="number" name="estadia_noches[]" class="form-control noches-estadia" value="{{ estadia.cantidad_noches or 1 }}" oninput="updateTotalEstadia()">
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary details-toggle" data-bs-toggle="collapse" data-bs-target="#estadia-details-{{ loop.index }}">
                        Más Detalles <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="collapse mt-3" id="estadia-details-{{ loop.index }}">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha Check-in</label>
                                <input type="date" name="estadia_checkin[]" class="form-control" value="{{ estadia.fecha_checkin.strftime('%Y-%m-%d') if estadia.fecha_checkin else '' }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha Check-out</label>
                                <input type="date" name="estadia_checkout[]" class="form-control" value="{{ estadia.fecha_checkout.strftime('%Y-%m-%d') if estadia.fecha_checkout else '' }}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Teléfono del Lugar</label>
                                <input type="text" name="estadia_telefono_lugar[]" class="form-control" value="{{ estadia.telefono_lugar or '' }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Teléfono de Contacto</label>
                                <input type="text" name="estadia_telefono_contacto[]" class="form-control" value="{{ estadia.telefono_contacto or '' }}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">WhatsApp</label>
                                <input type="text" name="estadia_whatsapp[]" class="form-control" value="{{ estadia.whatsapp or '' }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" name="estadia_email[]" class="form-control" value="{{ estadia.email or '' }}">
                            </div>
                        </div>
                        <div class="row">
                             <div class="col-md-12 mb-3">
                                <label class="form-label">Número de Reserva</label>
                                <input type="text" name="estadia_reserva[]" class="form-control" value="{{ estadia.numero_reserva or '' }}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Enlaces</label>
                                <textarea name="estadia_enlaces[]" class="form-control" rows="2">{{ estadia.enlaces or '' }}</textarea>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Nota</label>
                                <textarea name="estadia_nota[]" class="form-control" rows="2">{{ estadia.nota or '' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="total-field">TOTAL DE ESTADÍA POR PERSONA: <span class="currency-label">CRC</span> <span id="total-estadia">0.00</span></div>
        </div>

        <!-- SECCIÓN AEROLÍNEA / TRANSPORTE PRINCIPAL -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>Aerolínea / Transporte Principal</span>
                <button type="button" class="btn btn-sm btn-dark" onclick="addAerolinea()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="aerolineas-container">
                {% for aerolinea in viaje.aerolineas %}
                <div class="dynamic-item" id="aerolinea-{{ loop.index }}">
                    <span class="item-counter">{{ loop.index }}</span>
                    <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('aerolinea-{{ loop.index }}', updateTotalAerolinea)"></button>
                    <input type="hidden" name="aerolinea_id[]" value="{{ aerolinea.id }}">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tipo de Transporte</label>
                            <select name="aerolinea_tipo_transporte[]" class="form-select tipo-transporte-aerolinea" onchange="toggleAerolineaFields(this)">
                                <option {% if aerolinea.tipo_transporte == 'Avión' %}selected{% endif %}>Avión</option>
                                <option {% if aerolinea.tipo_transporte == 'Bus' %}selected{% endif %}>Bus</option>
                                <option {% if aerolinea.tipo_transporte == 'Buseta' %}selected{% endif %}>Buseta</option>
                                <option {% if aerolinea.tipo_transporte == 'Auto' %}selected{% endif %}>Auto</option>
                                <option {% if aerolinea.tipo_transporte == 'Moto' %}selected{% endif %}>Moto</option>
                                <option {% if aerolinea.tipo_transporte == 'Barco' %}selected{% endif %}>Barco</option>
                            </select>
                        </div>
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Aerolínea / Compañía</label>
                            <input type="text" name="aerolinea_nombre[]" class="form-control" value="{{ aerolinea.nombre_aerolinea or '' }}" placeholder="Nombre de la compañía">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3 aerolinea-field-group">
                            <label class="form-label price-label">Precio Asientos</label>
                            <input type="number" step="0.01" name="aerolinea_precio_asientos[]" class="form-control price-aerolinea" value="{{ aerolinea.precio_asientos or 0 }}" oninput="updateTotalAerolinea()">
                        </div>
                        <div class="col-md-3 mb-3 aerolinea-field-group">
                            <label class="form-label price-label">Precio Maletas Doc.</label>
                            <input type="number" step="0.01" name="aerolinea_precio_maletas[]" class="form-control price-aerolinea" value="{{ aerolinea.precio_maletas_documentado or 0 }}" oninput="updateTotalAerolinea()">
                        </div>
                        <div class="col-md-3 mb-3 aerolinea-field-group">
                            <label class="form-label price-label">Equipaje de Mano</label>
                            <input type="number" step="0.01" name="aerolinea_equipaje_mano[]" class="form-control price-aerolinea" value="{{ aerolinea.equipaje_mano or 0 }}" oninput="updateTotalAerolinea()">
                        </div>
                        <div class="col-md-3 mb-3 aerolinea-field-group">
                            <label class="form-label price-label">Precio Impuestos</label>
                            <input type="number" step="0.01" name="aerolinea_impuestos[]" class="form-control price-aerolinea" value="{{ aerolinea.precio_impuestos or 0 }}" oninput="updateTotalAerolinea()">
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="total-field">TOTAL DE TRANSPORTE PRINCIPAL POR PERSONA: <span class="currency-label">CRC</span> <span id="total-aerolinea">0.00</span></div>
        </div>

        <!-- SECCIÓN DE TOTALES GENERALES -->
        <div class="section-container text-center">
            <div class="section-header bg-warning justify-content-center">TOTALES GENERALES POR PERSONA</div>
            <div class="row">
                <div class="col-md-6" id="total-crc-wrapper">
                    <p class="total-field" style="border-top: none; text-align: center;">TOTAL INDIVIDUAL (CRC): <span class="badge bg-success fs-5" id="total-crc">0.00</span></p>
                </div>
                <div class="col-md-6" id="total-usd-wrapper">
                    <p class="total-field" style="border-top: none; text-align: center;">TOTAL INDIVIDUAL (USD): <span class="badge bg-primary fs-5" id="total-usd">0.00</span></p>
                </div>
            </div>
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-warning btn-lg">Guardar Cambios</button>
        </div>
    </form>
    
    <!-- Botón Flotante para Volver -->
    <div class="fab-container-back">
        <a href="{{ url_for('intern.detalle_intern', id=viaje.id) }}" class="fab-button-back" title="Volver a Detalles">
            <i class="fas fa-arrow-left"></i>
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // --- Contadores inicializados para evitar colisiones de ID ---
    let preAlertaCount = {{ viaje.prealertas|length }};
    let lugarCount = {{ viaje.lugares|length }};
    let transporteCount = {{ viaje.transportes|length }};
    let guiaCount = {{ viaje.guias|length }};
    let estadiaCount = {{ viaje.estadias|length }};
    let aerolineaCount = {{ viaje.aerolineas|length }};

    // --- LÓGICA DE MONEDA ---
    const tipoMonedaSelect = document.getElementById('tipo_moneda');
    const tipoCambioWrapper = document.getElementById('tipo-cambio-wrapper');
    const totalCRCWrapper = document.getElementById('total-crc-wrapper');
    const totalUSDWrapper = document.getElementById('total-usd-wrapper');

    function handleCurrencyChange() {
        const selectedCurrency = tipoMonedaSelect.value;
        const priceLabels = document.querySelectorAll('.price-label');
        const currencyLabels = document.querySelectorAll('.currency-label');
        
        if (selectedCurrency === 'USD') {
            tipoCambioWrapper.style.display = 'none';
            totalCRCWrapper.style.display = 'none';
            totalUSDWrapper.classList.remove('col-md-6');
            totalUSDWrapper.classList.add('col-md-12');
        } else {
            tipoCambioWrapper.style.display = 'block';
            totalCRCWrapper.style.display = 'block';
            totalUSDWrapper.classList.add('col-md-6');
            totalUSDWrapper.classList.remove('col-md-12');
        }

        priceLabels.forEach(label => {
            const text = label.innerText.split('(')[0];
            label.innerText = `${text.trim()} (${selectedCurrency})`;
        });
        currencyLabels.forEach(label => label.textContent = selectedCurrency);
        
        updateGrandTotals();
    }

    tipoMonedaSelect.addEventListener('change', handleCurrencyChange);
    
    // --- INICIALIZAR TOTALES Y MONEDA AL CARGAR LA PÁGINA ---
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.tipo-transporte-aerolinea').forEach(select => toggleAerolineaFields(select));
        recalculateAllTotals();
        handleCurrencyChange();
    });

    // --- FUNCIONES PARA AÑADIR ELEMENTOS ---
    function addPreAlerta() {
        preAlertaCount++;
        const container = document.getElementById('prealertas-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `prealerta-${preAlertaCount}`;
        newItem.innerHTML = `
            <span class="item-counter">${preAlertaCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('prealerta-${preAlertaCount}')"></button>
            <input type="hidden" name="prealerta_id[]" value="">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Banco</label>
                    <select name="prealerta_banco[]" class="form-select">
                        <option selected disabled>Seleccione un banco</option>
                        {% for banco in bancos %}
                        <option value="{{ banco }}">{{ banco }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Teléfono Entidad Financiera</label>
                    <input type="text" name="prealerta_telefono[]" class="form-control">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Fecha de la prealerta</label>
                    <input type="date" name="prealerta_fecha[]" class="form-control">
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Nombre del Asesor Bancario</label>
                    <input type="text" name="prealerta_asesor[]" class="form-control">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Hora de la Prealerta</label>
                    <input type="time" name="prealerta_hora[]" class="form-control">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Número de la prealerta</label>
                    <input type="text" name="prealerta_numero[]" class="form-control">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Fecha prealertada desde</label>
                    <input type="date" name="prealerta_desde[]" class="form-control">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Fecha prealertada hasta</label>
                    <input type="date" name="prealerta_hasta[]" class="form-control">
                </div>
            </div>
        `;
        container.appendChild(newItem);
    }

    function addLugar() {
        lugarCount++;
        const container = document.getElementById('lugares-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `lugar-${lugarCount}`;
        const currency = tipoMonedaSelect.value;
        newItem.innerHTML = `
            <span class="item-counter">${lugarCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('lugar-${lugarCount}', updateTotalAtracciones)"></button>
            <input type="hidden" name="lugar_id[]" value="">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Tipo de Lugar</label>
                    <select name="lugar_tipo[]" class="form-select">
                        <option>Volcán</option><option>Montaña</option><option>Playa</option><option>Ciudad</option><option>Parque Nacional</option><option>Camino</option><option>Otros</option>
                    </select>
                </div>
                <div class="col-md-5 mb-3">
                    <label class="form-label">Nombre de Sitio</label>
                    <input type="text" name="lugar_nombre[]" class="form-control">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label price-label">Precio Entrada (por persona) (${currency})</label>
                    <input type="number" step="0.01" name="lugar_precio[]" class="form-control price-atraccion" value="0" oninput="updateTotalAtracciones()">
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary details-toggle" data-bs-toggle="collapse" data-bs-target="#lugar-details-${lugarCount}">
                Más Detalles <i class="fas fa-chevron-down"></i>
            </button>
            <div class="collapse mt-3" id="lugar-details-${lugarCount}">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Fecha de Reserva</label>
                        <input type="date" name="lugar_fecha_reserva[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Teléfono del Lugar</label>
                        <input type="text" name="lugar_telefono_lugar[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Teléfono de Contacto</label>
                        <input type="text" name="lugar_telefono_contacto[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">WhatsApp</label>
                        <input type="text" name="lugar_whatsapp_contacto[]" class="form-control">
                    </div>
                    <div class="col-md-8 mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="lugar_email[]" class="form-control">
                    </div>
                </div>
                 <div class="row">
                    <div class="col-md-12 mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="lugar_guia_local_checkbox" value="lugar-${lugarCount}-guia-local" id="guia-local-check-${lugarCount}" onchange="toggleGuiaLocal(this, 'guia-local-nombre-${lugarCount}')">
                            <label class="form-check-label" for="guia-local-check-${lugarCount}">¿Incluye Guía Local?</label>
                        </div>
                    </div>
                    <div class="col-md-12 mb-3" id="guia-local-nombre-${lugarCount}" style="display: none;">
                        <label class="form-label">Nombre del Guía</label>
                        <input type="text" name="lugar_nombre_guia[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Enlaces de Interés</label>
                        <textarea name="lugar_enlaces[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Notas</label>
                        <textarea name="lugar_nota[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(newItem);
    }
    
    function addTransporte() {
        transporteCount++;
        const container = document.getElementById('transportes-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `transporte-${transporteCount}`;
        const currency = tipoMonedaSelect.value;
        newItem.innerHTML = `
            <span class="item-counter">${transporteCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('transporte-${transporteCount}', updateTotalTransporte)"></button>
            <input type="hidden" name="transporte_id[]" value="">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Tipo</label>
                    <select name="transporte_tipo[]" class="form-select">
                        <option>Buseta</option><option>Bus</option><option>Taxi</option><option>Uber</option><option>Auto</option><option>Lancha</option><option>Avión</option>
                    </select>
                </div>
                <div class="col-md-5 mb-3">
                    <label class="form-label">Nombre del Transporte</label>
                    <input type="text" name="transporte_nombre[]" class="form-control">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label price-label">Precio Transporte (por persona) (${currency})</label>
                    <input type="number" step="0.01" name="transporte_precio[]" class="form-control price-transporte" value="0" oninput="updateTotalTransporte()">
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary details-toggle" data-bs-toggle="collapse" data-bs-target="#transporte-details-${transporteCount}">
                Más Detalles <i class="fas fa-chevron-down"></i>
            </button>
            <div class="collapse mt-3" id="transporte-details-${transporteCount}">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Nombre del Conductor</label>
                        <input type="text" name="transporte_conductor[]" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Fecha de Contratación</label>
                        <input type="date" name="transporte_fecha_contratacion[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Teléfono del Lugar</label>
                        <input type="text" name="transporte_telefono_lugar[]" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Teléfono del Contacto</label>
                        <input type="text" name="transporte_telefono_contacto[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">WhatsApp del Contacto</label>
                        <input type="text" name="transporte_whatsapp[]" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="transporte_email[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Enlaces</label>
                        <textarea name="transporte_enlaces[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Nota</label>
                        <textarea name="transporte_nota[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(newItem);
    }

    function addGuia() {
        guiaCount++;
        const container = document.getElementById('guias-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `guia-${guiaCount}`;
        const currency = tipoMonedaSelect.value;
        newItem.innerHTML = `
            <span class="item-counter">${guiaCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('guia-${guiaCount}', updateTotalGuias)"></button>
            <input type="hidden" name="guia_id[]" value="">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Nombre</label>
                    <input type="text" name="guia_nombre[]" class="form-control">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label price-label">Precio Guía PP (${currency})</label>
                    <input type="number" step="0.01" name="guia_precio_pp[]" class="form-control price-guia-pp" value="0" oninput="updateTotalGuias()">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label price-label">Precio Acarreo (${currency})</label>
                    <input type="number" step="0.01" name="guia_acarreo[]" class="form-control price-guia-acarreo" value="0" oninput="updateTotalGuias()">
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary details-toggle" data-bs-toggle="collapse" data-bs-target="#guia-details-${guiaCount}">
                Más Detalles <i class="fas fa-chevron-down"></i>
            </button>
            <div class="collapse mt-3" id="guia-details-${guiaCount}">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Operador</label>
                        <input type="text" name="guia_operador[]" class="form-control">
                    </div>
                     <div class="col-md-4 mb-3">
                        <label class="form-label">Teléfono</label>
                        <input type="text" name="guia_telefono[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">WhatsApp</label>
                        <input type="text" name="guia_whatsapp[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="guia_email[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">CPL</label>
                        <input type="text" name="guia_cpl[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Fecha Disponible</label>
                        <input type="date" name="guia_fecha_disponible[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Fecha Reserva</label>
                        <input type="date" name="guia_fecha_reserva[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Reserva</label>
                        <input type="text" name="guia_reserva[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Enlaces</label>
                        <textarea name="guia_enlaces[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Nota</label>
                        <textarea name="guia_nota[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(newItem);
    }

    function addEstadia() {
        estadiaCount++;
        const container = document.getElementById('estadias-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `estadia-${estadiaCount}`;
        const currency = tipoMonedaSelect.value;
        newItem.innerHTML = `
            <span class="item-counter">${estadiaCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('estadia-${estadiaCount}', updateTotalEstadia)"></button>
            <input type="hidden" name="estadia_id[]" value="">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Nombre</label>
                    <input type="text" name="estadia_nombre[]" class="form-control">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Tipo de Estadía</label>
                    <select name="estadia_tipo[]" class="form-select">
                        <option>Hotel</option><option>Hostel</option><option>Airbnb</option><option>Casa/Apto</option><option>Otro</option>
                    </select>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label price-label">Precio PP Noche (${currency})</label>
                    <input type="number" step="0.01" name="estadia_precio_pp[]" class="form-control price-estadia-pp" value="0" oninput="updateTotalEstadia()">
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label"># Noches</label>
                    <input type="number" name="estadia_noches[]" class="form-control noches-estadia" value="1" oninput="updateTotalEstadia()">
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary details-toggle" data-bs-toggle="collapse" data-bs-target="#estadia-details-${estadiaCount}">
                Más Detalles <i class="fas fa-chevron-down"></i>
            </button>
            <div class="collapse mt-3" id="estadia-details-${estadiaCount}">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Fecha Check-in</label>
                        <input type="date" name="estadia_checkin[]" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Fecha Check-out</label>
                        <input type="date" name="estadia_checkout[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Teléfono del Lugar</label>
                        <input type="text" name="estadia_telefono_lugar[]" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Teléfono de Contacto</label>
                        <input type="text" name="estadia_telefono_contacto[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">WhatsApp</label>
                        <input type="text" name="estadia_whatsapp[]" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="estadia_email[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                     <div class="col-md-12 mb-3">
                        <label class="form-label">Número de Reserva</label>
                        <input type="text" name="estadia_reserva[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Enlaces</label>
                        <textarea name="estadia_enlaces[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Nota</label>
                        <textarea name="estadia_nota[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(newItem);
    }

    function addAerolinea() {
        aerolineaCount++;
        const container = document.getElementById('aerolineas-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `aerolinea-${aerolineaCount}`;
        const currency = tipoMonedaSelect.value;
        newItem.innerHTML = `
            <span class="item-counter">${aerolineaCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('aerolinea-${aerolineaCount}', updateTotalAerolinea)"></button>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Tipo de Transporte</label>
                    <select name="aerolinea_tipo_transporte[]" class="form-select tipo-transporte-aerolinea" onchange="toggleAerolineaFields(this)">
                        <option>Avión</option><option>Bus</option><option>Buseta</option><option>Auto</option><option>Moto</option><option>Barco</option>
                    </select>
                </div>
                <div class="col-md-8 mb-3">
                    <label class="form-label">Aerolínea / Compañía</label>
                    <input type="text" name="aerolinea_nombre[]" class="form-control" placeholder="Nombre de la compañía">
                </div>
            </div>
            <div class="row">
                <div class="col-md-3 mb-3 aerolinea-field-group">
                    <label class="form-label price-label">Precio Asientos (pp)</label>
                    <input type="number" step="0.01" name="aerolinea_precio_asientos[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()">
                </div>
                <div class="col-md-3 mb-3 aerolinea-field-group">
                    <label class="form-label price-label">Precio Maletas Doc. (pp)</label>
                    <input type="number" step="0.01" name="aerolinea_precio_maletas[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()">
                </div>
                <div class="col-md-3 mb-3 aerolinea-field-group">
                    <label class="form-label price-label">Equipaje de Mano (pp)</label>
                    <input type="number" step="0.01" name="aerolinea_equipaje_mano[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()">
                </div>
                <div class="col-md-3 mb-3 aerolinea-field-group">
                    <label class="form-label price-label">Precio Impuestos (pp)</label>
                    <input type="number" step="0.01" name="aerolinea_impuestos[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()">
                </div>
            </div>
        `;
        container.appendChild(newItem);
        toggleAerolineaFields(newItem.querySelector('.tipo-transporte-aerolinea'));
    }

    function removeItem(id, callback) {
        const item = document.getElementById(id);
        if (item) {
            item.remove();
            if (callback) {
                callback();
            }
        }
    }

    function toggleGuiaLocal(checkbox, divId) {
        const div = document.getElementById(divId);
        if (checkbox.checked) {
            div.style.display = 'block';
        } else {
            div.style.display = 'none';
        }
    }
    
    function toggleAerolineaFields(selectElement) {
        const parentItem = selectElement.closest('.dynamic-item');
        const fieldGroups = parentItem.querySelectorAll('.aerolinea-field-group');
        const firstFieldGroup = fieldGroups[0];
        const firstLabel = firstFieldGroup.querySelector('.price-label');
        const currency = tipoMonedaSelect.value;

        if (selectElement.value === 'Avión') {
            fieldGroups.forEach((group, index) => {
                group.style.display = 'block';
                const label = group.querySelector('.price-label');
                if(index === 0) label.textContent = `Precio Asientos (pp) (${currency})`;
                if(index === 1) label.textContent = `Precio Maletas Doc. (pp) (${currency})`;
                if(index === 2) label.textContent = `Equipaje de Mano (pp) (${currency})`;
                if(index === 3) label.textContent = `Precio Impuestos (pp) (${currency})`;
            });
        } else {
            firstLabel.textContent = `Precio por Persona (${currency})`;
            fieldGroups.forEach((group, index) => {
                if (index > 0) {
                    group.style.display = 'none';
                    group.querySelector('input').value = 0;
                } else {
                    group.style.display = 'block';
                }
            });
        }
        updateTotalAerolinea();
    }

    // --- FUNCIONES PARA ACTUALIZAR TOTALES ---
    function recalculateAllTotals() {
        updateTotalAtracciones();
        updateTotalTransporte();
        updateTotalGuias();
        updateTotalEstadia();
        updateTotalAerolinea();
    }

    function updateTotalAtracciones() {
        let total = 0;
        document.querySelectorAll('.price-atraccion').forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        document.getElementById('total-atracciones').textContent = total.toFixed(2);
        updateGrandTotals();
    }
    
    function updateTotalTransporte() {
        let total = 0;
        document.querySelectorAll('.price-transporte').forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        document.getElementById('total-transporte').textContent = total.toFixed(2);
        updateGrandTotals();
    }

    function updateTotalGuias() {
        let total = 0;
        document.querySelectorAll('.dynamic-item[id^="guia-"]').forEach(item => {
            const precioPP = parseFloat(item.querySelector('.price-guia-pp').value) || 0;
            const acarreo = parseFloat(item.querySelector('.price-guia-acarreo').value) || 0;
            total += precioPP + acarreo;
        });
        document.getElementById('total-guias').textContent = total.toFixed(2);
        updateGrandTotals();
    }

    function updateTotalEstadia() {
        let total = 0;
        document.querySelectorAll('.dynamic-item[id^="estadia-"]').forEach(item => {
            const precioPP = parseFloat(item.querySelector('.price-estadia-pp').value) || 0;
            const noches = parseInt(item.querySelector('.noches-estadia').value) || 1;
            total += precioPP * noches;
        });
        document.getElementById('total-estadia').textContent = total.toFixed(2);
        updateGrandTotals();
    }

    function updateTotalAerolinea() {
        let total = 0;
        document.querySelectorAll('.dynamic-item[id^="aerolinea-"]').forEach(item => {
            const tipo = item.querySelector('.tipo-transporte-aerolinea').value;
            let itemTotal = 0;
            const inputs = item.querySelectorAll('.price-aerolinea');

            if (tipo === 'Avión') {
                inputs.forEach(input => {
                    itemTotal += parseFloat(input.value) || 0;
                });
            } else {
                const precioPorPersona = parseFloat(inputs[0].value) || 0;
                itemTotal = precioPorPersona;
            }
            total += itemTotal;
        });
        document.getElementById('total-aerolinea').textContent = total.toFixed(2);
        updateGrandTotals();
    }
    
    function updateGrandTotals() {
        const precioPaquete = parseFloat(document.getElementById('precio_paquete').value) || 0;
        const totalAtracciones = parseFloat(document.getElementById('total-atracciones').textContent) || 0;
        const totalTransporte = parseFloat(document.getElementById('total-transporte').textContent) || 0;
        const totalGuias = parseFloat(document.getElementById('total-guias').textContent) || 0;
        const totalEstadia = parseFloat(document.getElementById('total-estadia').textContent) || 0;
        const totalAerolinea = parseFloat(document.getElementById('total-aerolinea').textContent) || 0;
        
        const total = precioPaquete + totalAtracciones + totalTransporte + totalGuias + totalEstadia + totalAerolinea;
        const tipoCambio = parseFloat(document.getElementById('tipo_cambio').value) || 1;
        
        if (tipoMonedaSelect.value === 'USD') {
            document.getElementById('total-usd').textContent = total.toFixed(2);
        } else {
            const totalUSD = total / tipoCambio;
            document.getElementById('total-crc').textContent = total.toFixed(2);
            document.getElementById('total-usd').textContent = totalUSD.toFixed(2);
        }
    }
</script>
{% endblock %}
