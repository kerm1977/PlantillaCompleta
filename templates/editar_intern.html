{% extends 'base.html' %}

{% block title %}Editar Plan de Viaje Internacional{% endblock %}

{% block head_content %}
<style>
    .main-container {
        padding-top: 80px; /* Ajusta este valor según la altura de tu navbar */
        padding-bottom: 40px;
    }
    .card {
        box-shadow: none !important;
        border: 1px solid #dee2e6;
        margin-bottom: 1.5rem;
    }
    .card-header {
        background-color: #e9ecef;
        font-weight: bold;
    }
    .btn-warning {
        color: #000;
    }
    .section-separator {
        border-top: 2px solid #ffc107;
        margin-top: 2rem;
        margin-bottom: 2rem;
    }
    .total-field {
        font-weight: bold;
        font-size: 1.2rem;
    }
    .dynamic-item {
        border: 1px dashed #ccc;
        padding: 1.5rem;
        padding-top: 2rem;
        margin-bottom: 1rem;
        background-color: #fff;
        position: relative;
        border-radius: .375rem;
    }
    .item-counter {
        position: absolute;
        top: -12px;
        left: -12px;
        background-color: #ffc107;
        color: black;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        border: 2px solid white;
    }
    .btn-remove-item {
        position: absolute;
        top: 10px;
        right: 10px;
    }
    .current-flyer {
        max-width: 150px;
        height: auto;
        border-radius: 5px;
        margin-top: 10px;
        border: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5 mb-5 main-container">
    <h1 class="mb-4 text-center">Editar Plan de Viaje: {{ viaje.nombre_viaje }}</h1>
    
    <form action="{{ url_for('intern.editar_intern', id=viaje.id) }}" method="POST" enctype="multipart/form-data">
        
        <!-- SECCIÓN DESTINO -->
        <div class="card">
            <div class="card-header">
                DESTINO
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="nombre_viaje" class="form-label">Nombre del Viaje</label>
                        <input type="text" class="form-control" id="nombre_viaje" name="nombre_viaje" value="{{ viaje.nombre_viaje }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="flyer_file" class="form-label">Cambiar Flyer (Imagen)</label>
                        <input type="file" class="form-control" id="flyer_file" name="flyer_file" accept="image/png, image/jpeg, image/gif">
                        {% if viaje.flyer %}
                            <div class="mt-2">
                                <p class="mb-1 small text-muted">Flyer actual:</p>
                                <img src="{{ url_for('static', filename=viaje.flyer) }}" alt="Flyer actual" class="current-flyer">
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="precio_paquete" class="form-label">Precio del Paquete</label>
                        <input type="number" step="0.01" class="form-control" id="precio_paquete" name="precio_paquete" value="{{ viaje.precio_paquete or 0 }}">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="capacidad" class="form-label">Capacidad</label>
                        <input type="number" class="form-control" id="capacidad" name="capacidad" value="{{ viaje.capacidad or 0 }}">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="tipo_moneda" class="form-label">Tipo de Moneda</label>
                        <select class="form-select" id="tipo_moneda" name="tipo_moneda">
                            <option value="CRC" {% if viaje.tipo_moneda == 'CRC' %}selected{% endif %}>Colones (CRC)</option>
                            <option value="USD" {% if viaje.tipo_moneda == 'USD' %}selected{% endif %}>Dólares (USD)</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="tipo_cambio" class="form-label">Tipo de Cambio (a CRC)</label>
                        <input type="number" step="0.01" class="form-control" id="tipo_cambio" name="tipo_cambio" value="{{ viaje.tipo_cambio or 500 }}">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="pais" class="form-label">País</label>
                        <select class="form-select" id="pais" name="pais" required>
                            <option value="" disabled>Seleccione un destino</option>
                            {% for p in paises %}
                            <option value="{{ p }}" {% if viaje.pais == p %}selected{% endif %}>{{ p }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- SEPARADOR ADMINISTRACIÓN -->
        <div class="section-separator"></div>
        <h2 class="text-center mb-3">ADMINISTRACIÓN DE VIAJE</h2>

        <!-- SECCIÓN PRE-ALERTAS -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                LLAMADO PRE-ALERTA
                <button type="button" class="btn btn-sm btn-success" onclick="addPreAlerta()"><i class="fas fa-plus"></i> Agregar Pre-Alerta</button>
            </div>
            <div class="card-body" id="prealertas-container">
                {% for prealerta in viaje.prealertas %}
                <div class="dynamic-item" id="prealerta-{{ loop.index }}">
                    <span class="item-counter">{{ loop.index }}</span>
                    <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('prealerta-{{ loop.index }}')"></button>
                    <input type="hidden" name="prealerta_id[]" value="{{ prealerta.id }}">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Banco</label>
                            <select name="prealerta_banco[]" class="form-select">
                                {% for banco in bancos %}
                                <option value="{{ banco }}" {% if prealerta.banco == banco %}selected{% endif %}>{{ banco }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Teléfono Entidad Financiera</label>
                            <input type="text" name="prealerta_telefono[]" class="form-control" value="{{ prealerta.telefono_entidad or '' }}">
                        </div>
                    </div>
                    <!-- ... otros campos de prealerta pre-poblados ... -->
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- SEPARADOR LUGARES A VISITAR -->
        <div class="section-separator"></div>
        <h2 class="text-center mb-3">LUGARES A VISITAR</h2>
        
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                Atracciones
                 <button type="button" class="btn btn-sm btn-success" onclick="addLugar()"><i class="fas fa-plus"></i> Agregar Lugar</button>
            </div>
            <div class="card-body" id="lugares-container">
                {% for lugar in viaje.lugares %}
                <div class="dynamic-item" id="lugar-{{ loop.index }}">
                    <span class="item-counter">{{ loop.index }}</span>
                    <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('lugar-{{ loop.index }}', updateTotalAtracciones)"></button>
                    <input type="hidden" name="lugar_id[]" value="{{ lugar.id }}">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tipo de Lugar</label>
                            <select name="lugar_tipo[]" class="form-select">
                                <option {% if lugar.tipo_lugar == 'Volcán' %}selected{% endif %}>Volcán</option>
                                <option {% if lugar.tipo_lugar == 'Montaña' %}selected{% endif %}>Montaña</option>
                                <option {% if lugar.tipo_lugar == 'Playa' %}selected{% endif %}>Playa</option>
                                <option {% if lugar.tipo_lugar == 'Ciudad' %}selected{% endif %}>Ciudad</option>
                                <option {% if lugar.tipo_lugar == 'Parque Nacional' %}selected{% endif %}>Parque Nacional</option>
                                <option {% if lugar.tipo_lugar == 'Camino' %}selected{% endif %}>Camino</option>
                                <option {% if lugar.tipo_lugar == 'Otros' %}selected{% endif %}>Otros</option>
                            </select>
                        </div>
                        <div class="col-md-5 mb-3">
                            <label class="form-label">Nombre de Sitio</label>
                            <input type="text" name="lugar_nombre[]" class="form-control" value="{{ lugar.nombre_sitio or '' }}">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Precio de Entrada (CRC)</label>
                            <input type="number" step="0.01" name="lugar_precio[]" class="form-control price-atraccion" value="{{ lugar.precio_entrada or 0 }}" oninput="updateTotalAtracciones()">
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="card-footer text-end">
                <span class="total-field">TOTAL DE ATRACCIONES: CRC <span id="total-atracciones">0.00</span></span>
            </div>
        </div>

        <!-- ... (resto de las secciones con los bucles for para rellenar los datos existentes) ... -->

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-warning btn-lg">Guardar Cambios</button>
            <a href="{{ url_for('intern.detalle_intern', id=viaje.id) }}" class="btn btn-secondary btn-lg">Cancelar</a>
        </div>
    </form>
    
    <!-- ... Calculadora (igual que en crear_intern.html) ... -->

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // --- Contadores inicializados para evitar colisiones de ID ---
    let preAlertaCount = {{ viaje.prealertas|length }};
    let lugarCount = {{ viaje.lugares|length }};
    let transporteCount = {{ viaje.transportes|length }};
    let guiaCount = {{ viaje.guias|length }};
    let estadiaCount = {{ viaje.estadias|length }};
    let aerolineaCount = {{ viaje.aerolineas|length }};

    // --- (El resto de tu JavaScript para añadir/quitar elementos y calcular totales) ---
    
    // --- INICIALIZAR TOTALES AL CARGAR LA PÁGINA ---
    document.addEventListener('DOMContentLoaded', function() {
        updateTotalAtracciones();
        // updateTotalTransporte();
        // updateTotalGuias();
        // updateTotalEstadia();
        // updateTotalAerolinea();
    });
</script>
{% endblock %}
