{% extends 'base.html' %}

{% block title %}Detalles de {{ viaje.nombre_viaje }}{% endblock %}

{% block head_content %}
<style>
    body {
        background-color: #f8f9fa; /* Color de fondo similar */
    }
    .main-container {
        padding-top: 80px;
        padding-bottom: 80px;
    }
    .header-card {
        background: #fff;
        padding: 2rem;
        border-radius: .375rem;
        margin-bottom: 2rem;
        border: 1px solid #dee2e6;
    }
    .header-card h1 {
        font-weight: 700;
        color: #212529;
    }
    .flyer-img {
        max-width: 100%;
        height: auto;
        border-radius: .375rem;
        border: 1px solid #dee2e6;
    }
    .section-container { /* Usando la misma clase que en crear_intern */
        margin-bottom: 2.5rem;
        border: 1px solid #dee2e6;
        border-radius: .375rem;
        padding: 1.5rem;
        background-color: #fff;
    }
    .section-header { /* Usando la misma clase que en crear_intern */
        font-weight: bold;
        padding: 0.75rem 1.25rem;
        margin: -1.5rem -1.5rem 1.5rem -1.5rem;
        border-bottom: 1px solid #dee2e6;
        border-top-left-radius: .375rem;
        border-top-right-radius: .375rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #ffc107 !important; /* Color amarillo */
        color: #000;
    }
    .detail-item {
        display: flex;
        justify-content: space-between;
        padding: .5rem 0;
        border-bottom: 1px solid #efefef;
    }
    .detail-item:last-child {
        border-bottom: none;
    }
    .detail-item strong {
        color: #343a40;
        margin-right: 1rem;
        flex-shrink: 0;
    }
    .detail-item span {
        color: #6c757d;
        text-align: right;
    }
    .fab-container-left {
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 1000;
    }
    .fab-container-right {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }
    .fab-button {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        color: white;
        border: none;
        text-decoration: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }
    .fab-edit { background-color: #ffc107; color: #000; } /* Botón editar amarillo */
    .fab-back { background-color: #6c757d; } /* Botón volver gris */
    .fab-button:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    .subtotal-footer {
        text-align: right;
        font-weight: bold;
        font-size: 1.25rem;
        padding-top: 1rem;
        margin-top: 1rem;
        border-top: 1px solid #dee2e6;
        color: #212529;
    }
    .card-within-section {
        border: 1px dashed #ccc;
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
{# --- LÓGICA PARA CALCULAR SUBTOTALES Y TOTALES --- #}
{% set subtotal_lugares = viaje.lugares | sum(attribute='precio_entrada') %}
{% set subtotal_transportes = viaje.transportes | sum(attribute='precio') %}

{% set subtotal_guias = {'total': 0} %}
{% for item in viaje.guias %}{% set _ = subtotal_guias.update({'total': subtotal_guias.total + (item.precio_guia_pp or 0) + (item.precio_acarreo or 0)}) %}{% endfor %}
{% set subtotal_guias = subtotal_guias.total %}

{% set subtotal_estadias = {'total': 0} %}
{% for item in viaje.estadias %}{% set _ = subtotal_estadias.update({'total': subtotal_estadias.total + ((item.precio_pp or 0) * (item.cantidad_noches or 1))}) %}{% endfor %}
{% set subtotal_estadias = subtotal_estadias.total %}

{% set subtotal_aerolineas = {'total': 0} %}
{% for item in viaje.aerolineas %}
    {% set _ = subtotal_aerolineas.update({'total': subtotal_aerolineas.total + (item.precio_asientos or 0) + (item.precio_maletas_documentado or 0) + (item.equipaje_mano or 0) + (item.precio_impuestos or 0) + (item.precio_estandar or 0) + (item.precio_equipo or 0) + (item.precio_salida_rapida or 0) + (item.precio_premium or 0) + (item.precio_vip or 0) + (item.precio_basic or 0) + (item.precio_classic or 0) + (item.precio_flexible or 0)}) %}
    {% for i in range(1, 5) %}
        {% set costo = item['otro_costo_valor_' ~ i] or 0 %}
        {% set cant = item['otro_costo_cant_' ~ i] or 1 %}
        {% if costo %}{% set _ = subtotal_aerolineas.update({'total': subtotal_aerolineas.total + (costo * cant)}) %}{% endif %}
    {% endfor %}
{% endfor %}
{% set subtotal_aerolineas = subtotal_aerolineas.total %}

{% set total_individual = (viaje.precio_paquete or 0) + subtotal_lugares + subtotal_transportes + subtotal_guias + subtotal_estadias + subtotal_aerolineas %}

{% if viaje.tipo_moneda == 'USD' %}
    {% set total_usd = total_individual %}
    {% set total_crc = total_individual * (viaje.tipo_cambio or 1) %}
{% else %}
    {% set total_crc = total_individual %}
    {% set total_usd = total_individual / (viaje.tipo_cambio or 1) %}
{% endif %}
{# --- FIN DE LA LÓGICA --- #}

<div class="container main-container">
    
    <!-- Encabezado Principal -->
    <div class="header-card">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1>{{ viaje.nombre_viaje }}</h1>
                <p class="lead">País de Destino: <strong>{{ viaje.pais }}</strong></p>
            </div>
            <div class="col-md-4 text-center">
                {% if viaje.flyer %}
                    <img src="{{ url_for('static', filename=viaje.flyer) }}" alt="Flyer del Viaje" class="flyer-img">
                {% else %}
                    <div class="text-center p-4 bg-light rounded">Sin Flyer</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Detalles Generales y Totales -->
    <div class="section-container">
        <div class="section-header">Resumen Financiero y del Viaje</div>
        <ul class="list-group list-group-flush">
            <li class="list-group-item detail-item"><strong>Capacidad:</strong> <span>{{ viaje.capacidad }} personas</span></li>
            <li class="list-group-item detail-item"><strong>Precio Base del Paquete (PP):</strong> <span>{{ "{:,.2f}".format(viaje.precio_paquete or 0) }} USD</span></li>
            <li class="list-group-item detail-item bg-light"><strong>TOTAL INDIVIDUAL (USD):</strong> <span class="fw-bold fs-5">${{ "{:,.2f}".format(total_usd or 0) }}</span></li>
            <li class="list-group-item detail-item bg-light"><strong>TOTAL INDIVIDUAL (CRC):</strong> <span class="fw-bold fs-5">₡{{ "{:,.2f}".format(total_crc or 0) }}</span></li>
             {% if viaje.tipo_moneda == 'CRC' %}
            <li class="list-group-item detail-item"><small>Tipo de Cambio Usado:</small> <small>1 USD = {{ viaje.tipo_cambio }} CRC</small></li>
            {% endif %}
        </ul>
    </div>

    <!-- Pre-Alertas -->
    {% if viaje.prealertas %}
    <div class="section-container">
        <div class="section-header">
            <span><i class="fas fa-exclamation-triangle me-2"></i> Administración de Viaje: Pre-Alertas ({{ viaje.prealertas|length }})</span>
        </div>
        {% for item in viaje.prealertas %}
        <div class="card mb-3 card-within-section">
            <div class="card-header bg-light"><strong>{{ item.banco or 'Pre-alerta sin banco' }}</strong></div>
            <div class="card-body">
               <ul>
                    <li class="detail-item"><strong>Tel. Entidad:</strong> <span>{{ item.telefono_entidad or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Fecha Pre-alerta:</strong> <span>{{ item.fecha_prealerta.strftime('%d/%m/%Y') if item.fecha_prealerta else 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Asesor:</strong> <span>{{ item.asesor or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Hora Pre-alerta:</strong> <span>{{ item.hora_prealerta.strftime('%I:%M %p') if item.hora_prealerta else 'N/A' }}</span></li>
                    <li class="detail-item"><strong># Pre-alerta:</strong> <span>{{ item.numero_prealerta or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Periodo Pre-alertado:</strong> <span>Del {{ item.fecha_desde.strftime('%d/%m/%Y') if item.fecha_desde else 'N/A' }} al {{ item.fecha_hasta.strftime('%d/%m/%Y') if item.fecha_hasta else 'N/A' }}</span></li>
               </ul>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Lugares a Visitar -->
    {% if viaje.lugares %}
    <div class="section-container">
        <div class="section-header">
            <span><i class="fas fa-map-marked-alt me-2"></i> Lugares a Visitar ({{ viaje.lugares|length }})</span>
        </div>
        {% for item in viaje.lugares %}
         <div class="card mb-3 card-within-section">
            <div class="card-header bg-light"><strong>{{ item.nombre_sitio or 'Lugar sin nombre' }}</strong> ({{ item.tipo_lugar }})</div>
            <div class="card-body">
                <ul>
                    <li class="detail-item"><strong>Precio Entrada (PP):</strong> <span>{{ "{:,.2f}".format(item.precio_entrada or 0) }} USD</span></li>
                    <hr>
                    <li class="detail-item"><strong>Fecha Reserva:</strong> <span>{{ item.fecha_reserva.strftime('%d/%m/%Y') if item.fecha_reserva else 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Guía Local:</strong> <span>{% if item.guia_local %}Sí, {{ item.nombre_guia or 'No especificado' }}{% else %}No{% endif %}</span></li>
                    <li class="detail-item"><strong>Tel. del Lugar:</strong> <span>{{ item.telefono_lugar or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Tel. de Contacto:</strong> <span>{{ item.telefono_contacto or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>WhatsApp:</strong> <span>{{ item.whatsapp_contacto or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Email:</strong> <span>{{ item.email or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Enlaces:</strong> <span>{{ item.enlaces or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Nota:</strong> <span>{{ item.nota or 'N/A' }}</span></li>
                </ul>
            </div>
        </div>
        {% endfor %}
        <div class="subtotal-footer">
            SUBTOTAL: {{ "{:,.2f}".format(subtotal_lugares) }} USD
        </div>
    </div>
    {% endif %}

    <!-- Transportes Locales -->
    {% if viaje.transportes %}
    <div class="section-container">
        <div class="section-header">
            <span><i class="fas fa-bus-alt me-2"></i> Transportes Locales ({{ viaje.transportes|length }})</span>
        </div>
        {% for item in viaje.transportes %}
        <div class="card mb-3 card-within-section">
            <div class="card-header bg-light"><strong>{{ item.nombre_transporte or 'Transporte sin nombre' }}</strong> ({{ item.tipo_transporte }})</div>
            <div class="card-body">
               <ul>
                    <li class="detail-item"><strong>Precio (PP):</strong> <span>{{ "{:,.2f}".format(item.precio or 0) }} USD</span></li>
                    <hr>
                    <li class="detail-item"><strong>Conductor:</strong> <span>{{ item.conductor or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Fecha Contratación:</strong> <span>{{ item.fecha_contratacion.strftime('%d/%m/%Y') if item.fecha_contratacion else 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Tel. del Lugar:</strong> <span>{{ item.telefono_lugar or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Tel. de Contacto:</strong> <span>{{ item.telefono_contacto or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>WhatsApp:</strong> <span>{{ item.whatsapp or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Email:</strong> <span>{{ item.email or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Enlaces:</strong> <span>{{ item.enlaces or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Nota:</strong> <span>{{ item.nota or 'N/A' }}</span></li>
               </ul>
            </div>
        </div>
        {% endfor %}
        <div class="subtotal-footer">
            SUBTOTAL: {{ "{:,.2f}".format(subtotal_transportes) }} USD
        </div>
    </div>
    {% endif %}
    
    <!-- Guías -->
    {% if viaje.guias %}
    <div class="section-container">
        <div class="section-header">
            <span><i class="fas fa-user-tie me-2"></i> Guías Contratados ({{ viaje.guias|length }})</span>
        </div>
        {% for guia in viaje.guias %}
        <div class="card mb-3 card-within-section">
            <div class="card-header bg-light"><strong>{{ guia.nombre or 'Guía sin nombre' }}</strong></div>
            <div class="card-body">
               <ul>
                    <li class="detail-item"><strong>Precio Guía (PP):</strong> <span>{{ "{:,.2f}".format(guia.precio_guia_pp or 0) }} USD</span></li>
                    <li class="detail-item"><strong>Precio Acarreo:</strong> <span>{{ "{:,.2f}".format(guia.precio_acarreo or 0) }} USD</span></li>
                    <hr>
                    <li class="detail-item"><strong>Operador:</strong> <span>{{ guia.operador or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Teléfono:</strong> <span>{{ guia.telefono or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>WhatsApp:</strong> <span>{{ guia.whatsapp or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Email:</strong> <span>{{ guia.email or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>CPL:</strong> <span>{{ guia.cpl or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Fecha Disponible:</strong> <span>{{ guia.fecha_disponible.strftime('%d/%m/%Y') if guia.fecha_disponible else 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Fecha Reserva:</strong> <span>{{ guia.fecha_reserva.strftime('%d/%m/%Y') if guia.fecha_reserva else 'N/A' }}</span></li>
                    <li class="detail-item"><strong># Reserva:</strong> <span>{{ guia.reserva or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Enlaces:</strong> <span>{{ guia.enlaces or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Nota:</strong> <span>{{ guia.nota or 'N/A' }}</span></li>
               </ul>
            </div>
        </div>
        {% endfor %}
        <div class="subtotal-footer">
            SUBTOTAL: {{ "{:,.2f}".format(subtotal_guias) }} USD
        </div>
    </div>
    {% endif %}

    <!-- Estadías -->
    {% if viaje.estadias %}
    <div class="section-container">
        <div class="section-header">
            <span><i class="fas fa-bed me-2"></i> Estadías ({{ viaje.estadias|length }})</span>
        </div>
        {% for estadia in viaje.estadias %}
        <div class="card mb-3 card-within-section">
            <div class="card-header bg-light"><strong>{{ estadia.nombre or 'Estadía sin nombre' }}</strong> ({{ estadia.tipo_estadia }})</div>
            <div class="card-body">
               <ul>
                    <li class="detail-item"><strong>Precio (PP por noche):</strong> <span>{{ "{:,.2f}".format(estadia.precio_pp or 0) }} USD x {{ estadia.cantidad_noches }} noches</span></li>
                    <hr>
                    <li class="detail-item"><strong>Check-in:</strong> <span>{{ estadia.fecha_checkin.strftime('%d/%m/%Y') if estadia.fecha_checkin else 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Check-out:</strong> <span>{{ estadia.fecha_checkout.strftime('%d/%m/%Y') if estadia.fecha_checkout else 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Tel. del Lugar:</strong> <span>{{ estadia.telefono_lugar or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Tel. de Contacto:</strong> <span>{{ estadia.telefono_contacto or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>WhatsApp:</strong> <span>{{ estadia.whatsapp or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Email:</strong> <span>{{ estadia.email or 'N/A' }}</span></li>
                    <li class="detail-item"><strong># Reserva:</strong> <span>{{ estadia.numero_reserva or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Enlaces:</strong> <span>{{ estadia.enlaces or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Nota:</strong> <span>{{ estadia.nota or 'N/A' }}</span></li>
               </ul>
            </div>
        </div>
        {% endfor %}
        <div class="subtotal-footer">
            SUBTOTAL: {{ "{:,.2f}".format(subtotal_estadias) }} USD
        </div>
    </div>
    {% endif %}

    <!-- Aerolínea / Transporte Principal -->
    {% if viaje.aerolineas %}
    <div class="section-container">
        <div class="section-header">
            <span><i class="fas fa-plane-departure me-2"></i> Aerolínea / Transporte Principal ({{ viaje.aerolineas|length }})</span>
        </div>
        {% for item in viaje.aerolineas %}
        <div class="card mb-3 card-within-section">
            <div class="card-header bg-light"><strong>{{ item.nombre_aerolinea or 'Transporte sin nombre' }}</strong> ({{ item.tipo_transporte }})</div>
            <div class="card-body">
               <ul>
                    <li class="detail-item"><strong>Teléfono:</strong> <span>{{ item.telefono or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Email:</strong> <span>{{ item.email or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>WhatsApp:</strong> <span>{{ item.whatsapp or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Teléfono Pre-alerta:</strong> <span>{{ item.tel_prealerta or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Fecha Pre-alerta:</strong> <span>{{ item.fecha_prealerta.strftime('%d/%m/%Y') if item.fecha_prealerta else 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Enlace Pre-alerta:</strong> <span><a href="{{ item.enlace_prealerta }}" target="_blank">Visitar</a></span></li>
                    <hr>
                    <li class="detail-item"><strong># Vuelo:</strong> <span>{{ item.numero_vuelo or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Salida:</strong> <span>{{ item.horario_salida.strftime('%d/%m/%Y %I:%M %p') if item.horario_salida else 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Llegada:</strong> <span>{{ item.horario_llegada.strftime('%d/%m/%Y %I:%M %p') if item.horario_llegada else 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Fecha Compra:</strong> <span>{{ item.fecha_compra.strftime('%d/%m/%Y') if item.fecha_compra else 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Aeropuerto:</strong> <span>{{ item.nombre_aeropuerto or 'N/A' }}</span></li>
                    <li class="detail-item"><strong>Tel. Aeropuerto:</strong> <span>{{ item.tel_aeropuerto or 'N/A' }}</span></li>
                    <hr>
                    <li class="detail-item"><strong>Precio Asientos:</strong> <span>{{ "{:,.2f}".format(item.precio_asientos or 0) }} USD</span></li>
                    <li class="detail-item"><strong>Precio Maletas Doc.:</strong> <span>{{ "{:,.2f}".format(item.precio_maletas_documentado or 0) }} USD</span></li>
                    <li class="detail-item"><strong>Equipaje de Mano:</strong> <span>{{ "{:,.2f}".format(item.equipaje_mano or 0) }} USD</span></li>
                    <li class="detail-item"><strong>Precio Impuestos:</strong> <span>{{ "{:,.2f}".format(item.precio_impuestos or 0) }} USD</span></li>
                    <li class="detail-item"><strong>Precio Estandar:</strong> <span>{{ "{:,.2f}".format(item.precio_estandar or 0) }} USD</span></li>
                    <li class="detail-item"><strong>Precio Mas Equipo:</strong> <span>{{ "{:,.2f}".format(item.precio_equipo or 0) }} USD</span></li>
                    <li class="detail-item"><strong>Precio Salida Rápida:</strong> <span>{{ "{:,.2f}".format(item.precio_salida_rapida or 0) }} USD</span></li>
                    <li class="detail-item"><strong>Precio Premium:</strong> <span>{{ "{:,.2f}".format(item.precio_premium or 0) }} USD</span></li>
                    <li class="detail-item"><strong>Precio VIP:</strong> <span>{{ "{:,.2f}".format(item.precio_vip or 0) }} USD</span></li>
                    <li class="detail-item"><strong>Precio Basic:</strong> <span>{{ "{:,.2f}".format(item.precio_basic or 0) }} USD</span></li>
                    <li class="detail-item"><strong>Precio Classic:</strong> <span>{{ "{:,.2f}".format(item.precio_classic or 0) }} USD</span></li>
                    <li class="detail-item"><strong>Precio Flexible:</strong> <span>{{ "{:,.2f}".format(item.precio_flexible or 0) }} USD</span></li>
                    {% for i in range(1, 5) %}
                        {% set desc = item['otro_costo_desc_' ~ i] %}
                        {% set costo = item['otro_costo_valor_' ~ i] %}
                        {% if desc and costo %}
                        <li class="detail-item"><strong>{{ desc }}:</strong> <span>{{ "{:,.2f}".format(costo) }} USD</span></li>
                        {% endif %}
                    {% endfor %}
               </ul>
            </div>
        </div>
        {% endfor %}
        <div class="subtotal-footer">
            SUBTOTAL: {{ "{:,.2f}".format(subtotal_aerolineas) }} USD
        </div>
    </div>
    {% endif %}

</div>

<!-- Botones Flotantes -->
<div class="fab-container-left">
    <a href="{{ url_for('intern.index') }}" class="fab-button fab-back" title="Volver al Listado">
        <i class="fas fa-arrow-left"></i>
    </a>
</div>

<div class="fab-container-right">
     <a href="{{ url_for('intern.editar_intern', id=viaje.id) }}" class="fab-button fab-edit" title="Editar Viaje">
        <i class="fas fa-pencil-alt"></i>
    </a>
</div>
{% endblock %}
