    {% extends "base.html" %}

    {% block title %}Listado de Caminatas{% endblock %}

    {% block head_content %}
    <style>
        /* Estilos específicos para el botón flotante (FAB) de Añadir */
        .fab-container {
            position: fixed;
            bottom: 50px;
            right: 20px;
            z-index: 1000;
        }
        .fab-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            transition: all 0.3s ease;
        }
        .fab-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        /* --- INICIO: NUEVOS ESTILOS PARA BOTONES DE COMPARTIR --- */
        .fab-container-share {
            position: fixed;
            right: 20px;
            bottom: 120px; /* Posicionado arriba del botón de añadir */
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        .fab-button-share {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            transition: all 0.3s ease;
            color: #ffffff;
            border: none;
            text-decoration: none;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .fab-button-share:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .fab-button-share.whatsapp { background-color: #25D366; }
        .fab-button-share.copy-link { background-color: #0d6efd; }
        
        #toast-notification {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 3000;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            opacity: 0;
            transition: opacity 0.5s, visibility 0.5s;
        }

        #toast-notification.show {
            visibility: visible;
            opacity: 1;
        }
        
        /* CAMBIO: Estilos para caminatas finalizadas */
        .caminata-finalizada .card-img-top {
            filter: grayscale(100%);
        }
        .caminata-finalizada .card-body {
            position: relative;
        }
        .caminata-finalizada .card-body::after {
            content: 'FINALIZADA';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            font-size: 2rem;
            font-weight: bold;
            color: rgba(220, 53, 69, 0.5); /* Rojo con transparencia */
            z-index: 1;
            pointer-events: none; /* Para que no interfiera con los clics */
        }
        .caminata-finalizada .btn {
            filter: grayscale(80%);
        }

        .grid-list-content { display: block; }
        .image-only-content { display: none; }

        #caminatasContent.list-view { }

        #caminatasContent.list-view > .col {
            margin-top: 0 !important;
            padding-bottom: 0.5rem;
            border-bottom: 1px dashed #ddd;
            margin-bottom: 0.5rem;
        }

        #caminatasContent.list-view > .col:last-child {
            border-bottom: none;
        }

        #caminatasContent.list-view .card {
            flex-direction: row;
            align-items: center;
            box-shadow: none !important;
            border: none !important;
            height: auto !important;
            padding: 0.5rem;
            background-color: transparent !important;
        }

        .card-img-wrapper {
            position: relative;
            width: 100%;
            padding-top: calc(1920 / 1280 * 100%);
            overflow: hidden;
            border-radius: 8px 8px 0 0;
        }

        .card-img-top {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        #caminatasContent.list-view .card-img-wrapper {
            display: block !important;
            width: 60px;
            height: 60px;
            padding-top: 0 !important;
            flex-shrink: 0;
            border-radius: 8px;
            margin-right: 1rem;
        }
        #caminatasContent.list-view .card-img-top {
            position: static;
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }


        #caminatasContent.list-view .card-body {
            flex-grow: 1;
            padding: 0.5rem 1rem !important;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        #caminatasContent.list-view .card-body .card-title,
        #caminatasContent.list-view .card-body .card-text {
            margin-bottom: 0 !important;
        }

        #caminatasContent.list-view .card-body hr {
            display: none !important;
        }

        #caminatasContent.list-view .card-body .mt-auto {
            margin-top: 0 !important;
            margin-left: auto;
        }

        #caminatasContent.list-view .card-body .btn {
            min-width: 80px;
        }

        #caminatasContent.list-view .card-title {
            font-size: 1.1rem;
        }

        #caminatasContent.list-view .card-text small {
            font-size: 0.75rem;
        }

        @media (max-width: 767.98px) {
            #caminatasContent.list-view .card-body {
                flex-direction: column;
                align-items: flex-start;
            }
            #caminatasContent.list-view .card-body .mt-auto {
                margin-left: 0;
                width: 100%;
            }
        }

        #caminatasContent.gallery-view {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 2rem;
        }

        #caminatasContent.gallery-view > .col {
            margin-top: 0 !important;
            padding: 0 !important;
            flex: none !important;
            max-width: none !important;
            width: auto !important;
        }

        #caminatasContent.gallery-view .grid-list-content {
            display: none !important;
        }

        #caminatasContent.gallery-view .image-only-content {
            display: block !important;
            height: 100%;
        }

        .image-only-wrapper {
            position: relative;
            width: 100%;
            padding-top: calc(1920 / 1280 * 100%);
            overflow: hidden;
            border-radius: 8px;
            background-color: #f0f0f0;
        }

        .image-only-content img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }

        @media (min-width: 768px) {
            #caminatasContent.gallery-view {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
    {% endblock %}

    {% block content %}
    <div class="container ">
        <div class="mb-4 text-center">
            <h2 class="text-warning">Próximas Caminatas</h2>
            <p>Las siguientes caminatas ya estás asignadas en el calendario y definidas con sus respectivos precios. Cualquier caminatas puede sufrir variación por factores externos que afecten la seguridad de las mismas. </p>
        </div>

        <div class="row justify-content-center mb-4">
            <div class="col-md-6">
                <form method="GET" action="{{ url_for('caminatas.ver_caminatas') }}" class="d-flex">
                    <select name="actividad" class="form-select me-2" aria-label="Buscar por Actividad">
                        <option value="">Todas las Actividades</option>
                        {% set actividad_opciones = [
                            "El Camino de Costa Rica",
                            "Parque Nacional",
                            "Paseo",
                            "Iniciante",
                            "Básico",
                            "Intermedio",
                            "Dificil",
                            "Avanzado",
                            "Técnico"
                        ] %}
                        {% for option in actividad_opciones %}
                        <option value="{{ option }}" {% if option == search_actividad %}selected{% endif %}>{{ option }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-outline-secondary">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                    {% if search_actividad %}
                        <a href="{{ url_for('caminatas.ver_caminatas') }}" class="btn btn-outline-danger ms-2">
                            <i class="fas fa-times"></i> Limpiar
                        </a>
                    {% endif %}
                </form>
            </div>
        </div>


        {% if caminatas %}
           <hr class="text-warning">
           
        <div class="d-flex justify-content-end mb-3">
            <button id="gridViewBtn" class="btn btn-sm btn-outline-secondary me-2" title="Vista de Cuadrícula">
                <i class="fas fa-th-large"></i>
            </button>
            <button id="listViewBtn" class="btn btn-sm btn-outline-secondary me-2" title="Vista de Lista Compacta">
                <i class="fas fa-list"></i>
            </button>
            <button id="galleryViewBtn" class="btn btn-sm btn-outline-secondary" title="Vista de Galería de Imágenes">
                <i class="fas fa-image"></i>
            </button>
        </div>

        <div id="caminatasContent">
            {% for caminata in caminatas %}
            <div class="col mt-5">
                {# CAMBIO: Se añade la clase 'caminata-finalizada' si la caminata está marcada como tal #}
                <div class="grid-list-content {% if caminata.finalizada %}caminata-finalizada{% endif %}">
                    <div class="card h-100 shadow-sm">
                        <a href="{{ url_for('caminatas.detalle_caminata', caminata_id=caminata.id) }}" class="card-img-link">
                            <div class="card-img-wrapper">
                                {% if caminata.imagen_caminata_url %}
                                <img src="{{ url_for('static', filename=caminata.imagen_caminata_url) }}" class="card-img-top" alt="Imagen de la Caminata" onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/defaults/no_image.png') }}'; console.error('Error al cargar imagen. URL esperada: {{ url_for('static', filename=caminata.imagen_caminata_url) }}');">
                                {% else %}
                                <img src="{{ url_for('static', filename='images/defaults/no_image.png') }}" class="card-img-top" alt="Sin Imagen" onerror="this.onerror=null; console.error('Error al cargar imagen por defecto para {{ caminata.nombre }}. URL: {{ url_for('static', filename='images/defaults/no_image.png') }}');">
                                {% endif %}
                            </div>
                        </a>
                        <div class="card-body d-flex flex-column">
                            {% if caminata.etapa %}
                            <h4 class="card-title text-center mb-3">{{ caminata.etapa }}</h4>
                            {% endif %}
                            <h4 class="card-title text-truncate">{{ caminata.nombre }}</h4>
                            
                            <p class="card-text mb-1 text-truncate"><small class="text-muted"><strong>Actividad:</strong> {{ caminata.actividad }}</small></p>
                            <p class="card-text mb-1 text-truncate"><small class="text-muted"><strong>Fecha:</strong> {{ caminata.fecha.strftime('%d de %B de %Y') }}</small></p>
                            <h4 class="card-text mb-1 text-truncate text-end"><small class="text-muted "><strong>Precio:</strong> ¢{{ caminata.precio|int }}</small></h4>
                            <hr class="my-2 border-warning">
                                              
                            <div class="mt-auto text-center">
                                <a href="{{ url_for('caminatas.detalle_caminata', caminata_id=caminata.id) }}" class="btn btn-warning btn-sm w-100">Más</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="image-only-content {% if caminata.finalizada %}caminata-finalizada{% endif %}">
                    <a href="{{ url_for('caminatas.detalle_caminata', caminata_id=caminata.id) }}" class="image-only-link">
                        <div class="image-only-wrapper">
                            {% if caminata.imagen_caminata_url %}
                            <img src="{{ url_for('static', filename=caminata.imagen_caminata_url) }}" alt="Imagen de la Caminata" onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/defaults/no_image.png') }}'; console.error('Error al cargar imagen en Galería. URL esperada: {{ url_for('static', filename=caminata.imagen_caminata_url) }}');">
                            {% else %}
                            <img src="{{ url_for('static', filename='images/defaults/no_image.png') }}" alt="Sin Imagen" onerror="this.onerror=null; console.error('Error al cargar imagen por defecto en Galería para {{ caminata.nombre }}. URL: {{ url_for('static', filename='images/defaults/no_image.png') }}');">
                            {% endif %}
                        </div>
                    </a>
                </div>

            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info text-center" role="alert">
            No hay caminatas registradas aún.
        </div>
        {% endif %}
    </div>

    <div id="toast-notification">¡Enlace copiado al portapapeles!</div>

    <div class="fab-container-share">
        <a href="#" id="copyLinkButton" class="fab-button-share copy-link" title="Compartir Enlace">
            <i class="fas fa-share-alt"></i>
        </a>
        <a href="#" id="whatsappShareButton" class="fab-button-share whatsapp" title="Compartir por WhatsApp">
            <i class="fab fa-whatsapp"></i>
        </a>
    </div>

    {% if session.role == 'Superuser' %}
    <div class="fab-container">
        <a href="{{ url_for('caminatas.crear_caminata') }}" class="btn btn-warning fab-button" title="Agregar nueva caminata">
            <i class="fas fa-plus" style="color: black;"></i>
        </a>
    </div>
    {% endif %}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const gridViewBtn = document.getElementById('gridViewBtn');
            const listViewBtn = document.getElementById('listViewBtn');
            const galleryViewBtn = document.getElementById('galleryViewBtn'); 
            const caminatasContent = document.getElementById('caminatasContent');
            const savedView = localStorage.getItem('caminatasView') || 'grid';

            function setView(viewType) {
                caminatasContent.classList.remove('list-view', 'gallery-view');
                caminatasContent.classList.remove('row', 'g-4', 'row-cols-1', 'row-cols-md-4', 'row-cols-lg-4');
                const gridListContents = document.querySelectorAll('.grid-list-content');
                const imageOnlyContents = document.querySelectorAll('.image-only-content');

                if (viewType === 'list') {
                    caminatasContent.classList.add('list-view', 'row', 'g-4', 'row-cols-1', 'row-cols-md-4', 'row-cols-lg-4'); 
                    gridListContents.forEach(el => el.style.display = 'flex');
                    imageOnlyContents.forEach(el => el.style.display = 'none');
                } else if (viewType === 'gallery') {
                    caminatasContent.classList.add('gallery-view');
                    gridListContents.forEach(el => el.style.display = 'none');
                    imageOnlyContents.forEach(el => el.style.display = 'block');
                } else {
                    caminatasContent.classList.add('row', 'g-4', 'row-cols-1', 'row-cols-md-4', 'row-cols-lg-4');
                    gridListContents.forEach(el => el.style.display = 'block');
                    imageOnlyContents.forEach(el => el.style.display = 'none');
                }

                gridViewBtn.classList.remove('active');
                listViewBtn.classList.remove('active');
                galleryViewBtn.classList.remove('active');

                if (viewType === 'list') {
                    listViewBtn.classList.add('active');
                } else if (viewType === 'gallery') {
                    galleryViewBtn.classList.add('active');
                } else {
                    gridViewBtn.classList.add('active');
                }
                localStorage.setItem('caminatasView', viewType);
            }

            setView(savedView);

            gridViewBtn.addEventListener('click', () => setView('grid'));
            listViewBtn.addEventListener('click', () => setView('list'));
            galleryViewBtn.addEventListener('click', () => setView('gallery'));

            const whatsappShareButton = document.getElementById('whatsappShareButton');
            if (whatsappShareButton) {
                whatsappShareButton.addEventListener('click', (event) => {
                    event.preventDefault();
                    const text = '¡Hola! Te comparto este enlace para que veas las caminatas de La Tribu CR:';
                    const url = 'https://www.latribucr.site/caminatas/ver_caminatas';
                    const message = encodeURIComponent(`${text} ${url}`);
                    const whatsappUrl = `https://wa.me/?text=${message}`;
                    window.open(whatsappUrl, '_blank');
                });
            }

            const copyLinkButton = document.getElementById('copyLinkButton');
            if (copyLinkButton) {
                copyLinkButton.addEventListener('click', async (event) => {
                    event.preventDefault();
                    const shareData = {
                        title: 'Caminatas de La Tribu CR',
                        text: 'Descubre todas las caminatas y eventos disponibles.',
                        url: 'https://www.latribucr.site/caminatas/ver_caminatas'
                    };
                    try {
                        if (navigator.share) {
                            await navigator.share(shareData);
                        } else {
                            throw new Error('Share API not supported');
                        }
                    } catch (err) {
                        try {
                            const textArea = document.createElement('textarea');
                            textArea.value = shareData.url;
                            textArea.style.position = 'fixed';
                            textArea.style.left = '-9999px';
                            document.body.appendChild(textArea);
                            textArea.focus();
                            textArea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textArea);
                            const toast = document.getElementById('toast-notification');
                            toast.className = 'show';
                            setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3000);
                        } catch (copyErr) {
                            console.error('Error al copiar al portapapeles:', copyErr);
                        }
                    }
                });
            }
            
            const enableNotificationsBtn = document.getElementById('enableNotificationsBtn');
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                // ... (código de notificaciones existente)
            }
        });
    </script>
    {% endblock %}
