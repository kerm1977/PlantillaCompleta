{% extends 'base.html' %}

{% block content %}
<style>
    /* Estilos adicionales si fueran necesarios */
    /* Estilos para el botón flotante (FAB) */
    .fab-container {
        position: fixed;
        bottom: 70px; /* Distancia desde abajo para alinearse con ver_caminatas */
        right: 20px; /* Distancia desde la derecha */
        z-index: 1000; /* Asegura que esté por encima de otros elementos */
    }
    .fab-container.left { /* Contenedor para el botón flotante de la izquierda */
        left: 20px; /* Distancia desde la izquierda */
        right: auto; /* Anula la distancia derecha */
    }
    .fab-button {
        width: 60px; /* Tamaño del botón */
        height: 60px; /* Tamaño del botón */
        border-radius: 50%; /* Hacerlo circular */
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem; /* Tamaño del icono */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Sombra para que se vea flotante */
        transition: all 0.3s ease;
    }
    .fab-button:hover {
        transform: scale(1.05); /* Pequeño efecto al pasar el ratón */
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }
    .totals-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
</style>

<div class="container">
    <div class="p-4 mb-5">
        <h2 class="card-title text-center mb-4 text-warning mt-4">Recibo para Caminante</h2>

        <div class="row mb-4">
            <div class="col-md-6">
                <p><strong>Caminata:</strong> {{ caminata.nombre }}</p>
                <p><strong>Fecha de Caminata:</strong> {{ caminata.fecha.strftime('%d-%m-%Y') }}</p>
                <p><strong>Actividad:</strong> {{ caminata.actividad }}</p>
                <p><strong>Dificultad:</strong> {{ caminata.dificultad if caminata.dificultad else 'N/A' }}</p>
                <p><strong>Distancia:</strong> {{ "%.1f km"|format(caminata.distancia) if caminata.distancia is not none else 'N/A' }}</p>
            </div>
            <div class="col-md-6 text-md-end">
                <p><strong>Participante:</strong> {{ participante.nombre }} {{ participante.primer_apellido }}</p>
                <p><strong>Precio por Persona:</strong> {% if caminata.moneda == 'USD' %}${% else %}¢{% endif %}{{ caminata.precio | int }}</p>
                
                <!-- === INICIO MODIFICACIÓN: TOTALES DOBLE MONEDA (CORREGIDO) === -->
                {# Se definen variables para hacer el código más claro y robusto #}
                {% set price = caminata.precio | float %}
                {% set paid_crc_from_db = total_abonado_crc | default(0) | float %}
                {% set paid_usd_from_db = total_abonado_usd | default(0) | float %}

                {# Usar el tipo de cambio del último abono para el cálculo inicial. Si no hay, no se convierte. #}
                {% set exchange_rate = abonos[0].tipo_cambio_bcr | float if abonos and abonos[0].tipo_cambio_bcr else 0 %}

                {# Lógica de cálculo de saldos restantes #}
                {% if caminata.moneda == 'USD' %}
                    {# Moneda principal es USD #}
                    {% set price_in_crc = price * exchange_rate if exchange_rate > 0 else 0 %}
                    {% set remaining_usd = price - paid_usd_from_db %}
                {% else %}
                    {# Moneda principal es CRC #}
                    {% set price_in_crc = price %}
                    {# Si la moneda es CRC, el restante en USD es conceptual. Se resta lo pagado en USD de un total de 0. #}
                    {% set remaining_usd = 0 - paid_usd_from_db %}
                {% endif %}

                {# El total abonado en CRC es la suma de los abonos en CRC más los abonos en USD convertidos #}
                {% set total_paid_in_crc = paid_crc_from_db + (paid_usd_from_db * exchange_rate) %}

                {# El monto restante en CRC es el precio en CRC menos todo lo que se ha pagado en CRC (original + convertido) #}
                {% set remaining_crc = price_in_crc - total_paid_in_crc %}

                {# --- NUEVA LÓGICA PARA DETERMINAR SI ESTÁ CANCELADO --- #}
                {% set is_cancelled = false %}
                {% if caminata.moneda == 'USD' %}
                    {# Si el precio en CRC es calculable (hay tipo de cambio), comparamos en CRC #}
                    {% if price_in_crc > 0 and total_paid_in_crc >= price_in_crc %}
                        {% set is_cancelled = true %}
                    {# Si no hay tipo de cambio, pero el pago en USD ya cubre el precio en USD, también está cancelado #}
                    {% elif paid_usd_from_db >= price %}
                        {% set is_cancelled = true %}
                    {% endif %}
                {% else %} {# Moneda es CRC #}
                    {# Comparamos en CRC. El total pagado en CRC ya incluye la conversión de USD #}
                    {% if total_paid_in_crc >= price %}
                        {% set is_cancelled = true %}
                    {% endif %}
                {% endif %}
                {# --- FIN NUEVA LÓGICA --- #}

                <div class="totals-grid mt-3">
                    <div>
                        <h5 class="text-success">Total Abonado CRC:</h5>
                        <h4><strong id="display_total_crc">¢{{ total_paid_in_crc | int }}</strong></h4>
                    </div>
                    <div>
                        <h5 class="text-success">Total Abonado USD:</h5>
                        <h4><strong>${{ paid_usd_from_db | int }}</strong></h4>
                    </div>
                    <div>
                        <h5 class="text-danger">Monto Restante CRC:</h5>
                        {% if is_cancelled %}
                            <h4><strong id="display_remaining_crc" class="text-success">CANCELADO</strong></h4>
                        {% else %}
                            <h4><strong id="display_remaining_crc">¢{{ remaining_crc | int }}</strong></h4>
                        {% endif %}
                    </div>
                    <div>
                        <h5 class="text-danger">Monto Restante USD:</h5>
                        {% if is_cancelled %}
                            <h4><strong id="display_remaining_usd" class="text-success">CANCELADO</strong></h4>
                        {% else %}
                            <h4><strong id="display_remaining_usd">${{ remaining_usd | int }}</strong></h4>
                        {% endif %}
                    </div>
                </div>
                 <!-- === FIN MODIFICACIÓN === -->
            </div>
        </div>

        <hr>

        <h4 class="mb-3 text-warning">Registrar Nuevo Abono</h4>
        <form id="abonoForm" method="POST" action="{{ url_for('caminatas.abono_caminata', caminata_id=caminata.id, user_id=participante.id) }}">
            <input type="hidden" name="add_abono" value="true">
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label for="opcion" class="form-label">Opción <span class="text-danger">*</span>:</label>
                    <select class="form-select" id="opcion" name="opcion" required>
                        <option value="">Seleccionar Opción</option>
                        <option value="Abono">Abono</option>
                        <option value="Reserva">Reserva</option>
                        <option value="Cancelación">Cancelación</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="cantidad_acompanantes" class="form-label">Cantidad Acompañantes:</label>
                    <select class="form-select" id="cantidad_acompanantes" name="cantidad_acompanantes" required>
                        {% for i in range(10) %}
                        <option value="{{ i }}">{{ i }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="tipo_cambio_bcr" class="form-label">Tipo de Cambio USD-BCCR:</label>
                    {# --- INICIO MODIFICACIÓN: Deshabilitar campo --- #}
                    <input type="number" step="0.01" class="form-control" id="tipo_cambio_bcr" name="tipo_cambio_bcr" placeholder="Ej: 515.50" {% if caminata.moneda == 'CRC' %}disabled{% endif %}>
                    {# --- FIN MODIFICACIÓN --- #}
                </div>
                <div class="col-md-4">
                    <label for="monto_abono_crc" class="form-label">Monto Abonado CRC:</label>
                    <div class="input-group">
                        <span class="input-group-text">¢</span>
                        {# --- INICIO MODIFICACIÓN: Deshabilitar campo --- #}
                        <input type="number" step="1" class="form-control" id="monto_abono_crc" name="monto_abono_crc" min="0" value="0" {% if caminata.moneda == 'USD' %}disabled{% endif %}>
                        {# --- FIN MODIFICACIÓN --- #}
                    </div>
                </div>
                <div class="col-md-4">
                    <label for="monto_abono_usd" class="form-label">Monto Abonado USD:</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        {# --- INICIO MODIFICACIÓN: Deshabilitar campo --- #}
                        <input type="number" step="1" class="form-control" id="monto_abono_usd" name="monto_abono_usd" min="0" value="0" {% if caminata.moneda == 'CRC' %}disabled{% endif %}>
                        {# --- FIN MODIFICACIÓN --- #}
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label for="nombres_acompanantes_raw" class="form-label">Nombres de Acompañantes o Detalles (separados por comas):</label>
                <textarea class="form-control" id="nombres_acompanantes_raw" name="nombres_acompanantes_raw" rows="2" placeholder="Ej: Juan Pérez, María Gómez"></textarea>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-warning">Agregar Abono</button>
            </div>
        </form>

        <hr>

        <h4 class="mb-3 text-warning">Historial de Abonos</h4>
        {% if abonos %}
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Fecha Abono</th>
                        <th>Opción</th>
                        <th>Acompañantes</th>
                        <th>Detalles</th>
                        <th>Monto Abonado CRC</th>
                        <th>Monto Abonado USD</th>
                        <th>T.C.</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {# --- INICIO MODIFICACIÓN: Variable para sumar totales del historial --- #}
                    {% set totals = namespace(crc=0) %}
                    {# --- FIN MODIFICACIÓN --- #}
                    {% for abono in abonos %}
                    <tr>
                        <td>{{ abono.fecha_abono.strftime('%d/%m/%Y %H:%M') }}</td>
                        <td>{{ abono.opcion }}</td>
                        <td>{{ abono.cantidad_acompanantes }}</td>
                        <td>
                            {% set nombres_acom = abono.nombres_acompanantes|from_json %}
                            {{ nombres_acom|join(', ') if nombres_acom else 'N/A' }}
                        </td>
                        {# --- INICIO MODIFICACIÓN: Cálculo en historial --- #}
                        {% set crc_val = abono.monto_abono_crc | default(0) | float %}
                        {% set usd_val = abono.monto_abono_usd | default(0) | float %}
                        {% set tc_val = abono.tipo_cambio_bcr | float if abono.tipo_cambio_bcr else 0 %}
                        {% set display_crc = crc_val + (usd_val * tc_val) %}
                        {# --- INICIO MODIFICACIÓN: Acumular total --- #}
                        {% set totals.crc = totals.crc + display_crc %}
                        {# --- FIN MODIFICACIÓN --- #}
                        <td>¢{{ display_crc | int }}</td>
                        {# --- FIN MODIFICACIÓN --- #}
                        <td>${{ abono.monto_abono_usd | default(0) | int }}</td>
                        <td>{{ abono.tipo_cambio_bcr or 'N/A' }}</td>
                        <td>
                            <form action="{{ url_for('caminatas.abono_caminata', caminata_id=caminata.id, user_id=participante.id) }}" method="POST" class="d-inline">
                                <input type="hidden" name="delete_abono" value="true">
                                <input type="hidden" name="abono_id" value="{{ abono.id }}">
                                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('¿Estás seguro de que quieres eliminar este abono?');">Borrar</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                {# --- INICIO MODIFICACIÓN: Fila de totales en el footer de la tabla --- #}
                <tfoot>
                    <tr class="table-light">
                        <td colspan="4" class="text-end"><strong>Totales del Historial:</strong></td>
                        <td><strong>¢{{ totals.crc | int }}</strong></td>
                        <td><strong>${{ paid_usd_from_db | int }}</strong></td>
                        <td colspan="2"></td>
                    </tr>
                </tfoot>
                {# --- FIN MODIFICACIÓN --- #}
            </table>
        </div>
        {% else %}
        <div class="alert alert-warning text-center" role="alert">
            No hay abonos registrados para este participante en esta caminata aún.
        </div>
        {% endif %}

        <hr>

        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-2 mt-4">
            <div class="col">
                <a href="{{ url_for('caminatas.exportar_abono_pdf', caminata_id=caminata.id, user_id=participante.id) }}" class="btn btn-warning w-100" style="color: black;">Exportar PDF</a>
            </div>
            <div class="col">
                <a href="{{ url_for('caminatas.exportar_abono_jpg', caminata_id=caminata.id, user_id=participante.id) }}" class="btn btn-warning w-100" style="color: black;">Exportar JPG</a>
            </div>
            <div class="col">
                <a href="{{ url_for('caminatas.exportar_abono_txt', caminata_id=caminata.id, user_id=participante.id) }}" class="btn btn-warning w-100" style="color: black;">Exportar TXT</a>
            </div>
        </div>
    </div>
</div>

{# Se pasa el último tipo de cambio y los valores base a JS #}
{% set latest_exchange_rate = abonos[0].tipo_cambio_bcr if abonos and abonos[0].tipo_cambio_bcr else None %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Bloque para mantener los valores del formulario entre recargas (sin cambios)
        const nombresAcompanantesInput = document.getElementById('nombres_acompanantes_raw');
        const cantidadAcompanantesSelect = document.getElementById('cantidad_acompanantes');
        const abonoForm = document.getElementById('abonoForm');
        const nombresStorageKey = 'lastNombresAcompanantes_' + window.location.pathname;
        const cantidadStorageKey = 'lastCantidadAcompanantes_' + window.location.pathname;
        if (nombresAcompanantesInput) {
            const savedNombres = sessionStorage.getItem(nombresStorageKey);
            if (savedNombres) { nombresAcompanantesInput.value = savedNombres; }
        }
        if (cantidadAcompanantesSelect) {
            const savedCantidad = sessionStorage.getItem(cantidadStorageKey);
            if (savedCantidad) { cantidadAcompanantesSelect.value = savedCantidad; }
        }
        if (abonoForm) {
            abonoForm.addEventListener('submit', function() {
                if (nombresAcompanantesInput) { sessionStorage.setItem(nombresStorageKey, nombresAcompanantesInput.value); }
                if (cantidadAcompanantesSelect) { sessionStorage.setItem(cantidadStorageKey, cantidadAcompanantesSelect.value); }
            });
        }

        // --- NUEVA Lógica de conversión de moneda ---
        const exchangeRateInput = document.getElementById('tipo_cambio_bcr');
        const totalCrcElement = document.getElementById('display_total_crc');
        const remainingCrcElement = document.getElementById('display_remaining_crc');

        // Guardar los valores iniciales calculados por el servidor
        const initialTotalCrc = totalCrcElement.textContent;
        const initialRemainingCrc = remainingCrcElement.textContent;

        // Obtener valores base de la base de datos (pasados por Jinja)
        const paid_crc_from_db = {{ total_abonado_crc | default(0) | tojson }};
        const paid_usd_from_db = {{ total_abonado_usd | default(0) | tojson }};
        const price = {{ caminata.precio | float | tojson }};
        const isUsdCurrency = {{ caminata.moneda == 'USD' | tojson }};

        function updateCrcValues(rate) {
            const exchangeRate = parseFloat(rate);

            if (!isNaN(exchangeRate) && exchangeRate > 0) {
                // La misma lógica de cálculo que en Jinja
                const totalPaidInCrc = paid_crc_from_db + (paid_usd_from_db * exchangeRate);

                let priceInCrc = 0;
                if (isUsdCurrency) {
                    priceInCrc = price * exchangeRate;
                } else {
                    priceInCrc = price;
                }
                const remainingCrc = priceInCrc - totalPaidInCrc;

                // Actualizar el DOM
                totalCrcElement.textContent = '¢' + Math.round(totalPaidInCrc);
                
                // --- MODIFICACIÓN JS: Mostrar CANCELADO ---
                if (remainingCrc <= 0) {
                    remainingCrcElement.textContent = 'CANCELADO';
                    remainingCrcElement.classList.add('text-success');
                    // También actualizamos el de USD
                    const remainingUsdElement = document.getElementById('display_remaining_usd');
                    if(remainingUsdElement) {
                        remainingUsdElement.textContent = 'CANCELADO';
                        remainingUsdElement.classList.add('text-success');
                    }
                } else {
                    remainingCrcElement.textContent = '¢' + Math.round(remainingCrc);
                    remainingCrcElement.classList.remove('text-success');
                }
            } else {
                // Si el tipo de cambio no es válido, restaurar los valores iniciales
                totalCrcElement.textContent = initialTotalCrc;
                remainingCrcElement.textContent = initialRemainingCrc;
                remainingCrcElement.classList.remove('text-success');
            }
        }

        // Event listener para la entrada en tiempo real
        exchangeRateInput.addEventListener('input', function() {
            updateCrcValues(this.value);
        });

        // Poner el último tipo de cambio en el campo de texto al cargar la página
        const latestExchangeRate = {{ latest_exchange_rate | tojson }};
        if (latestExchangeRate) {
            exchangeRateInput.value = latestExchangeRate;
            // No es necesario llamar a updateCrcValues aquí porque los valores
            // ya fueron calculados correctamente por Jinja en el servidor.
        }
    });
</script>

<div class="fab-container left">
    <a href="{{ url_for('caminatas.detalle_caminata', caminata_id=caminata.id) }}" class="btn btn-primary fab-button" title="Volver al Detalle de la Caminata">
        <i class="fas fa-arrow-left"></i>
    </a>
</div>
{% endblock %}
