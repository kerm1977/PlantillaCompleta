{% extends 'base.html' %}

{% block title %}Consulta de Usuarios{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="card bg-white rounded-lg border-0 shadow-none">
        <div class="card-body">
            <h1 class="card-title text-center mb-4 text-warning">Consulta de Usuarios</h1>
            <p class="text-center text-muted fst-italic">
                Listado de todos los usuarios registrados en el sistema.
            </p>
            <hr class="my-4">

            <!-- Formulario de búsqueda -->
            <form id="searchForm" class="row g-3 mb-4">
                <div class="col-md-9">
                    <input type="text" class="form-control" id="searchInput" placeholder="Buscar por ID, Nombre, Teléfono o Email...">
                </div>
                <div class="col-md-3 d-flex">
                    <button type="button" class="btn btn-outline-warning" id="sortBtn">
                        Ordenar por ID <i class="bi bi-sort-numeric-down"></i>
                    </button>
                </div>
            </form>

            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="bg-warning text-white">
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Nombre</th>
                            <th scope="col">Teléfono</th>
                            <th scope="col">Email</th>
                            <th scope="col">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        {% if users %}
                            {% for user in users %}
                            <tr>
                                <td>{{ user.id }}</td>
                                <td>{{ user.nombre or user.username }}</td>
                                <td>{{ user.telefono or 'N/A' }}</td>
                                <td>{{ user.email or 'N/A' }}</td>
                                <td>
                                    <div class="d-flex">
                                        <a href="{{ url_for('solicitud.editar_usuario', user_id=user.id) }}" class="btn btn-sm btn-outline-info me-2">Editar</a>
                                        <button class="btn btn-sm btn-outline-danger delete-btn" data-id="{{ user.id }}" data-url="{{ url_for('solicitud.eliminar_usuario', user_id=user.id) }}" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">Eliminar</button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted fst-italic">No hay usuarios registrados.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación de Eliminación 1 -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                ¿Estás seguro de que deseas eliminar este usuario? Esta acción no se puede deshacer.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmFirstDeleteBtn">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación de Eliminación 2 -->
<div class="modal fade" id="confirmSecondDeleteModal" tabindex="-1" aria-labelledby="confirmSecondDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmSecondDeleteModalLabel">¡Advertencia! Confirmación Final</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Esta es la confirmación final.</strong> ¿Estás absolutamente seguro de que deseas eliminar este registro?</p>
                <p class="text-danger">Esta acción es irreversible.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="finalDeleteBtn">Sí, eliminar</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tableBody = document.getElementById('usersTableBody');
        const searchInput = document.getElementById('searchInput');
        const sortBtn = document.getElementById('sortBtn');
        const confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        const confirmSecondDeleteModal = new bootstrap.Modal(document.getElementById('confirmSecondDeleteModal'));
        
        const confirmFirstDeleteBtn = document.getElementById('confirmFirstDeleteBtn');
        const finalDeleteBtn = document.getElementById('finalDeleteBtn');
        
        let sortedAsc = false;
        let userIdToDelete = null;
        let userRowToDelete = null;

        // Búsqueda en la tabla en tiempo real
        searchInput.addEventListener('input', function() {
            const searchTerm = searchInput.value.toLowerCase();
            const rows = tableBody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const rowCells = Array.from(row.cells).slice(0, 4);
                const cellText = rowCells.map(cell => cell.textContent.toLowerCase()).join(' ');
                
                if (cellText.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Ordenamiento por número de ID
        sortBtn.addEventListener('click', function() {
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            
            rows.sort((a, b) => {
                const aId = parseInt(a.cells[0].textContent);
                const bId = parseInt(b.cells[0].textContent);
                return sortedAsc ? aId - bId : bId - aId;
            });
            
            rows.forEach(row => tableBody.appendChild(row));
            
            sortedAsc = !sortedAsc;
            const icon = sortBtn.querySelector('i');
            if (sortedAsc) {
                icon.classList.remove('bi-sort-numeric-down');
                icon.classList.add('bi-sort-numeric-up');
            } else {
                icon.classList.remove('bi-sort-numeric-up');
                icon.classList.add('bi-sort-numeric-down');
            }
        });

        // Lógica para mostrar el primer modal de confirmación
        tableBody.addEventListener('click', function(e) {
            if (e.target.classList.contains('delete-btn')) {
                userIdToDelete = e.target.getAttribute('data-id');
                userRowToDelete = e.target.closest('tr');
                confirmDeleteModal.show();
            }
        });

        // Lógica para mostrar el segundo modal al hacer clic en "Eliminar" en el primer modal
        confirmFirstDeleteBtn.addEventListener('click', function() {
            confirmDeleteModal.hide();
            confirmSecondDeleteModal.show();
        });

        // Lógica final de eliminación al hacer clic en "Sí, eliminar" en el segundo modal
        finalDeleteBtn.addEventListener('click', function() {
            const deleteUrl = userRowToDelete.querySelector('.delete-btn').getAttribute('data-url');
            
            fetch(deleteUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                confirmSecondDeleteModal.hide();
                if (data.success) {
                    if (userRowToDelete) {
                        userRowToDelete.remove();
                        const successAlert = document.createElement('div');
                        successAlert.className = 'alert alert-success mt-3';
                        successAlert.textContent = data.message;
                        document.querySelector('.container').prepend(successAlert);
                        setTimeout(() => successAlert.remove(), 5000);
                    }
                } else {
                    const errorAlert = document.createElement('div');
                    errorAlert.className = 'alert alert-danger mt-3';
                    errorAlert.textContent = data.message;
                    document.querySelector('.container').prepend(errorAlert);
                    setTimeout(() => errorAlert.remove(), 5000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                confirmSecondDeleteModal.hide();
                const errorAlert = document.createElement('div');
                errorAlert.className = 'alert alert-danger mt-3';
                errorAlert.textContent = 'Ocurrió un error al eliminar el usuario.';
                document.querySelector('.container').prepend(errorAlert);
                setTimeout(() => errorAlert.remove(), 5000);
            });
        });
    });
</script>
{% endblock %}
