{% extends 'base.html' %}

{% block title %}Crear Plan de Viaje Internacional{% endblock %}

{% block head_content %}
<style>
    .main-container {
        padding-top: 80px;
        padding-bottom: 80px;
    }
    .section-container {
        margin-bottom: 2.5rem;
        border: 1px solid #dee2e6;
        border-radius: .375rem;
        padding: 1.5rem;
        background-color: #fff;
    }
    .section-header {
        font-weight: bold;
        padding: 0.75rem 1.25rem;
        margin: -1.5rem -1.5rem 1.5rem -1.5rem;
        border-bottom: 1px solid #dee2e6;
        border-top-left-radius: .375rem;
        border-top-right-radius: .375rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .bg-warning {
        background-color: #ffc107 !important;
        color: #000;
    }
    .total-field {
        font-weight: bold;
        font-size: 1.2rem;
        text-align: right;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #dee2e6;
    }
    .dynamic-item {
        border: 1px dashed #ccc;
        padding: 1.5rem;
        padding-top: 2rem;
        margin-bottom: 1rem;
        background-color: #f8f9fa;
        position: relative;
        border-radius: .375rem;
    }
    .item-counter {
        position: absolute;
        top: -12px;
        left: -12px;
        background-color: #ffc107;
        color: black;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        border: 2px solid white;
    }
    .btn-remove-item {
        position: absolute;
        top: 10px;
        right: 10px;
    }
    .details-toggle {
        margin-top: 1rem;
    }
    .fab-container-back {
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 1000;
    }
    .fab-button-back {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        transition: all 0.3s ease;
        background-color: #6c757d;
        color: white;
        border: none;
        text-decoration: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .fab-button-back:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        background-color: #5c636a;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5 mb-5 main-container">
    <h1 class="mb-4 text-center">Crear Nuevo Plan de Viaje Internacional</h1>
    
    <form action="{{ url_for('intern.crear_intern') }}" method="POST" enctype="multipart/form-data">
        
        <!-- SECCIÓN DESTINO -->
        <div class="section-container">
            <div class="section-header bg-warning">DESTINO</div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="nombre_viaje" class="form-label">Nombre del Viaje</label>
                    <input type="text" class="form-control" id="nombre_viaje" name="nombre_viaje" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="flyer_file" class="form-label">Flyer (Imagen)</label>
                    <input type="file" class="form-control" id="flyer_file" name="flyer_file" accept="image/png, image/jpeg, image/gif">
                </div>
            </div>
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label for="precio_paquete" class="form-label">Precio Paquete (por persona)</label>
                    <input type="number" step="0.01" class="form-control" id="precio_paquete" name="precio_paquete" value="0" oninput="updateGrandTotals()">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="capacidad" class="form-label">Capacidad</label>
                    <input type="number" class="form-control" id="capacidad" name="capacidad" value="1">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="tipo_moneda" class="form-label">Tipo de Moneda</label>
                    <select class="form-select" id="tipo_moneda" name="tipo_moneda">
                        <option value="CRC">Colones (CRC)</option>
                        <option value="USD" selected>Dólares (USD)</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3" id="tipo-cambio-wrapper">
                    <label for="tipo_cambio" class="form-label">Tipo de Cambio (a CRC)</label>
                    <input type="number" step="0.01" class="form-control" id="tipo_cambio" name="tipo_cambio" value="500" oninput="updateGrandTotals()">
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="pais" class="form-label">País</label>
                    <select class="form-select" id="pais" name="pais" required>
                        <option value="" disabled selected>Seleccione un destino</option>
                        {% for p in paises %}
                        <option value="{{ p }}">{{ p }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- SECCIÓN PRE-ALERTAS -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>LLAMADO PRE-ALERTA</span>
                <button type="button" class="btn btn-sm btn-dark" onclick="addPreAlerta()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="prealertas-container"></div>
        </div>

        <!-- SECCIÓN LUGARES A VISITAR -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>Atracciones</span>
                 <button type="button" class="btn btn-sm btn-dark" onclick="addLugar()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="lugares-container"></div>
            <div class="total-field">TOTAL DE ATRACCIONES POR PERSONA: <span class="currency-label">USD</span> <span id="total-atracciones">0.00</span></div>
        </div>

        <!-- SECCIÓN TRANSPORTES LOCALES -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>Transportes Locales</span>
                <button type="button" class="btn btn-sm btn-dark" onclick="addTransporte()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="transportes-container"></div>
            <div class="total-field">TOTAL DE TRANSPORTE POR PERSONA: <span class="currency-label">USD</span> <span id="total-transporte">0.00</span></div>
        </div>

        <!-- SECCIÓN GUÍAS -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>Guías</span>
                <button type="button" class="btn btn-sm btn-dark" onclick="addGuia()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="guias-container"></div>
            <div class="total-field">TOTAL DE GUÍAS POR PERSONA: <span class="currency-label">USD</span> <span id="total-guias">0.00</span></div>
        </div>
        
        <!-- SECCIÓN ESTADÍAS -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>Estadías</span>
                <button type="button" class="btn btn-sm btn-dark" onclick="addEstadia()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="estadias-container"></div>
            <div class="total-field">TOTAL DE ESTADÍA POR PERSONA: <span class="currency-label">USD</span> <span id="total-estadia">0.00</span></div>
        </div>

        <!-- SECCIÓN AEROLÍNEA / TRANSPORTE PRINCIPAL -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>Aerolínea / Transporte Principal</span>
                <button type="button" class="btn btn-sm btn-dark" onclick="addAerolinea()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="aerolineas-container"></div>
            <div class="total-field">TOTAL DE TRANSPORTE PRINCIPAL POR PERSONA: <span class="currency-label">USD</span> <span id="total-aerolinea">0.00</span></div>
        </div>

        <!-- SECCIÓN DE TOTALES GENERALES -->
        <div class="section-container text-center">
            <div class="section-header bg-warning justify-content-center">TOTALES GENERALES POR PERSONA</div>
            <div class="row">
                <div class="col-md-6" id="total-crc-wrapper">
                    <p class="total-field" style="border-top: none; text-align: center;">TOTAL INDIVIDUAL (CRC): <span class="badge bg-success fs-5" id="total-crc">0.00</span></p>
                </div>
                <div class="col-md-6" id="total-usd-wrapper">
                    <p class="total-field" style="border-top: none; text-align: center;">TOTAL INDIVIDUAL (USD): <span class="badge bg-primary fs-5" id="total-usd">0.00</span></p>
                </div>
            </div>
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-warning btn-lg">Crear Plan de Viaje</button>
        </div>
    </form>
    
    <!-- Botón Flotante para Volver -->
    <div class="fab-container-back">
        <a href="{{ url_for('intern.index') }}" class="fab-button-back" title="Volver al Listado">
            <i class="fas fa-arrow-left"></i>
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // --- Contadores inicializados para evitar colisiones de ID ---
    let preAlertaCount = 0;
    let lugarCount = 0;
    let transporteCount = 0;
    let guiaCount = 0;
    let estadiaCount = 0;
    let aerolineaCount = 0;
    
    const AEROLINEA_OPTIONS = {{ aerolineas_json|safe }};

    // --- LÓGICA DE MONEDA ---
    const tipoMonedaSelect = document.getElementById('tipo_moneda');
    const tipoCambioWrapper = document.getElementById('tipo-cambio-wrapper');
    const totalCRCWrapper = document.getElementById('total-crc-wrapper');
    const totalUSDWrapper = document.getElementById('total-usd-wrapper');

    function handleCurrencyChange() {
        const selectedCurrency = tipoMonedaSelect.value;
        const priceLabels = document.querySelectorAll('.price-label');
        const currencyLabels = document.querySelectorAll('.currency-label');
        
        if (selectedCurrency === 'USD') {
            tipoCambioWrapper.style.display = 'none';
            totalCRCWrapper.style.display = 'none';
            totalUSDWrapper.classList.remove('col-md-6');
            totalUSDWrapper.classList.add('col-md-12');
        } else {
            tipoCambioWrapper.style.display = 'block';
            totalCRCWrapper.style.display = 'block';
            totalUSDWrapper.classList.add('col-md-6');
            totalUSDWrapper.classList.remove('col-md-12');
        }

        priceLabels.forEach(label => {
            const text = label.innerText.split('(')[0];
            label.innerText = `${text.trim()} (${selectedCurrency})`;
        });
        currencyLabels.forEach(label => label.textContent = selectedCurrency);
        
        updateGrandTotals();
    }

    tipoMonedaSelect.addEventListener('change', handleCurrencyChange);
    
    // --- INICIALIZAR TOTALES Y MONEDA AL CARGAR LA PÁGINA ---
    document.addEventListener('DOMContentLoaded', function() {
        recalculateAllTotals();
        handleCurrencyChange();
    });

    // --- FUNCIONES PARA AÑADIR ELEMENTOS ---
    function addPreAlerta() {
        preAlertaCount++;
        const container = document.getElementById('prealertas-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `prealerta-${preAlertaCount}`;
        newItem.innerHTML = `
            <span class="item-counter">${preAlertaCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('prealerta-${preAlertaCount}')"></button>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Banco</label>
                    <select name="prealerta_banco[]" class="form-select">
                        <option selected disabled>Seleccione un banco</option>
                        {% for banco in bancos %}
                        <option value="{{ banco }}">{{ banco }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Teléfono Entidad Financiera</label>
                    <input type="text" name="prealerta_telefono[]" class="form-control">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Fecha de la prealerta</label>
                    <input type="date" name="prealerta_fecha[]" class="form-control">
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Nombre del Asesor Bancario</label>
                    <input type="text" name="prealerta_asesor[]" class="form-control">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Hora de la Prealerta</label>
                    <input type="time" name="prealerta_hora[]" class="form-control">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Número de la prealerta</label>
                    <input type="text" name="prealerta_numero[]" class="form-control">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Fecha prealertada desde</label>
                    <input type="date" name="prealerta_desde[]" class="form-control">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Fecha prealertada hasta</label>
                    <input type="date" name="prealerta_hasta[]" class="form-control">
                </div>
            </div>
        `;
        container.appendChild(newItem);
    }

    function addLugar() {
        lugarCount++;
        const container = document.getElementById('lugares-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `lugar-${lugarCount}`;
        const currency = tipoMonedaSelect.value;
        newItem.innerHTML = `
            <span class="item-counter">${lugarCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('lugar-${lugarCount}', updateTotalAtracciones)"></button>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Tipo de Lugar</label>
                    <select name="lugar_tipo[]" class="form-select">
                        <option>Volcán</option><option>Montaña</option><option>Playa</option><option>Ciudad</option><option>Parque Nacional</option><option>Camino</option><option>Otros</option>
                    </select>
                </div>
                <div class="col-md-5 mb-3">
                    <label class="form-label">Nombre de Sitio</label>
                    <input type="text" name="lugar_nombre[]" class="form-control">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label price-label">Precio Entrada (por persona) (${currency})</label>
                    <input type="number" step="0.01" name="lugar_precio[]" class="form-control price-atraccion" value="0" oninput="updateTotalAtracciones()">
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary details-toggle" data-bs-toggle="collapse" data-bs-target="#lugar-details-${lugarCount}">
                Más Detalles <i class="fas fa-chevron-down"></i>
            </button>
            <div class="collapse mt-3" id="lugar-details-${lugarCount}">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Fecha de Reserva</label>
                        <input type="date" name="lugar_fecha_reserva[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Teléfono del Lugar</label>
                        <input type="text" name="lugar_telefono_lugar[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Teléfono de Contacto</label>
                        <input type="text" name="lugar_telefono_contacto[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">WhatsApp</label>
                        <input type="text" name="lugar_whatsapp_contacto[]" class="form-control">
                    </div>
                    <div class="col-md-8 mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="lugar_email[]" class="form-control">
                    </div>
                </div>
                 <div class="row">
                    <div class="col-md-12 mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="lugar_guia_local_checkbox" value="lugar-${lugarCount}-guia-local" id="guia-local-check-${lugarCount}" onchange="toggleGuiaLocal(this, 'guia-local-nombre-${lugarCount}')">
                            <label class="form-check-label" for="guia-local-check-${lugarCount}">¿Incluye Guía Local?</label>
                        </div>
                    </div>
                    <div class="col-md-12 mb-3" id="guia-local-nombre-${lugarCount}" style="display: none;">
                        <label class="form-label">Nombre del Guía</label>
                        <input type="text" name="lugar_nombre_guia[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Enlaces de Interés</label>
                        <textarea name="lugar_enlaces[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Notas</label>
                        <textarea name="lugar_nota[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(newItem);
    }
    
    function addTransporte() {
        transporteCount++;
        const container = document.getElementById('transportes-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `transporte-${transporteCount}`;
        const currency = tipoMonedaSelect.value;
        newItem.innerHTML = `
            <span class="item-counter">${transporteCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('transporte-${transporteCount}', updateTotalTransporte)"></button>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Tipo</label>
                    <select name="transporte_tipo[]" class="form-select">
                        <option>Buseta</option><option>Bus</option><option>Taxi</option><option>Uber</option><option>Auto</option><option>Lancha</option><option>Avión</option>
                    </select>
                </div>
                <div class="col-md-5 mb-3">
                    <label class="form-label">Nombre del Transporte</label>
                    <input type="text" name="transporte_nombre[]" class="form-control">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label price-label">Precio Transporte (por persona) (${currency})</label>
                    <input type="number" step="0.01" name="transporte_precio[]" class="form-control price-transporte" value="0" oninput="updateTotalTransporte()">
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary details-toggle" data-bs-toggle="collapse" data-bs-target="#transporte-details-${transporteCount}">
                Más Detalles <i class="fas fa-chevron-down"></i>
            </button>
            <div class="collapse mt-3" id="transporte-details-${transporteCount}">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Nombre del Conductor</label>
                        <input type="text" name="transporte_conductor[]" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Fecha de Contratación</label>
                        <input type="date" name="transporte_fecha_contratacion[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Teléfono del Lugar</label>
                        <input type="text" name="transporte_telefono_lugar[]" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Teléfono del Contacto</label>
                        <input type="text" name="transporte_telefono_contacto[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">WhatsApp del Contacto</label>
                        <input type="text" name="transporte_whatsapp[]" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="transporte_email[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Enlaces</label>
                        <textarea name="transporte_enlaces[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Nota</label>
                        <textarea name="transporte_nota[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(newItem);
    }

    function addGuia() {
        guiaCount++;
        const container = document.getElementById('guias-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `guia-${guiaCount}`;
        const currency = tipoMonedaSelect.value;
        newItem.innerHTML = `
            <span class="item-counter">${guiaCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('guia-${guiaCount}', updateTotalGuias)"></button>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Nombre</label>
                    <input type="text" name="guia_nombre[]" class="form-control">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label price-label">Precio Guía PP (${currency})</label>
                    <input type="number" step="0.01" name="guia_precio_pp[]" class="form-control price-guia-pp" value="0" oninput="updateTotalGuias()">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label price-label">Precio Acarreo (${currency})</label>
                    <input type="number" step="0.01" name="guia_acarreo[]" class="form-control price-guia-acarreo" value="0" oninput="updateTotalGuias()">
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary details-toggle" data-bs-toggle="collapse" data-bs-target="#guia-details-${guiaCount}">
                Más Detalles <i class="fas fa-chevron-down"></i>
            </button>
            <div class="collapse mt-3" id="guia-details-${guiaCount}">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Operador</label>
                        <input type="text" name="guia_operador[]" class="form-control">
                    </div>
                     <div class="col-md-4 mb-3">
                        <label class="form-label">Teléfono</label>
                        <input type="text" name="guia_telefono[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">WhatsApp</label>
                        <input type="text" name="guia_whatsapp[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="guia_email[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">CPL</label>
                        <input type="text" name="guia_cpl[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Fecha Disponible</label>
                        <input type="date" name="guia_fecha_disponible[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Fecha Reserva</label>
                        <input type="date" name="guia_fecha_reserva[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Reserva</label>
                        <input type="text" name="guia_reserva[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Enlaces</label>
                        <textarea name="guia_enlaces[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Nota</label>
                        <textarea name="guia_nota[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(newItem);
    }

    function addEstadia() {
        estadiaCount++;
        const container = document.getElementById('estadias-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `estadia-${estadiaCount}`;
        const currency = tipoMonedaSelect.value;
        newItem.innerHTML = `
            <span class="item-counter">${estadiaCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('estadia-${estadiaCount}', updateTotalEstadia)"></button>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Nombre</label>
                    <input type="text" name="estadia_nombre[]" class="form-control">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Tipo de Estadía</label>
                    <select name="estadia_tipo[]" class="form-select">
                        <option>Hotel</option><option>Hostel</option><option>Airbnb</option><option>Casa/Apto</option><option>Otro</option>
                    </select>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label price-label">Precio PP Noche (${currency})</label>
                    <input type="number" step="0.01" name="estadia_precio_pp[]" class="form-control price-estadia-pp" value="0" oninput="updateTotalEstadia()">
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label"># Noches</label>
                    <input type="number" name="estadia_noches[]" class="form-control noches-estadia" value="1" oninput="updateTotalEstadia()">
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary details-toggle" data-bs-toggle="collapse" data-bs-target="#estadia-details-${estadiaCount}">
                Más Detalles <i class="fas fa-chevron-down"></i>
            </button>
            <div class="collapse mt-3" id="estadia-details-${estadiaCount}">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Fecha Check-in</label>
                        <input type="date" name="estadia_checkin[]" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Fecha Check-out</label>
                        <input type="date" name="estadia_checkout[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Teléfono del Lugar</label>
                        <input type="text" name="estadia_telefono_lugar[]" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Teléfono de Contacto</label>
                        <input type="text" name="estadia_telefono_contacto[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">WhatsApp</label>
                        <input type="text" name="estadia_whatsapp[]" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="estadia_email[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                     <div class="col-md-12 mb-3">
                        <label class="form-label">Número de Reserva</label>
                        <input type="text" name="estadia_reserva[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Enlaces</label>
                        <textarea name="estadia_enlaces[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Nota</label>
                        <textarea name="estadia_nota[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(newItem);
    }

    function addAerolinea() {
        aerolineaCount++;
        const container = document.getElementById('aerolineas-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `aerolinea-${aerolineaCount}`;
        const currency = tipoMonedaSelect.value;

        // Create options for the airline select
        let aerolineaOptions = AEROLINEA_OPTIONS.map(name => `<option value="${name}">${name}</option>`).join('');

        newItem.innerHTML = `
            <span class="item-counter">${aerolineaCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('aerolinea-${aerolineaCount}', updateTotalAerolinea)"></button>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Tipo de Transporte</label>
                    <select name="aerolinea_tipo_transporte[]" class="form-select tipo-transporte-aerolinea" onchange="toggleAerolineaFields(this)">
                        <option>Avión</option><option>Bus</option><option>Buseta</option><option>Auto</option><option>Moto</option><option>Barco</option>
                    </select>
                </div>
                <div class="col-md-8 mb-3 aerolinea-field-group">
                    <label class="form-label">Aerolínea / Compañía</label>
                    <select name="aerolinea_nombre[]" class="form-select">
                        <option value="" disabled selected>Seleccione una aerolínea</option>
                        ${aerolineaOptions}
                        <option value="Otra">Otra</option>
                    </select>
                </div>
            </div>

            <div class="aerolinea-details-wrapper">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Teléfono Aerolínea</label>
                        <input type="text" name="aerolinea_telefono[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="aerolinea_email[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">WhatsApp</label>
                        <input type="text" name="aerolinea_whatsapp[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Teléfono de Pre-alerta</label>
                        <input type="text" name="aerolinea_tel_prealerta[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Fecha Pre-alerta</label>
                        <input type="date" name="aerolinea_fecha_prealerta[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Enlace para Pre-alertar</label>
                        <input type="text" name="aerolinea_enlace_prealerta[]" class="form-control">
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Número de Vuelo</label>
                        <input type="text" name="aerolinea_vuelo[]" class="form-control">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Horario de Salida</label>
                        <input type="datetime-local" name="aerolinea_salida[]" class="form-control">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Horario de Llegada</label>
                        <input type="datetime-local" name="aerolinea_llegada[]" class="form-control">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Fecha de Compra</label>
                        <input type="date" name="aerolinea_fecha_compra[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Nombre del Aeropuerto</label>
                        <input type="text" name="aerolinea_aeropuerto[]" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Teléfono del Aeropuerto</label>
                        <input type="text" name="aerolinea_tel_aeropuerto[]" class="form-control">
                    </div>
                </div>
                <hr>
                <h6>Precios y Tarifas (por persona)</h6>
                <div class="row">
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Precio Asientos</label><input type="number" step="0.01" name="aerolinea_precio_asientos[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Precio Maletas Doc.</label><input type="number" step="0.01" name="aerolinea_precio_maletas[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Equipaje de Mano</label><input type="number" step="0.01" name="aerolinea_equipaje_mano[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Precio Impuestos</label><input type="number" step="0.01" name="aerolinea_impuestos[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Precio Estandar</label><input type="number" step="0.01" name="aerolinea_precio_estandar[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Precio Mas Equipo</label><input type="number" step="0.01" name="aerolinea_precio_equipo[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Precio Salida Rápida</label><input type="number" step="0.01" name="aerolinea_precio_salida_rapida[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Precio Premium</label><input type="number" step="0.01" name="aerolinea_precio_premium[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Precio VIP</label><input type="number" step="0.01" name="aerolinea_precio_vip[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Precio Basic</label><input type="number" step="0.01" name="aerolinea_precio_basic[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Precio Classic</label><input type="number" step="0.01" name="aerolinea_precio_classic[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Precio Flexible</label><input type="number" step="0.01" name="aerolinea_precio_flexible[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                </div>
                <hr>
                <h6>Otros Costos Adicionales (por persona)</h6>
                ${[1,2,3,4].map(i => `
                <div class="row align-items-end">
                    <div class="col-md-6 mb-3"><label class="form-label">Descripción #${i}</label><input type="text" name="aerolinea_otro_desc_${i}[]" class="form-control"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Costo #${i}</label><input type="number" step="0.01" name="aerolinea_otro_costo_${i}[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label">Cantidad</label><input type="number" name="aerolinea_otro_cant_${i}[]" class="form-control" value="1" oninput="updateTotalAerolinea()"></div>
                </div>
                `).join('')}
            </div>
        `;
        container.appendChild(newItem);
        toggleAerolineaFields(newItem.querySelector('.tipo-transporte-aerolinea'));
    }

    function removeItem(id, callback) {
        const item = document.getElementById(id);
        if (item) {
            item.remove();
            if (callback) {
                callback();
            }
        }
    }

    function toggleGuiaLocal(checkbox, divId) {
        const div = document.getElementById(divId);
        if (checkbox.checked) {
            div.style.display = 'block';
        } else {
            div.style.display = 'none';
        }
    }
    
    function toggleAerolineaFields(selectElement) {
        const parentItem = selectElement.closest('.dynamic-item');
        const detailsWrapper = parentItem.querySelector('.aerolinea-details-wrapper');
        if (selectElement.value === 'Avión') {
            detailsWrapper.style.display = 'block';
        } else {
            detailsWrapper.style.display = 'none';
        }
        updateTotalAerolinea();
    }

    // --- FUNCIONES PARA ACTUALIZAR TOTALES ---
    function recalculateAllTotals() {
        updateTotalAtracciones();
        updateTotalTransporte();
        updateTotalGuias();
        updateTotalEstadia();
        updateTotalAerolinea();
    }

    function updateTotalAtracciones() {
        let total = 0;
        document.querySelectorAll('.price-atraccion').forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        document.getElementById('total-atracciones').textContent = total.toFixed(2);
        updateGrandTotals();
    }
    
    function updateTotalTransporte() {
        let total = 0;
        document.querySelectorAll('.price-transporte').forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        document.getElementById('total-transporte').textContent = total.toFixed(2);
        updateGrandTotals();
    }

    function updateTotalGuias() {
        let total = 0;
        document.querySelectorAll('.dynamic-item[id^="guia-"]').forEach(item => {
            const precioPP = parseFloat(item.querySelector('.price-guia-pp').value) || 0;
            const acarreo = parseFloat(item.querySelector('.price-guia-acarreo').value) || 0;
            total += precioPP + acarreo;
        });
        document.getElementById('total-guias').textContent = total.toFixed(2);
        updateGrandTotals();
    }

    function updateTotalEstadia() {
        let total = 0;
        document.querySelectorAll('.dynamic-item[id^="estadia-"]').forEach(item => {
            const precioPP = parseFloat(item.querySelector('.price-estadia-pp').value) || 0;
            const noches = parseInt(item.querySelector('.noches-estadia').value) || 1;
            total += precioPP * noches;
        });
        document.getElementById('total-estadia').textContent = total.toFixed(2);
        updateGrandTotals();
    }

    function updateTotalAerolinea() {
        let total = 0;
        document.querySelectorAll('.dynamic-item[id^="aerolinea-"]').forEach(item => {
            const tipo = item.querySelector('.tipo-transporte-aerolinea').value;
            if (tipo !== 'Avión') return;

            // Sumar todos los precios de tarifas
            item.querySelectorAll('.price-aerolinea').forEach(input => {
                total += parseFloat(input.value) || 0;
            });

            // Sumar otros costos (costo * cantidad)
            for (let i = 1; i <= 4; i++) {
                const costo = parseFloat(item.querySelector(`[name="aerolinea_otro_costo_${i}[]"]`).value) || 0;
                const cant = parseInt(item.querySelector(`[name="aerolinea_otro_cant_${i}[]"]`).value) || 0;
                total += costo * cant;
            }
        });
        document.getElementById('total-aerolinea').textContent = total.toFixed(2);
        updateGrandTotals();
    }
    
    function updateGrandTotals() {
        const precioPaquete = parseFloat(document.getElementById('precio_paquete').value) || 0;
        const totalAtracciones = parseFloat(document.getElementById('total-atracciones').textContent) || 0;
        const totalTransporte = parseFloat(document.getElementById('total-transporte').textContent) || 0;
        const totalGuias = parseFloat(document.getElementById('total-guias').textContent) || 0;
        const totalEstadia = parseFloat(document.getElementById('total-estadia').textContent) || 0;
        const totalAerolinea = parseFloat(document.getElementById('total-aerolinea').textContent) || 0;
        
        const total = precioPaquete + totalAtracciones + totalTransporte + totalGuias + totalEstadia + totalAerolinea;
        const tipoCambio = parseFloat(document.getElementById('tipo_cambio').value) || 1;
        
        if (tipoMonedaSelect.value === 'USD') {
            document.getElementById('total-crc').textContent = (total * tipoCambio).toFixed(2);
            document.getElementById('total-usd').textContent = total.toFixed(2);
        } else { // CRC
            const totalUSD = total / tipoCambio;
            document.getElementById('total-crc').textContent = total.toFixed(2);
            document.getElementById('total-usd').textContent = totalUSD.toFixed(2);
        }
    }
</script>
{% endblock %}
