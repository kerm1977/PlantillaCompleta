<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturador y Planificador</title>
    
    <!-- Bulma CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- HTML to Canvas library for exporting images -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Manifest y Service Worker para PWA -->
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIkhlcnJhbWllbnRhIGRlIENvdGl6YWNpw7NuIiwKICAic2hvcnRfbmFtZSI6ICJDdWFkcm8gQXBwIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9wbGFjZWhvbGQuY28vMTkyeDE5Mi8zMTgzOTgvZmZmZmZmP3RleHQ9QXBwIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiCiAgICB9LAogICAgewogICAgICAic3JjIjogImh0dHBzOi8vcGxhY2Vob2xkLmNvLzUxMng1MTIvMzE4Mzk4L2ZmZmZmZj90ZXh0PUFwcCIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIgogICAgfQogIF0sCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAidGhlbWVfY29sb3IiOiAiIzMxODM5OCIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIKfQo=">
    <script>
        if ('serviceWorker' in navigator) {
            const swContent = `
                const CACHE_NAME = 'cuadro-app-cache-v1';
                const urlsToCache = ['./', './index.html'];
                self.addEventListener('install', event => {
                    event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache)));
                });
                self.addEventListener('fetch', event => {
                    event.respondWith(caches.match(event.request).then(response => response || fetch(event.request)));
                });
            `;
            const swBlob = new Blob([swContent], { type: 'application/javascript' });
            navigator.serviceWorker.register(URL.createObjectURL(swBlob))
                .then(registration => console.log('ServiceWorker registration successful.'))
                .catch(err => console.log('ServiceWorker registration failed: ', err));
        }
    </script>
    
    <!-- Meta tags para PWA en iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cuadro App">

    <style>
        /* Estilos personalizados y para impresión */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .input.is-warning, .select.is-warning select {
            border-color: #ffdd57;
        }
        .input.is-warning:focus, .select.is-warning select:focus,
        .input.is-warning:active, .select.is-warning select:active {
            border-color: #ffdd57;
            box-shadow: 0 0 0 0.125em rgba(255, 221, 87, 0.25);
        }

        .floating-buttons {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            z-index: 10;
            gap: 0.75rem;
        }
        .floating-buttons .button {
            border-radius: 50%;
            width: 56px;
            height: 56px;
        }
        .floating-buttons .button .icon {
            font-size: 1.5rem;
        }

        .item-block {
            border-bottom: 1px solid #ffdd57;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            padding-top: 0.5rem;
        }
        .item-block.is-locked {
            opacity: 0.7;
        }

        /* Estilos para la tarjeta de historial tipo "mini-factura" */
        .invoice-card {
            border: 1px solid #dbdbdb;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 1rem;
            background-color: #fff;
        }
        .invoice-header {
            background-color: #fff5e6; /* Color naranja claro */
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #dbdbdb;
        }
        .invoice-header .title {
            margin-bottom: 0;
        }
        .invoice-header .heading {
            margin-bottom: 0.25rem;
        }
        .invoice-body {
            padding: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        .invoice-items-list {
            padding: 0 1rem 0.5rem 1rem;
            border-top: 1px solid #f5f5f5;
        }
        .invoice-footer {
            background-color: #fff5e6; /* Color naranja claro */
            padding: 0.75rem 1rem;
            border-top: 1px solid #dbdbdb;
            display: flex;
            justify-content: flex-end;
        }
        .invoice-footer-totals {
            text-align: right;
        }
        .invoice-footer .faltante-display {
            font-weight: bold;
            font-size: 1rem;
        }
        .is-cancelado {
            color: #48c78e; /* Bulma's success color */
            font-weight: bold;
        }
        .has-text-danger {
            color: #f14668 !important;
        }
        /* Estilos para la sección "Faltante" del formulario principal */
        .faltante-label {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .faltante-value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            #printable-invoice-section, #printable-invoice-section * {
                visibility: visible;
            }
            #printable-invoice-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body>

    <section class="section">
        <div class="container">
            <header class="has-text-centered mb-6 no-print">
                <h1 class="title is-1 is-warning">FACTURAS</h1>
                <p class="subtitle is-5">La Tribu de Los Libres</p>
                <div class="buttons is-centered">
                    <button onclick="backupData()" class="button is-warning is-outlined">Respaldar Datos</button>
                    <button onclick="triggerRestore()" class="button is-success is-outlined">Restaurar Datos</button>
                    <input type="file" id="restore-input" class="is-hidden" accept="application/json" onchange="handleFileSelect(event)">
                </div>
            </header>

            <div class="tabs is-centered no-print">
                <ul>
                    <li class="is-active" data-tab="invoices"><a onclick="showTab('invoices', this)">Facturas</a></li>
                    <li data-tab="planning"><a onclick="showTab('planning', this)">Planificación</a></li>
                </ul>
            </div>

            <main>
                <div id="invoices" class="tab-content">
                    <div id="printable-invoice-section">
                        <div id="invoice-form-container">
                             <div class="is-flex is-justify-content-center is-align-items-center mb-5">
                                <h2 class="title is-4 mb-0 has-text-centered has-text-warning">Nueva Factura</h2>
                                <button id="enable-edit-button" class="button is-small is-light ml-4 is-hidden" onclick="enableFormEditing()" title="Editar Cabecera">
                                    <span class="icon"><i class="fas fa-pen"></i></span>
                                </button>
                            </div>
                            <div id="print-area-invoices">
                                <div class="mb-5">
                                    <p >Llenar esta información de la caminanta para poder hacer la factura.</p>
                                      <hr>
                                    <div class="columns mt-5">

                                        <div class="column">
                                            <label for="invoice-client" class="label">Nombre del Caminante</label>
                                            <div class="control">
                                                <input type="text" id="invoice-client" class="input is-warning" placeholder="Nombre del Caminante">
                                            </div>
                                        </div>
                                        <div class="column">
                                            <label for="invoice-date" class="label">Fecha de Caminata</label>
                                            <div class="control">
                                                <input type="date" id="invoice-date" class="input is-warning">
                                            </div>
                                        </div>
                                        <div class="column">
                                            <label for="invoice-currency" class="label">Moneda</label>
                                            <div class="control">
                                                <div class="select is-fullwidth is-warning">
                                                    <select id="invoice-currency">
                                                        <option value="USD">Dólares (USD)</option>
                                                        <option value="CRC">Colones (CRC)</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="columns">
                                        <div class="column">
                                            <label for="invoice-event-name" class="label">Nombre de Evento</label>
                                            <div class="control">
                                                <input type="text" id="invoice-event-name" class="input is-warning" placeholder="caminata">
                                            </div>
                                        </div>
                                        <div class="column">
                                            <label for="invoice-event-price" class="label">Precio de Evento</label>
                                            <div class="control">
                                                <input type="number" id="invoice-event-price" class="input is-warning" placeholder="0">
                                            </div>
                                        </div>
                                    </div>
                                    <div id="invoice-exchange-rate-container" class="columns">
                                        <div class="column">
                                            <label for="invoice-exchange-rate" class="label">Tipo de Cambio</label>
                                            <div class="control">
                                                <input type="number" id="invoice-exchange-rate" class="input is-warning" placeholder="500">
                                            </div>
                                        </div>
                                        <div class="column is-flex is-align-items-flex-end">
                                            <span id="invoice-tc-result" class="is-size-7 has-text-grey"></span>
                                        </div>
                                    </div>
                                </div>
                               <div id="invoice-items" class="mb-4"></div>
                                <div class="columns is-flex is-justify-content-flex-end mt-4">
                                    <div class="column is-4">
                                        <div class="is-flex is-justify-content-space-between py-1"><span>Subtotal</span><span id="invoice-subtotal">$0</span></div>
                                        <div class="is-flex is-justify-content-space-between is-align-items-center py-1">
                                            <label class="checkbox">
                                                <input id="invoice-tax-toggle" type="checkbox" class="mr-2"> Impuestos (13%)
                                            </label>
                                            <span id="invoice-tax">$0</span>
                                        </div>
                                        <div class="is-flex is-justify-content-space-between py-1 has-text-weight-medium"><span>Faltante</span><span id="invoice-faltante">$0</span></div>
                                        <hr class="my-2">
                                        <div class="is-flex is-justify-content-space-between has-text-weight-bold is-size-5"><span>Total</span><span id="invoice-total">$0</span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="buttons is-right mt-5 no-print">
                                <button onclick="clearForm('invoice')" class="button">Limpiar</button>
                                <button onclick="printContent('printable-invoice-section')" class="button is-warning">Imprimir / PDF</button>
                            </div>
                        </div>
                         <div class="mt-6 pt-5 border-t no-print">
                            <div class="level">
                                <div class="level-left">
                                    <h3 class="title is-5">Historial de Facturas</h3>
                                </div>
                            </div>
                             
                            <!-- Search Bar -->
                            <div class="field mb-4">
                                <div class="control has-icons-left">
                                    <input type="text" id="search-input" class="input is-warning" oninput="filterHistory()" placeholder="Buscar por nombre, evento o fecha...">
                                    <span class="icon is-small is-left">
                                        <i class="fas fa-search"></i>
                                    </span>
                                </div>
                            </div>

                            <div id="invoice-history" class="space-y-4"></div>
                        </div>
                    </div>
                    <div class="floating-buttons no-print">
                        <button id="add-item-invoice" onclick="addItem('invoice')" class="button is-link" disabled title="Agregar línea"><span class="icon"><i class="fas fa-plus"></i></span></button>
                        <button id="whatsapp-share-button" onclick="shareViaWhatsApp('invoice')" class="button is-success" title="Compartir por WhatsApp" disabled><span class="icon"><i class="fab fa-whatsapp"></i></span></button>
                        <button id="save-invoice-floating" onclick="saveInvoice()" class="button is-primary" title="Guardar" disabled><span class="icon"><i class="fas fa-save"></i></span></button>
                    </div>
                </div>

                <div id="planning" class="tab-content is-hidden">
                     <h2 class="title is-4 mb-5">Planificador de Tareas</h2>
                    <div class="field is-grouped">
                        <div class="control is-expanded">
                            <input type="text" id="new-task-input" class="input is-warning" placeholder="Escribe una nueva tarea...">
                        </div>
                        <div class="control">
                            <button onclick="addTask()" class="button is-link">Agregar</button>
                        </div>
                    </div>
                    <ul id="task-list" class="mt-4"></ul>
                </div>
            </main>
        </div>
    </section>

    <script>
    (function() {
        let invoiceHistory = [];
        let lastRegistrationNumber;
        let descriptionToInherit = null;
        let currentlyUpdatingIndex = null;
        
        function formatCurrency(amount, currency = 'USD') {
            const locale = currency === 'CRC' ? 'es-CR' : 'en-US';
            return new Intl.NumberFormat(locale, { 
                style: 'currency', 
                currency,
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
        
        function updateTotals() {
            const type = 'invoice';
            const itemsContainer = document.getElementById(`${type}-items`);
            if (!itemsContainer) return;

            const clientInput = document.getElementById(`${type}-client`);
            const dateInput = document.getElementById(`${type}-date`);
            const eventNameInput = document.getElementById(`${type}-event-name`);
            const eventPriceInput = document.getElementById(`${type}-event-price`);
            const addItemButton = document.getElementById(`add-item-${type}`);
            const saveButton = document.getElementById(`save-${type}-floating`);
            const whatsappButton = document.getElementById('whatsapp-share-button');

            const isFormValid = clientInput.value.trim() !== '' &&
                              dateInput.value.trim() !== '' &&
                              eventNameInput.value.trim() !== '' &&
                              parseFloat(eventPriceInput.value) > 0;

            if (addItemButton) addItemButton.disabled = !isFormValid;
            if (whatsappButton) whatsappButton.disabled = !isFormValid;

            // Save button logic
            let canSave = isFormValid;
            const currentItems = itemsContainer.querySelectorAll('.item-block');
            const currentItemCount = currentItems.length;
            
            if (currentlyUpdatingIndex !== null) {
                const originalItemCount = invoiceHistory[currentlyUpdatingIndex].items.length;
                canSave = canSave && (currentItemCount > originalItemCount);
            } else {
                canSave = canSave && (currentItemCount > 0);
            }

            // Check if the last item (the new one) has a price
            if (currentItemCount > 0) {
                 const lastItem = currentItems[currentItemCount - 1];
                 const priceInput = lastItem.querySelector('.item-price');
                 if (!priceInput.disabled && (priceInput.value.trim() === '' || parseFloat(priceInput.value) <= 0)) {
                     canSave = false;
                 }
            }


            if (saveButton) saveButton.disabled = !canSave;


            const currencySelect = document.getElementById(`${type}-currency`);
            const currency = currencySelect ? currencySelect.value : 'USD';
            
            const taxToggle = document.getElementById(`${type}-tax-toggle`);
            const taxEnabled = taxToggle ? taxToggle.checked : false;

            const exchangeRateContainer = document.getElementById(`${type}-exchange-rate-container`);
            const exchangeRateInput = document.getElementById(`${type}-exchange-rate`);
            const tcResultEl = document.getElementById(`${type}-tc-result`);
            const eventPrice = eventPriceInput ? parseFloat(eventPriceInput.value) || 0 : 0;

            if (currency === 'USD') {
                exchangeRateContainer.style.display = '';
                const exchangeRate = parseFloat(exchangeRateInput.value) || 0;
                if (eventPrice > 0 && exchangeRate > 0) {
                    const totalInCRC = eventPrice * exchangeRate;
                    tcResultEl.textContent = `T.C. = ${formatCurrency(totalInCRC, 'CRC')}`;
                } else {
                    tcResultEl.textContent = '';
                }
            } else {
                exchangeRateContainer.style.display = 'none';
                exchangeRateInput.value = '';
                tcResultEl.textContent = '';
            }

            let subtotal = 0;
            itemsContainer.querySelectorAll('.item-block').forEach(block => {
                const qtyInput = block.querySelector('.item-qty');
                const priceInput = block.querySelector('.item-price');
                const totalCell = block.querySelector('.item-total');

                if (qtyInput && priceInput && totalCell) {
                    const qty = parseFloat(qtyInput.value) || 0;
                    const price = parseFloat(priceInput.value) || 0;
                    const total = qty * price;
                    totalCell.textContent = formatCurrency(total, currency);
                    subtotal += total;
                }
            });
            
            const faltante = eventPrice - subtotal;
            const faltanteEl = document.getElementById(`${type}-faltante`);
            const totalsContainer = faltanteEl.closest('.column');
            let excedenteEl = totalsContainer.querySelector('.excedente-display');

            if (excedenteEl) {
                excedenteEl.remove();
            }

            if (faltante < 0) { // Excedente
                const excedente = -faltante;
                faltanteEl.textContent = 'CANCELADO';
                faltanteEl.classList.add('is-cancelado');

                excedenteEl = document.createElement('div');
                excedenteEl.className = 'is-flex is-justify-content-space-between py-1 has-text-danger has-text-weight-bold excedente-display';
                excedenteEl.innerHTML = `<span>Excedente (Revisar)</span><span>${formatCurrency(excedente, currency)}</span>`;
                faltanteEl.parentElement.insertAdjacentElement('afterend', excedenteEl);

            } else { // No excedente
                if (faltante <= 0 && eventPrice > 0) {
                    faltanteEl.textContent = 'CANCELADO';
                    faltanteEl.classList.add('is-cancelado');
                } else {
                    faltanteEl.textContent = formatCurrency(faltante, currency);
                    faltanteEl.classList.remove('is-cancelado');
                }
            }


            const taxRate = 0.13;
            let tax = 0;
            if (taxEnabled) {
                tax = subtotal * taxRate;
            }
            
            const total = subtotal + tax;

            document.getElementById(`${type}-subtotal`).textContent = formatCurrency(subtotal, currency);
            document.getElementById(`${type}-tax`).textContent = formatCurrency(tax, currency);
            document.getElementById(`${type}-total`).textContent = formatCurrency(total, currency);
        }

        function clearForm(type) {
            toggleMainFormLock(false);
            document.getElementById(`${type}-client`).value = '';
            document.getElementById(`${type}-date`).value = '';
            document.getElementById(`${type}-event-name`).value = '';
            document.getElementById(`${type}-event-price`).value = '';
            document.getElementById(`${type}-items`).innerHTML = '';
            if (document.getElementById(`${type}-exchange-rate`)) {
                document.getElementById(`${type}-exchange-rate`).value = '';
            }
            descriptionToInherit = null;
            currentlyUpdatingIndex = null;
            updateTotals();
        }
        
        function saveInvoice() {
            const type = 'invoice';
            
            const newItems = [];
            document.getElementById(`${type}-items`).querySelectorAll('.item-block').forEach(block => {
                newItems.push({
                    type: block.querySelector('select').value,
                    description: block.querySelector('input[type="text"]').value,
                    qty: block.querySelector('.item-qty').value,
                    paymentDate: block.querySelector('.item-payment-date').value,
                    price: block.querySelector('.item-price').value,
                });
            });

            const formData = {
                type: newItems.length > 0 ? newItems[0].type : 'N/A',
                client: document.getElementById(`${type}-client`).value,
                date: document.getElementById(`${type}-date`).value,
                currency: document.getElementById(`${type}-currency`).value,
                eventName: document.getElementById(`${type}-event-name`).value,
                eventPrice: document.getElementById(`${type}-event-price`).value,
                exchangeRate: document.getElementById(`${type}-exchange-rate`) ? document.getElementById(`${type}-exchange-rate`).value : null,
                taxEnabled: document.getElementById(`${type}-tax-toggle`).checked,
                items: newItems,
                subtotal: document.getElementById(`${type}-subtotal`).textContent,
                tax: document.getElementById(`${type}-tax`).textContent,
                faltante: document.getElementById(`${type}-faltante`).textContent,
                total: document.getElementById(`${type}-total`).textContent,
            };

            if (currentlyUpdatingIndex !== null) {
                // --- UPDATE LOGIC ---
                const recordToUpdate = invoiceHistory[currentlyUpdatingIndex];
                formData.registrationNumber = recordToUpdate.registrationNumber;
                invoiceHistory[currentlyUpdatingIndex] = formData;
            } else {
                // --- CREATE NEW LOGIC ---
                lastRegistrationNumber++;
                formData.registrationNumber = String(lastRegistrationNumber).padStart(5, '0');
                localStorage.setItem('lastRegistrationNumber', lastRegistrationNumber);
                invoiceHistory.push(formData);
            }

            localStorage.setItem('invoiceHistory', JSON.stringify(invoiceHistory));
            filterHistory(); // Re-render with filter applied
            clearForm(type);
        }

        function renderHistory(historyToRender = invoiceHistory) {
            const type = 'invoice';
            const historyBody = document.getElementById(`${type}-history`);
            historyBody.innerHTML = '';

            const parseCurrency = (str) => {
                if (typeof str !== 'string') return 0;
                return parseFloat(str.replace(/[^\d.-]/g, '')) || 0;
            };

            historyToRender.forEach((record) => {
                const originalIndex = invoiceHistory.findIndex(item => item.registrationNumber === record.registrationNumber);

                const recordEl = document.createElement('div');
                recordEl.id = `record-${originalIndex}`;
                recordEl.className = `invoice-card`;
                
                const subtotalNum = parseCurrency(record.subtotal);
                const eventPriceNum = parseCurrency(record.eventPrice);
                let excedenteHtml = '';
                let faltanteDisplay;

                if (subtotalNum > eventPriceNum) {
                    const excedente = subtotalNum - eventPriceNum;
                    faltanteDisplay = `<span class="is-cancelado">CANCELADO</span>`;
                    excedenteHtml = `<div class="has-text-danger has-text-weight-bold mt-1">Excedente (Revisar): ${formatCurrency(excedente, record.currency)}</div>`;
                } else if (record.faltante.toUpperCase() === 'CANCELADO' || parseCurrency(record.faltante) <= 0) {
                    faltanteDisplay = `<span class="is-cancelado">CANCELADO</span>`;
                } else {
                    faltanteDisplay = `<span>${record.faltante}</span>`;
                }

                const itemsHtml = record.items.length > 0 
                    ? `<div class="invoice-items-list content is-small">
                           <p class="has-text-weight-semibold">Abonos:</p>
                           <ul>
                               ${record.items.map(item => `<li>${item.type} (${item.paymentDate}): ${item.description} - ${formatCurrency(parseFloat(item.price), record.currency)}</li>`).join('')}
                           </ul>
                       </div>` 
                    : '';

                recordEl.innerHTML = `
                    <header class="invoice-header">
                        <div class="level is-mobile">
                            <div class="level-left">
                                <div>
                                    <p class="heading is-size-7">Registro</p>
                                    <p class="title is-6">${record.registrationNumber}</p>
                                </div>
                            </div>
                            <div class="level-right">
                                <div class="buttons">
                                   <button onclick="exportAndShareRecord(${originalIndex})" class="button is-light no-print" title="Exportar como Imagen"><span class="icon"><i class="fas fa-image fa-lg"></i></span></button>
                                   <button onclick="loadFromHistory(${originalIndex})" class="button is-light no-print" title="Actualizar"><span class="icon"><i class="fas fa-edit"></i></span></button>
                                   <button onclick="handleDeleteClick(event)" data-index="${originalIndex}" class="delete-btn button is-danger is-light no-print">Borrar</button>
                                </div>
                            </div>
                        </div>
                    </header>
                    <div class="invoice-body">
                        <div><strong>Caminante:</strong> ${record.client}</div>
                        <div><strong>Fecha:</strong> ${record.date}</div>
                        <div><strong>Evento:</strong> ${record.eventName}</div>
                        <div><strong>Precio:</strong> ${formatCurrency(parseFloat(record.eventPrice) || 0, record.currency)}</div>
                    </div>
                    ${itemsHtml}
                    <footer class="invoice-footer">
                        <div class="invoice-footer-totals">
                            <div class="is-size-6 has-text-weight-bold">Total Abonado: ${record.subtotal}</div>
                            <div class="faltante-display">
                                <strong>Faltante: </strong> ${faltanteDisplay}
                            </div>
                            ${excedenteHtml}
                        </div>
                    </footer>
                `;
                historyBody.appendChild(recordEl);
            });
        }
        
        function toggleMainFormLock(locked) {
            const formContainer = document.getElementById('invoice-form-container');
            formContainer.querySelectorAll('#invoice-client, #invoice-date, #invoice-currency, #invoice-event-name, #invoice-event-price, #invoice-exchange-rate, #invoice-tax-toggle').forEach(el => {
                el.disabled = locked;
            });
            const editButton = document.getElementById('enable-edit-button');
            if (locked) {
                editButton.classList.remove('is-hidden');
            } else {
                editButton.classList.add('is-hidden');
            }
        }

        function enableFormEditing() {
            toggleMainFormLock(false);
        }

        function loadFromHistory(index) {
            const type = 'invoice';
            const history = invoiceHistory;
            if (index >= history.length) return;

            const record = history[index];
            const clientInput = document.getElementById(`${type}-client`);
            
            toggleMainFormLock(true);

            clientInput.value = record.client;
            document.getElementById(`${type}-date`).value = record.date;
            document.getElementById(`${type}-currency`).value = record.currency;
            document.getElementById(`${type}-event-name`).value = record.eventName;
            document.getElementById(`${type}-event-price`).value = record.eventPrice;
            if (document.getElementById(`${type}-exchange-rate`)) {
                 document.getElementById(`${type}-exchange-rate`).value = record.exchangeRate;
            }
            document.getElementById(`${type}-tax-toggle`).checked = record.taxEnabled;
            
            currentlyUpdatingIndex = index;

            if (record.items.length > 0) {
                descriptionToInherit = record.items[0].description;
            } else {
                descriptionToInherit = null;
            }

            const itemsContainer = document.getElementById(`${type}-items`);
            itemsContainer.innerHTML = '';
            record.items.forEach(item => {
                const newBlock = addItem(type, false, true); // Add item and lock it
                newBlock.querySelector('select').value = item.type;
                newBlock.querySelector('input[type="text"]').value = item.description;
                newBlock.querySelector('.item-qty').value = item.qty;
                newBlock.querySelector('.item-payment-date').value = item.paymentDate;
                newBlock.querySelector('.item-price').value = item.price;
            });

            updateTotals();
            
            clientInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            clientInput.focus();
        }

        function handleDeleteClick(event) {
            const btn = event.target.closest('.delete-btn');
            if (!btn) return;

            const confirmStep = btn.dataset.confirmStep || '0';

            switch (confirmStep) {
                case '0':
                    resetDeleteButtons();
                    btn.textContent = '¿Seguro?';
                    btn.dataset.confirmStep = '1';
                    break;
                case '1':
                    btn.textContent = '¡Eliminar!';
                    btn.dataset.confirmStep = '2';
                    break;
                case '2':
                    const index = parseInt(btn.dataset.index, 10);
                    invoiceHistory.splice(index, 1);
                    localStorage.setItem('invoiceHistory', JSON.stringify(invoiceHistory));
                    filterHistory();
                    break;
            }
        }

        function resetDeleteButtons() {
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.textContent = 'Borrar';
                button.dataset.confirmStep = '0';
            });
        }

        function addItem(type, focus = true, isLocked = false) {
            const itemsContainer = document.getElementById(`${type}-items`);
            if (!itemsContainer) return;

            const lastItem = itemsContainer.querySelector('.item-block:last-child');
            if (lastItem) {
                const descriptionInput = lastItem.querySelector('input[type="text"]');
                const priceInput = lastItem.querySelector('.item-price');
                
                const isDescriptionEmpty = descriptionInput.value.trim() === '';
                const isPriceEmpty = priceInput.value.trim() === '' || parseFloat(priceInput.value) === 0;

                if (!lastItem.classList.contains('is-locked') && isDescriptionEmpty && isPriceEmpty) {
                    descriptionInput.focus();
                    return;
                }
            }

            const currencySelect = document.getElementById(`${type}-currency`);
            const currency = currencySelect ? currencySelect.value : 'USD';

            const itemBlock = document.createElement('div');
            itemBlock.className = 'item-block columns is-multiline is-mobile is-vcentered is-relative';
            
            itemBlock.innerHTML = `
                <div class="column is-2-desktop is-6-mobile">
                    <label class="label is-small">Tipo</label>
                    <div class="control">
                        <div class="select is-fullwidth is-small is-warning">
                            <select>
                                <option>Abono</option>
                                <option>Reserva</option>
                                <option>Cancelación</option>
                                <option>Otro</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="column is-3-desktop is-6-mobile">
                    <label class="label is-small">Descripción</label>
                    <div class="control">
                        <input type="text" class="input is-small is-warning" placeholder="Descripción del item">
                    </div>
                </div>
                <div class="column is-1-desktop is-4-mobile">
                    <label class="label is-small">Cant.</label>
                    <div class="control">
                        <input type="number" class="item-qty input is-small is-warning" value="1" min="0">
                    </div>
                </div>
                <div class="column is-2-desktop is-4-mobile">
                    <label class="label is-small">Fecha de Pago</label>
                    <div class="control">
                        <input type="date" class="item-payment-date input is-small is-warning">
                    </div>
                </div>
                <div class="column is-2-desktop is-4-mobile">
                    <label class="label is-small">Precio Unit.</label>
                    <div class="control">
                        <input type="number" class="item-price input is-small is-warning" placeholder="0" min="0" step="1">
                    </div>
                </div>
                <div class="column is-2-desktop is-4-mobile">
                     <label class="label is-small">Total</label>
                    <div class="item-total pt-1 has-text-weight-medium">${formatCurrency(0, currency)}</div>
                </div>
                <button class="delete is-small remove-item no-print" style="position: absolute; top: 0.5rem; right: 0.5rem;"></button>
            `;
            itemsContainer.appendChild(itemBlock);
            
            if (currentlyUpdatingIndex !== null && descriptionToInherit) {
                itemBlock.querySelector('input[type="text"]').value = descriptionToInherit;
            }

            if (isLocked) {
                itemBlock.classList.add('is-locked');
                itemBlock.querySelectorAll('input, select').forEach(el => el.disabled = true);
                const deleteButton = itemBlock.querySelector('.remove-item');
                if (deleteButton) deleteButton.style.display = 'none';
            }

            if(focus) {
                itemBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
                itemBlock.querySelector('input[type="text"]').focus();
            }
            updateTotals();
            return itemBlock;
        }

        function filterHistory() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const filteredHistory = invoiceHistory.filter(record => {
                return (record.client && record.client.toLowerCase().includes(searchTerm)) ||
                       (record.eventName && record.eventName.toLowerCase().includes(searchTerm)) ||
                       (record.date && record.date.toLowerCase().includes(searchTerm));
            });
            renderHistory(filteredHistory);
        }

        function addTask() {
            // Lógica existente
        }

        function printContent(sectionId) {
            window.print();
        }
        
        function formatDoc(command, value = null) {
            document.execCommand(command, false, value);
        }

        function shareViaWhatsApp(type) {
            const title = 'FACTURA';
            const client = document.getElementById(`${type}-client`).value;
            const date = document.getElementById(`${type}-date`).value;
            const eventName = document.getElementById(`${type}-event-name`).value;
            const eventPrice = document.getElementById(`${type}-event-price`).value;
            const currency = document.getElementById(`${type}-currency`).value;

            let message = `┌─── *${title}* ───\n`;
            if (client) message += `│ 🚶‍♂️ *Caminante:* ${client}\n`;
            if (date) message += `│ 📅 *Fecha Caminata:* ${date}\n`;
            if (eventName) message += `│ 🏞️ *Evento:* ${eventName}\n`;
            if (parseFloat(eventPrice) > 0) message += `│ 💰 *Precio Evento:* ${formatCurrency(parseFloat(eventPrice), currency)}\n`;
            
            let itemsText = '';
            document.querySelectorAll(`#${type}-items .item-block`).forEach(block => {
                const itemType = block.querySelector('select').value;
                const description = block.querySelector('input[type="text"]').value;
                const qty = block.querySelector('.item-qty').value;
                const paymentDate = block.querySelector('.item-payment-date').value;
                const price = formatCurrency(parseFloat(block.querySelector('.item-price').value) || 0, currency);
                const total = block.querySelector('.item-total').textContent;
                if (description) {
                    itemsText += `│ 🎟️ ${itemType}: ${description} - ${qty} x ${price} = ${total}`;
                    if (paymentDate) {
                        itemsText += ` (Pago: ${paymentDate})\n`;
                    } else {
                        itemsText += '\n';
                    }
                }
            });

            if(itemsText) {
                message += '├───────────────────\n│      *-- Items --*\n';
                message += itemsText;
            }

            const subtotal = document.getElementById(`${type}-subtotal`).textContent;
            const tax = document.getElementById(`${type}-tax`).textContent;
            const faltante = document.getElementById(`${type}-faltante`).textContent;
            const total = document.getElementById(`${type}-total`).textContent;
            
            message += '├───────────────────\n│      *-- Totales --*\n';
            if (parseFloat(subtotal.replace(/[^0-9.-]+/g,"")) > 0) message += `│ *Subtotal:* ${subtotal}\n`;
            if (parseFloat(tax.replace(/[^0-9.-]+/g,"")) > 0) message += `│ *Impuestos:* ${tax}\n`;
            if (faltante.toUpperCase() !== 'CANCELADO' && parseFloat(faltante.replace(/[^0-9.-]+/g,"")) !== 0) message += `│ *Faltante:* ${faltante}\n`;
            message += `│ *TOTAL:* ${total}\n`;
            message += '└───────────────────';

            const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function dataURLtoBlob(dataurl) {
            var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
            while(n--){
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], {type:mime});
        }

        async function exportAndShareRecord(index) {
            const recordElement = document.getElementById(`record-${index}`);
            if (!recordElement) return;
            
            const buttons = recordElement.querySelector('.level-right');
            buttons.style.display = 'none';

            try {
                const canvas = await html2canvas(recordElement, {
                    scale: 2, 
                    backgroundColor: null 
                });

                buttons.style.display = '';

                const dataUrl = canvas.toDataURL('image/png');
                const blob = dataURLtoBlob(dataUrl);
                const file = new File([blob], `factura-${invoiceHistory[index].registrationNumber}.png`, { type: 'image/png' });
                
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: `Factura ${invoiceHistory[index].registrationNumber}`,
                        text: `Factura para ${invoiceHistory[index].client}`,
                    });
                } else {
                    const link = document.createElement('a');
                    link.href = dataUrl;
                    link.download = `factura-${invoiceHistory[index].registrationNumber}.png`;
                    link.click();
                }
            } catch (error) {
                console.error('Error al exportar la imagen:', error);
                buttons.style.display = '';
            }
        }
        
        function backupData() {
            const data = {
                invoices: JSON.parse(localStorage.getItem('invoiceHistory') || '[]'),
                lastRegistrationNumber: localStorage.getItem('lastRegistrationNumber') || 76
            };
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type : 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'respaldo_gestion.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function triggerRestore() {
            document.getElementById('restore-input').click();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.invoices && data.lastRegistrationNumber) {
                        invoiceHistory = data.invoices;
                        lastRegistrationNumber = data.lastRegistrationNumber;

                        localStorage.setItem('invoiceHistory', JSON.stringify(invoiceHistory));
                        localStorage.setItem('lastRegistrationNumber', lastRegistrationNumber);

                        renderHistory();
                        alert('¡Datos restaurados con éxito!');
                    } else {
                        alert('El archivo de respaldo no tiene el formato correcto.');
                    }
                } catch (error) {
                    alert('Error al leer el archivo de respaldo.');
                }
            };
            reader.readAsText(file);
        }

        function initialize() {
            lastRegistrationNumber = parseInt(localStorage.getItem('lastRegistrationNumber')) || 76;

            const savedInvoices = localStorage.getItem('invoiceHistory');
            if (savedInvoices) {
                invoiceHistory = JSON.parse(savedInvoices);
                renderHistory();
            }

            document.body.addEventListener('input', (e) => {
                const target = e.target;
                if (target.closest('#invoices')) {
                    updateTotals();
                }
            });
            
            // Add blur event listener for auto-adding first item
            document.getElementById('invoice-event-price').addEventListener('blur', () => {
                const itemsContainer = document.getElementById('invoice-items');
                if (currentlyUpdatingIndex === null && itemsContainer.children.length === 0 && !document.getElementById('add-item-invoice').disabled) {
                    addItem('invoice');
                }
            });

            document.body.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('remove-item')) {
                    target.closest('.item-block').remove();
                    updateTotals();
                } else if (target.classList.contains('remove-task')) {
                    target.closest('li').remove();
                } else if (!target.closest('.delete-btn')) {
                    resetDeleteButtons();
                }
            });

            window.showTab = (tabId, element) => {
                document.querySelectorAll('.tabs li').forEach(tab => tab.classList.remove('is-active'));
                element.parentElement.classList.add('is-active');
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('is-hidden'));
                document.getElementById(tabId).classList.remove('is-hidden');
            };
            
            window.addItem = addItem;
            window.addTask = addTask;
            window.printContent = printContent;
            window.formatDoc = formatDoc;
            window.saveInvoice = saveInvoice;
            window.loadFromHistory = loadFromHistory;
            window.clearForm = clearForm;
            window.shareViaWhatsApp = shareViaWhatsApp;
            window.handleDeleteClick = handleDeleteClick;
            window.backupData = backupData;
            window.triggerRestore = triggerRestore;
            window.handleFileSelect = handleFileSelect;
            window.exportAndShareRecord = exportAndShareRecord;
            window.filterHistory = filterHistory;
            window.enableFormEditing = enableFormEditing;

            updateTotals();
        }

        document.addEventListener('DOMContentLoaded', initialize);
    })();
    </script>
</body>
</html>
