{% extends "base.html" %}

{% block title %}Listado de Caminatas{% endblock %}

{% block head_content %}
<style>
    /* --- INICIO: ESTILOS CORREGIDOS PARA BOTÓN FLOTANTE --- */
    .dynamic-fab-container {
        position: fixed;
        /* ¡CAMBIO CLAVE! Se ajusta la posición a la esquina superior izquierda */
        top: 100px; 
        left: 20px;
        z-index: 9999; /* z-index alto para máxima visibilidad */
    }

    .dynamic-fab-button {
        background-color: #6f42c1; /* Púrpura */
        color: white;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }
    .dynamic-fab-button:hover {
        transform: scale(1.05);
        color: white;
    }
    /* --- FIN: ESTILOS CORREGIDOS --- */


    /* Estilos generales para los botones flotantes y notificaciones */
    .fab-container {
        position: fixed;
        bottom: 50px;
        right: 20px;
        z-index: 1000;
    }
    .fab-button {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        transition: all 0.3s ease;
    }
    .fab-button:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }
    .fab-container-share {
        position: fixed;
        right: 20px;
        bottom: 120px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }
    .fab-button-share {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        transition: all 0.3s ease;
        color: #ffffff;
        border: none;
        text-decoration: none;
        margin-bottom: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    .fab-button-share:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    .fab-button-share.whatsapp { background-color: #25D366; }
    .fab-button-share.copy-link { background-color: #0d6efd; }
    #toast-notification {
        visibility: hidden;
        min-width: 250px;
        margin-left: -125px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 8px;
        padding: 16px;
        position: fixed;
        z-index: 3000;
        left: 50%;
        bottom: 30px;
        font-size: 17px;
        opacity: 0;
        transition: opacity 0.5s, visibility 0.5s;
    }
    #toast-notification.show {
        visibility: visible;
        opacity: 1;
    }

    /* 1. Estilos para caminatas finalizadas */
    .caminata-finalizada {
        filter: grayscale(100%);
        opacity: 0.8;
    }

    /* Contenedores para las diferentes vistas */
    .grid-list-content { display: block; }
    .image-only-content { display: none; }

    /* Estilos de imagen para respetar proporciones (común para todas las vistas) */
    .card-img-wrapper {
        position: relative;
        width: 100%;
        padding-top: calc(1920 / 1280 * 100%); /* Proporción 3:2 original */
        overflow: hidden;
        border-radius: 8px 8px 0 0;
        background-color: #f8f9fa; /* Fondo claro para el letterboxing */
    }
    .card-img-top {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain; /* Usar 'contain' para no recortar */
    }

    /* 2. Estilos específicos por vista */

    /* --- VISTA DE CUADRÍCULA (GRID) --- */
    #caminatasContent.grid-view .card-body {
        display: flex;
        flex-direction: column;
    }
    #caminatasContent.grid-view .text-wrapper {
        flex-grow: 1;
    }
    #caminatasContent.grid-view .card-title,
    #caminatasContent.grid-view .card-text {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #caminatasContent.grid-view .etapa-title {
        text-align: center;
    }
    #caminatasContent.grid-view .precio-text {
        text-align: right;
    }


    /* --- VISTA DE LISTA (LIST) --- */
    #caminatasContent.list-view > .col {
        margin-top: 0 !important;
        padding-bottom: 0.5rem;
        border-bottom: 1px dashed #ddd;
        margin-bottom: 0.5rem;
    }
    #caminatasContent.list-view > .col:last-child {
        border-bottom: none;
    }
    #caminatasContent.list-view .card {
        flex-direction: row;
        align-items: center;
        box-shadow: none !important;
        border: none !important;
        height: auto !important;
        padding: 0.5rem;
        background-color: transparent !important;
    }
    #caminatasContent.list-view .card-img-wrapper {
        display: block !important;
        width: 80px;
        height: 80px;
        padding-top: 0 !important;
        flex-shrink: 0;
        border-radius: 8px;
        margin-right: 1rem;
    }
    #caminatasContent.list-view .card-img-top {
        position: static;
        border-radius: 8px;
    }
    #caminatasContent.list-view .card-body {
        flex-grow: 1;
        padding: 0 !important;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
    }
    #caminatasContent.list-view .text-wrapper {
        flex: 1; /* Permite que el contenedor de texto crezca */
        min-width: 0; /* Esencial para que el texto se ajuste y no desborde */
    }
    #caminatasContent.list-view .card-title,
    #caminatasContent.list-view .card-text {
        white-space: normal; /* Permite que el texto se divida en múltiples líneas */
        word-break: break-word; /* Rompe palabras largas si es necesario */
        text-align: left;
        margin-bottom: 0.1rem;
    }
    #caminatasContent.list-view .card-body hr {
        display: none !important;
    }
    #caminatasContent.list-view .mt-auto {
        flex-shrink: 0; /* Evita que el botón se encoja */
        margin-top: 0 !important;
    }
    @media (max-width: 576px) {
        #caminatasContent.list-view .card-body {
            flex-direction: column;
            align-items: flex-start;
        }
        #caminatasContent.list-view .text-wrapper {
            width: 100%;
        }
        #caminatasContent.list-view .mt-auto {
            width: 100%;
            margin-top: 0.5rem !important;
        }
    }

    /* --- VISTA DE GALERÍA (GALLERY) --- */
    #caminatasContent.gallery-view {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
        margin-top: 2rem;
    }
    @media (min-width: 576px) {
        #caminatasContent.gallery-view {
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }
    }
    @media (min-width: 992px) {
        #caminatasContent.gallery-view {
            grid-template-columns: repeat(5, 1fr);
        }
    }
    #caminatasContent.gallery-view > .col {
        margin-top: 0 !important;
        padding: 0 !important;
        flex: none !important;
        max-width: none !important;
        width: auto !important;
    }
    #caminatasContent.gallery-view .grid-list-content {
        display: none !important;
    }
    #caminatasContent.gallery-view .image-only-content {
        display: block !important;
        height: 100%;
    }
    .image-only-wrapper {
        position: relative;
        width: 100%;
        padding-top: calc(1920 / 1280 * 100%);
        overflow: hidden;
        border-radius: 8px;
        background-color: #f8f9fa;
    }
    .image-only-content img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 8px;
    }

</style>
{% endblock %}

{% block content %}
<div class="container ">
    
    <div class="mb-4 text-center">
        <!-- BOTÓN DE PÓLIZAS -->
        <a href="https://wa.me/50686227500?text=Hola%20Estoy%20interesad%40%20en%20adquirir%20una%20poliza%20de%20Caminante.%20Brindame%20la%20informaci%C3%B3n%20y%20para%20ello%20aportar%C3%A9%20mi%20nombre%20completo" target="_blank" class="btn btn-success rounded-pill px-4 py-2 mb-4">
            <i class="fas fa-hiking me-2"></i>Pólizas
        </a>
        <h2 class="text-warning">Próximas Caminatas</h2>
        <p>Las siguientes caminatas ya estás asignadas en el calendario y definidas con sus respectivos precios. Cualquier caminatas puede sufrir variación por factores externos que afecten la seguridad de las mismas. </p>
    </div>

    <div class="row justify-content-center mb-4">
        <div class="col-md-6">
            <form method="GET" action="{{ url_for('caminatas.ver_caminatas') }}" class="d-flex">
                <select name="actividad" class="form-select me-2" aria-label="Buscar por Actividad">
                    <option value="">Todas las Actividades</option>
                    {% set actividad_opciones = [
                        "El Camino de Costa Rica",
                        "Parque Nacional",
                        "Paseo",
                        "Iniciante",
                        "Básico",
                        "Intermedio",
                        "Dificil",
                        "Avanzado",
                        "Técnico"
                    ] %}
                    {% for option in actividad_opciones %}
                    <option value="{{ option }}" {% if option == search_actividad %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-outline-secondary">
                    <i class="fas fa-search"></i> Buscar
                </button>
                {% if search_actividad %}
                    <a href="{{ url_for('caminatas.ver_caminatas') }}" class="btn btn-outline-danger ms-2">
                        <i class="fas fa-times"></i> Limpiar
                    </a>
                {% endif %}
            </form>
        </div>
    </div>


    {% if caminatas %}
       <hr class="text-warning">
       
    <div class="d-flex justify-content-end mb-3">
        <button id="gridViewBtn" class="btn btn-sm btn-outline-secondary me-2" title="Vista de Cuadrícula">
            <i class="fas fa-th-large"></i>
        </button>
        <button id="listViewBtn" class="btn btn-sm btn-outline-secondary me-2" title="Vista de Lista Compacta">
            <i class="fas fa-list"></i>
        </button>
        <button id="galleryViewBtn" class="btn btn-sm btn-outline-secondary" title="Vista de Galería de Imágenes">
            <i class="fas fa-image"></i>
        </button>
    </div>

    <div id="caminatasContent">
        {% for caminata in caminatas %}
        <div class="col mt-5">
            <div class="grid-list-content {% if caminata.finalizada %}caminata-finalizada{% endif %}">
                <div class="card h-100 shadow-sm">
                    <a href="{{ url_for('caminatas.detalle_caminata', caminata_id=caminata.id) }}" class="card-img-link">
                        <div class="card-img-wrapper">
                            {% if caminata.imagen_caminata_url %}
                            <img src="{{ url_for('static', filename=caminata.imagen_caminata_url) }}" class="card-img-top" alt="Imagen de la Caminata" onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/defaults/no_image.png') }}';">
                            {% else %}
                            <img src="{{ url_for('static', filename='images/defaults/no_image.png') }}" class="card-img-top" alt="Sin Imagen">
                            {% endif %}
                        </div>
                    </a>
                    <div class="card-body">
                        <!-- Wrapper para el texto para mejor control en cada vista -->
                        <div class="text-wrapper">
                            {% if caminata.etapa %}
                            <h4 class="card-title mb-3 etapa-title">{{ caminata.etapa }}</h4>
                            {% endif %}
                            <h4 class="card-title">{{ caminata.nombre }}</h4>
                            
                            <p class="card-text mb-1"><small class="text-muted"><strong>Actividad:</strong> {{ caminata.actividad }}</small></p>
                            <p class="card-text mb-1"><small class="text-muted"><strong>Fecha:</strong> {{ caminata.fecha.strftime('%d de %B de %Y') }}</small></p>
                            <h4 class="card-text mb-1 precio-text"><small class="text-muted "><strong>Precio:</strong> {% if caminata.moneda == 'USD' %}${% else %}¢{% endif %}{{ caminata.precio|int }}</small></h4>
                        </div>
                        <hr class="my-2 border-warning">
                                          
                        <div class="mt-auto text-center">
                            {% if caminata.finalizada %}
                                <a href="{{ url_for('caminatas.detalle_caminata', caminata_id=caminata.id) }}" class="btn btn-secondary btn-sm w-100">Ver Detalles</a>
                            {% else %}
                                <a href="{{ url_for('caminatas.detalle_caminata', caminata_id=caminata.id) }}" class="btn btn-warning btn-sm w-100">Más</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="image-only-content {% if caminata.finalizada %}caminata-finalizada{% endif %}">
                <a href="{{ url_for('caminatas.detalle_caminata', caminata_id=caminata.id) }}" class="image-only-link">
                    <div class="image-only-wrapper">
                        {% if caminata.imagen_caminata_url %}
                        <img src="{{ url_for('static', filename=caminata.imagen_caminata_url) }}" alt="Imagen de la Caminata" onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/defaults/no_image.png') }}';">
                        {% else %}
                        <img src="{{ url_for('static', filename='images/defaults/no_image.png') }}" alt="Sin Imagen">
                        {% endif %}
                    </div>
                </a>
            </div>

        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info text-center" role="alert">
        No hay caminatas registradas aún.
    </div>
    {% endif %}
</div>

<div id="toast-notification">¡Enlace copiado al portapapeles!</div>

<!-- --- INICIO: Lógica CORREGIDA para el Botón Flotante Dinámico --- -->
{% if config and config.visibility_state != 'disabled' %}
    {% set show_button = false %}
    {% if config.visibility_state == 'all' %}
        {% set show_button = true %}
    {% elif config.visibility_state == 'regular' and session.logged_in %}
        {% set show_button = true %}
    {% elif config.visibility_state == 'superuser' and session.is_superuser %}
        {% set show_button = true %}
    {% endif %}

    {% if show_button %}
    <div class="dynamic-fab-container">
        <a href="{{ config.link }}" target="_blank" class="dynamic-fab-button" title="Enlace Personalizado">
            <i class="fas fa-link"></i>
        </a>
    </div>
    {% endif %}
{% endif %}
<!-- --- FIN: Lógica para el Botón Flotante Dinámico --- -->


<div class="fab-container-share">
    <a href="#" id="copyLinkButton" class="fab-button-share copy-link" title="Compartir Enlace">
        <i class="fas fa-share-alt"></i>
    </a>
    <a href="#" id="whatsappShareButton" class="fab-button-share whatsapp" title="Compartir por WhatsApp">
        <i class="fab fa-whatsapp"></i>
    </a>
</div>

{% if session.role == 'Superuser' %}
<div class="fab-container">
    <a href="{{ url_for('caminatas.crear_caminata') }}" class="btn btn-warning fab-button" title="Agregar nueva caminata">
        <i class="fas fa-plus" style="color: black;"></i>
    </a>
</div>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const gridViewBtn = document.getElementById('gridViewBtn');
        const listViewBtn = document.getElementById('listViewBtn');
        const galleryViewBtn = document.getElementById('galleryViewBtn'); 
        const caminatasContent = document.getElementById('caminatasContent');
        const savedView = localStorage.getItem('caminatasView') || 'grid';

        function setView(viewType) {
            caminatasContent.classList.remove('list-view', 'gallery-view', 'grid-view');
            caminatasContent.classList.remove('row', 'g-4', 'row-cols-1', 'row-cols-md-3', 'row-cols-lg-4');
            const gridListContents = document.querySelectorAll('.grid-list-content');
            const imageOnlyContents = document.querySelectorAll('.image-only-content');

            if (viewType === 'list') {
                caminatasContent.classList.add('list-view', 'row', 'g-4', 'row-cols-1'); 
                gridListContents.forEach(el => el.style.display = 'block');
                imageOnlyContents.forEach(el => el.style.display = 'none');
            } else if (viewType === 'gallery') {
                caminatasContent.classList.add('gallery-view');
                gridListContents.forEach(el => el.style.display = 'none');
                imageOnlyContents.forEach(el => el.style.display = 'block');
            } else { // Grid view (default)
                caminatasContent.classList.add('grid-view', 'row', 'g-4', 'row-cols-1', 'row-cols-md-3', 'row-cols-lg-4');
                gridListContents.forEach(el => el.style.display = 'block');
                imageOnlyContents.forEach(el => el.style.display = 'none');
            }

            // Actualizar el botón activo
            [gridViewBtn, listViewBtn, galleryViewBtn].forEach(btn => btn.classList.remove('active', 'btn-secondary'));
            [gridViewBtn, listViewBtn, galleryViewBtn].forEach(btn => btn.classList.add('btn-outline-secondary'));

            if (viewType === 'list') {
                listViewBtn.classList.add('active', 'btn-secondary');
                listViewBtn.classList.remove('btn-outline-secondary');
            } else if (viewType === 'gallery') {
                galleryViewBtn.classList.add('active', 'btn-secondary');
                galleryViewBtn.classList.remove('btn-outline-secondary');
            } else {
                gridViewBtn.classList.add('active', 'btn-secondary');
                gridViewBtn.classList.remove('btn-outline-secondary');
            }
            localStorage.setItem('caminatasView', viewType);
        }

        setView(savedView);

        gridViewBtn.addEventListener('click', () => setView('grid'));
        listViewBtn.addEventListener('click', () => setView('list'));
        galleryViewBtn.addEventListener('click', () => setView('gallery'));

        // Funcionalidad de compartir
        const whatsappShareButton = document.getElementById('whatsappShareButton');
        if (whatsappShareButton) {
            whatsappShareButton.addEventListener('click', (event) => {
                event.preventDefault();
                const text = '¡Hola! Te comparto este enlace para que veas las caminatas de La Tribu CR:';
                const url = 'https://www.latribucr.site/caminatas/ver_caminatas';
                const message = encodeURIComponent(`${text} ${url}`);
                const whatsappUrl = `https://wa.me/?text=${message}`;
                window.open(whatsappUrl, '_blank');
            });
        }

        const copyLinkButton = document.getElementById('copyLinkButton');
        if (copyLinkButton) {
            copyLinkButton.addEventListener('click', async (event) => {
                event.preventDefault();
                const shareData = {
                    title: 'Caminatas de La Tribu CR',
                    text: 'Descubre todas las caminatas y eventos disponibles.',
                    url: 'https://www.latribucr.site/caminatas/ver_caminatas'
                };
                try {
                    if (navigator.share) {
                        await navigator.share(shareData);
                    } else {
                        throw new Error('Share API not supported');
                    }
                } catch (err) {
                    try {
                        const textArea = document.createElement('textarea');
                        textArea.value = shareData.url;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-9999px';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        const toast = document.getElementById('toast-notification');
                        toast.className = 'show';
                        setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3000);
                    } catch (copyErr) {
                        console.error('Error al copiar al portapapeles:', copyErr);
                    }
                }
            });
        }
    });
</script>
{% endblock %}
