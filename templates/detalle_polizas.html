{% extends 'base.html' %}

{% block title %}Detalle de Póliza{% endblock %}

{% block head_content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
    /* Estilos para el contenedor principal de detalles */
    #policy-details-container {
        background-color: #ffffff;
        padding: 30px;
        border-radius: 15px;
        box-shadow: none !important;
        border: 1px solid #e0e0e0;
    }

    /* Estilos para los títulos de sección */
    .section-title {
        color: #ffc107; /* Color warning */
        margin-top: 20px;
        margin-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 5px;
    }

    /* Estilos para los ítems de lista de detalles */
    .details-list .list-group-item {
        border: none;
        padding: 8px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* Línea punteada para separar los ítems */
    .details-list .list-group-item:not(:last-child) {
        border-bottom: 1px dotted #e9ecef;
    }

    /* Estilos para la tabla de beneficiarios */
    .table-beneficiarios {
        margin-top: 10px;
    }
    
    /* Contenedor para los botones flotantes de la izquierda (Volver) */
    .fab-container-back {
        position: fixed;
        bottom: 70px;
        left: 20px;
        z-index: 1000;
    }

    /* Contenedor para los botones flotantes de la derecha (Acciones) */
    .fab-container-actions {
        position: fixed;
        bottom: 70px;
        right: 20px;
        z-index: 1050;
        display: flex;
        flex-direction: column;
        gap: 10px; /* Espacio entre botones */
    }

    .fab-button {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        transition: all 0.3s ease;
        text-decoration: none;
        border: none;
        color: white;
    }
    .fab-button:hover {
        transform: scale(1.05);
    }

    /* Colores específicos para cada botón */
    .fab-button-back { background-color: #007bff; } /* Primary */
    .fab-button-edit { background-color: #ffc107; color: #212529; } /* Warning */
    .fab-button-delete { background-color: #dc3545; } /* Danger */
    .fab-button-export { background-color: #17a2b8; } /* Info */

    /* --- NUEVA REGLA PARA CORREGIR EL BOTÓN DE EXPORTAR --- */
    .fab-button-export.dropdown-toggle::after {
        display: none; /* Oculta la flecha extra de Bootstrap */
    }

    /* Estilos para el modal de confirmación */
    .modal-content {
        border-radius: 10px;
        box-shadow: none;
        border: 1px solid #dee2e6;
    }
    .btn-confirm-delete {
        background-color: #dc3545;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div id="policy-details-container">
                <h1 class="text-center text-warning mb-4">Detalle de la Póliza</h1>

                <!-- DATOS DE LA ASEGURADORA (Solo Superuser) -->
                {% if session.role == 'Superuser' %}
                <h4 class="section-title">Datos de la Aseguradora</h4>
                <ul class="list-group list-group-flush details-list">
                    <li class="list-group-item"><strong>Coordinador:</strong> <span>{{ poliza.coordinador.nombre }} {{ poliza.coordinador.primer_apellido }}</span></li>
                    <li class="list-group-item"><strong>Aseguradora:</strong> <span>{{ poliza.aseguradora_nombre or 'No especificado' }}</span></li>
                    <li class="list-group-item"><strong>Asesor:</strong> <span>{{ poliza.asesor_nombre or 'No especificado' }}</span></li>
                    <li class="list-group-item"><strong>Teléfono Aseguradora:</strong> <span>{{ poliza.aseguradora_telefono or 'No especificado' }}</span></li>
                    <li class="list-group-item"><strong>Email Aseguradora:</strong> <span>{{ poliza.aseguradora_email or 'No especificado' }}</span></li>
                    <li class="list-group-item"><strong>Teléfono Asesor:</strong> <span>{{ poliza.asesor_telefono or 'No especificado' }}</span></li>
                </ul>
                {% endif %}

                <!-- DATOS DEL ASEGURADO -->
                <h4 class="section-title">Datos del Asegurado</h4>
                <ul class="list-group list-group-flush details-list">
                    <li class="list-group-item">
                        <strong>Nombre Completo:</strong> 
                        <span>
                            {% if poliza.asegurado_registrado %}
                                {{ poliza.asegurado_registrado.nombre }} {{ poliza.asegurado_registrado.primer_apellido }} {{ poliza.asegurado_registrado.segundo_apellido or '' }}
                            {% else %}
                                {{ poliza.asegurado_nombre_manual }} {{ poliza.asegurado_primer_apellido }} {{ poliza.asegurado_segundo_apellido or '' }}
                            {% endif %}
                        </span>
                    </li>
                    <li class="list-group-item"><strong>Teléfono:</strong> <span>{{ poliza.asegurado_telefono or 'No especificado' }}</span></li>
                    <li class="list-group-item"><strong>Email:</strong> <span>{{ poliza.asegurado_email or 'No especificado' }}</span></li>
                    <li class="list-group-item"><strong>Género:</strong> <span>{{ poliza.genero or 'No especificado' }}</span></li>
                </ul>

                <!-- BENEFICIARIOS -->
                <h4 class="section-title">Beneficiarios</h4>
                {% if poliza.beneficiarios %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-beneficiarios">
                        <thead class="table-light">
                            <tr>
                                <th>Nombre Completo</th>
                                <th>Cédula</th>
                                <th>Parentesco</th>
                                <th class="text-end">Porcentaje</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for b in poliza.beneficiarios %}
                            <tr>
                                <td>{{ b.nombre }} {{ b.primer_apellido }} {{ b.segundo_apellido or '' }}</td>
                                <td>{{ b.cedula or 'N/A' }}</td>
                                <td>{{ b.parentesco or 'N/A' }}</td>
                                <td class="text-end">{{ b.porcentaje if b.porcentaje is not none else 'N/A' }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p>No hay beneficiarios registrados para esta póliza.</p>
                {% endif %}

                <!-- DATOS DE PAGO Y VIGENCIA -->
                <h4 class="section-title">Datos de Pago y Vigencia</h4>
                <ul class="list-group list-group-flush details-list">
                    <li class="list-group-item"><strong>Fecha de Vencimiento:</strong> <span>{{ poliza.fecha_vencimiento.strftime('%d/%m/%Y') if poliza.fecha_vencimiento else 'No especificada' }}</span></li>
                    <li class="list-group-item"><strong>Precio de la Póliza:</strong> <span>₡{{ "{:,.0f}".format(poliza.precio_poliza) if poliza.precio_poliza is not none else 'No especificado' }}</span></li>
                    <li class="list-group-item"><strong>Monto Cancelado:</strong> <span>₡{{ "{:,.0f}".format(poliza.monto_cancelacion) if poliza.monto_cancelacion is not none else 'No especificado' }}</span></li>
                    <li class="list-group-item"><strong>Banco:</strong> <span>{{ poliza.banco or 'No especificado' }}</span></li>
                    <li class="list-group-item"><strong>Cuenta de Depósito:</strong> <span>{{ poliza.cuenta_deposito or 'No especificado' }}</span></li>
                    <li class="list-group-item"><strong>SINPE Móvil:</strong> <span>{{ poliza.sinpe_deposito or 'No especificado' }}</span></li>
                </ul>

                <!-- DETALLES ADICIONALES -->
                <h4 class="section-title">Detalles Adicionales</h4>
                <ul class="list-group list-group-flush details-list">
                    {% if session.role == 'Superuser' %}
                    <li class="list-group-item"><strong>Costo del Trámite:</strong> <span>₡{{ "{:,.0f}".format(poliza.costo_tramite) }}</span></li>
                    {% endif %}
                    <li class="list-group-item"><strong>Fecha de Registro:</strong> <span>{{ poliza.fecha_registro.strftime('%d/%m/%Y a las %I:%M %p') }}</span></li>
                </ul>
                {% if poliza.otros_detalles %}
                    <div class="mt-3">
                        <strong>Notas:</strong>
                        <p class="text-muted" style="white-space: pre-wrap;">{{ poliza.otros_detalles }}</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Botones flotantes -->
<div class="fab-container-back">
    <a href="{{ url_for('polizas.ver_polizas') }}" class="fab-button fab-button-back" title="Volver a Pólizas">
        <i class="fas fa-arrow-left"></i>
    </a>
</div>

{% if session.role == 'Superuser' %}
<div class="fab-container-actions">
    <!-- Botón de Editar -->
    <a href="{{ url_for('polizas.editar_poliza', poliza_id=poliza.id) }}" class="fab-button fab-button-edit" title="Editar Póliza">
        <i class="fas fa-edit"></i>
    </a>
    <!-- Botón de Eliminar (abre el modal) -->
    <button type="button" class="fab-button fab-button-delete" title="Eliminar Póliza" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">
        <i class="fas fa-trash-alt"></i>
    </button>
    <!-- Botón de Exportar (abre un dropdown) -->
    <div class="dropup">
        <button class="fab-button fab-button-export dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="Exportar">
            <i class="fas fa-file-export"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="exportDropdown">
            <li><a class="dropdown-item" href="{{ url_for('polizas.exportar_poliza', poliza_id=poliza.id, format='pdf') }}">Exportar a PDF</a></li>
            <li><a class="dropdown-item" href="{{ url_for('polizas.exportar_poliza', poliza_id=poliza.id, format='txt') }}">Exportar a TXT</a></li>
            <li><a class="dropdown-item" href="#" id="exportJpgBtn">Exportar a JPG</a></li>
            <li><a class="dropdown-item" href="{{ url_for('polizas.exportar_poliza', poliza_id=poliza.id, format='xls') }}">Exportar a XLS</a></li>
        </ul>
    </div>
</div>
{% endif %}

<!-- Modal de Confirmación de Eliminación -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                ¿Estás seguro de que deseas eliminar esta póliza? Esta acción no se puede deshacer.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form action="{{ url_for('polizas.eliminar_poliza', poliza_id=poliza.id) }}" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-confirm-delete">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const exportJpgBtn = document.getElementById('exportJpgBtn');
    if (exportJpgBtn) {
        exportJpgBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const elementToCapture = document.getElementById('policy-details-container');
            const actionButtons = document.querySelector('.fab-container-actions');
            const backButton = document.querySelector('.fab-container-back');

            // Ocultar botones antes de la captura
            if (actionButtons) actionButtons.style.visibility = 'hidden';
            if (backButton) backButton.style.visibility = 'hidden';

            html2canvas(elementToCapture, {
                scale: 2, // Mejorar resolución
                useCORS: true,
                logging: false
            }).then(canvas => {
                // Volver a mostrar los botones
                if (actionButtons) actionButtons.style.visibility = 'visible';
                if (backButton) backButton.style.visibility = 'visible';

                // Crear y descargar la imagen
                const link = document.createElement('a');
                link.download = 'detalle_poliza_{{ poliza.id }}.jpg';
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
            }).catch(err => {
                // Asegurarse de que los botones sean visibles incluso si hay un error
                if (actionButtons) actionButtons.style.visibility = 'visible';
                if (backButton) backButton.style.visibility = 'visible';
                console.error('Error al exportar a JPG:', err);
                alert('Ocurrió un error al generar la imagen.');
            });
        });
    }
});
</script>
{% endblock %}
