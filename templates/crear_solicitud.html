{% extends 'base.html' %}

{% block title %}Solicitud de Viaje{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="card bg-white rounded-lg border-0 shadow-none">
        <div class="card-body">
            <h1 class="card-title text-center mb-4 text-warning">Solicitud de Viaje</h1>
            <p class="text-center text-muted fst-italic">
                Todo viaje se debe reservar con un 15% del total del servicio. Si se requiere cancelar un viaje, debe realizarse 5 días hábiles antes de la fecha ocupada.
            </p>
            <hr class="my-4">

            <!-- Enlaces a los registros -->
            <div class="text-center mb-4">
                <a href="{{ url_for('solicitud.registro_solicitudes') }}" class="btn btn-sm btn-outline-secondary me-2">Ver Solicitudes</a>
                <a href="{{ url_for('solicitud.consulta_usuarios') }}" class="btn btn-sm btn-outline-secondary">Ver Usuarios</a>
            </div>

            <form id="solicitudForm" method="post" enctype="multipart/form-data">
                <!-- SECCIÓN 1: ¿TIENE NÚMERO DE USUARIO? -->
                <div class="row mb-4">
                    <div class="col-12 text-center">
                        <h4 class="mb-3">¿Tienes un Número de Usuario?</h4>
                        <div class="btn-group" role="group" aria-label="Opciones de usuario">
                            <input type="radio" class="btn-check" name="user_type" id="user_si" autocomplete="off" value="si" checked>
                            <label class="btn btn-outline-warning" for="user_si">Sí</label>
                            
                            <input type="radio" class="btn-check" name="user_type" id="user_no" autocomplete="off" value="no">
                            <label class="btn btn-outline-warning" for="user_no">No</label>
                        </div>
                    </div>
                </div>

                <!-- CAMPO: INGRESE SU NÚMERO (si es 'si') -->
                <div id="user_si_section" class="mb-4">
                    <label for="numero_usuario" class="form-label">Ingrese su Número</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="numero_usuario" name="numero_usuario" placeholder="Número de Usuario o Teléfono">
                        <button class="btn btn-warning" type="button" id="checkUserBtn">Verificar</button>
                    </div>
                    <div id="user_info_card" class="card mt-3 d-none">
                        <div class="card-body">
                            <h5 class="card-title" id="user_info_nombre"></h5>
                            <p class="card-text mb-1"><strong class="me-2">Teléfono:</strong> <span id="user_info_telefono"></span></p>
                            <p class="card-text mb-1"><strong class="me-2">Servicio:</strong> <span id="user_info_servicio"></span></p>
                            <hr>
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-warning" id="solicitarViajeBtn">Solicitar otro Viaje</button>
                                <button type="button" class="btn btn-info" id="consultarViajesBtn">Consultar mis Viajes</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN: NUEVO USUARIO ('no') -->
                <div id="user_no_section" class="d-none">
                    <div class="mb-4">
                        <label for="tipo_servicio_nuevo" class="form-label">El servicio que requiere es:</label>
                        <select class="form-select" id="tipo_servicio_nuevo" name="tipo_servicio_nuevo">
                            {% for tipo in tipo_servicio_opciones %}
                            <option value="{{ tipo }}">{{ tipo }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- FORMULARIO PERSONAL (si el servicio es Particular) -->
                    <div id="form_personal" class="card mt-3 border-0 shadow-none">
                        <div class="card-body">
                            <h5 class="card-title text-warning">Datos Personales</h5>
                            <div class="mb-3">
                                <label for="nombre_personal" class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="nombre_personal" name="nombre_personal">
                            </div>
                            <div class="mb-3">
                                <label for="primer_apellido_personal" class="form-label">Primer Apellido</label>
                                <input type="text" class="form-control" id="primer_apellido_personal" name="primer_apellido_personal">
                            </div>
                            <div class="mb-3">
                                <label for="segundo_apellido_personal" class="form-label">Segundo Apellido</label>
                                <input type="text" class="form-control" id="segundo_apellido_personal" name="segundo_apellido_personal">
                            </div>
                            <div class="mb-3">
                                <label for="telefono_personal" class="form-label">Teléfono</label>
                                <input type="text" class="form-control" id="telefono_personal" name="telefono_personal" pattern="[0-9]{8}" maxlength="8" title="Debe ser un número de 8 dígitos">
                                <small class="form-text text-muted">Solo números, 8 dígitos exactos.</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FORMULARIO EMPRESARIAL (si el servicio es Empresarial) -->
                    <div id="form_empresarial" class="card mt-3 border-0 shadow-none d-none">
                        <div class="card-body">
                            <h5 class="card-title text-warning">Datos Empresariales</h5>
                            <p class="text-muted">Para una mejor atención nos comunicaremos con ustedes prontamente en horario de oficina 8:00am a 6:00pm.</p>
                            <div class="mb-3">
                                <label for="nombre_empresa" class="form-label">Nombre de la Empresa</label>
                                <input type="text" class="form-control" id="nombre_empresa" name="nombre_empresa">
                            </div>
                            <div class="mb-3">
                                <label for="nombre_contacto" class="form-label">Nombre de Contacto o Encargado(a)</label>
                                <input type="text" class="form-control" id="nombre_contacto" name="nombre_contacto">
                            </div>
                            <div class="mb-3">
                                <label for="telefono_empresa" class="form-label">Teléfono Empresa</label>
                                <input type="text" class="form-control" id="telefono_empresa" name="telefono_empresa" pattern="[0-9]{8}" maxlength="8" title="Debe ser un número de 8 dígitos">
                                <small class="form-text text-muted">Solo números, 8 dígitos exactos.</small>
                            </div>
                            <div class="mb-3">
                                <label for="extension" class="form-label">Extensión</label>
                                <input type="text" class="form-control" id="extension" name="extension" pattern="[0-9]{1,8}" title="Solo números">
                            </div>
                            <div class="mb-3">
                                <label for="whatsapp_empresa" class="form-label">Whatsapp</label>
                                <input type="text" class="form-control" id="whatsapp_empresa" name="whatsapp_empresa" pattern="[0-9]{8}" maxlength="8" title="Debe ser un número de 8 dígitos">
                                <small class="form-text text-muted">Solo números, 8 dígitos exactos.</small>
                            </div>
                            <div class="mb-3">
                                <label for="email_empresa" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email_empresa" name="email_empresa">
                            </div>
                            <div class="mb-3">
                                <label for="horario_atencion" class="form-label">Horario de Atención</label>
                                <input type="text" class="form-control" id="horario_atencion" name="horario_atencion">
                            </div>
                            <div class="mb-3">
                                <label for="nota_empresa" class="form-label">Nota</label>
                                <textarea class="form-control" id="nota_empresa" name="nota_empresa" placeholder="Si requiere puedes dejarnos una nota"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN: FORMULARIO DE VIAJE -->
                <div id="viaje_opciones_section" class="mt-4">
                    <div id="resto_formulario">
                        <h4 class="text-warning mb-4">Detalles del Viaje</h4>
                        <div class="mb-3">
                            <label for="a_donde_va" class="form-label">¿A Dónde Va?</label>
                            <input type="text" class="form-control" id="a_donde_va" name="a_donde_va">
                        </div>
                        
                        <div class="mb-3">
                            <label for="cantidad_personas" class="form-label">Cantidad de Personas</label>
                            <input type="number" class="form-control" id="cantidad_personas" name="cantidad_personas" min="1">
                            <div id="buseta_warning" class="alert alert-warning mt-2 d-none">
                                Vas a necesitar más de una buseta
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="actividad_select" class="form-label">Indicar su Actividad</label>
                            <select class="form-select" id="actividad_select" name="actividad_select">
                                {% for actividad in actividad_opciones %}
                                <option value="{{ actividad }}">{{ actividad }}</option>
                                {% endfor %}
                                <option value="Otro">Otro</option>
                            </select>
                            <input type="text" class="form-control mt-2 d-none" id="otra_actividad" name="otra_actividad" placeholder="Especifique la actividad">
                        </div>

                        <div class="mb-3">
                            <label for="lugar_salida" class="form-label">Lugar de Salida</label>
                            <input type="text" class="form-control" id="lugar_salida" name="lugar_salida">
                        </div>

                        <div class="mb-3">
                            <label for="lugar_destino" class="form-label">Lugar de Destino</label>
                            <input type="text" class="form-control" id="lugar_destino" name="lugar_destino">
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="puntos_encuentro_checkbox" name="puntos_encuentro_checkbox">
                            <label class="form-check-label" for="puntos_encuentro_checkbox">
                                Se requiere Puntos de Encuentro
                            </label>
                            <textarea class="form-control mt-2 d-none" id="puntos_encuentro_text" name="puntos_encuentro" placeholder="Describa los puntos de encuentro"></textarea>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="hora_salida" class="form-label">Hora de Salida</label>
                                <input type="time" class="form-control" id="hora_salida" name="hora_salida">
                            </div>
                            <div class="col-md-6">
                                <label for="hora_retorno" class="form-label">Hora de Retorno</label>
                                <input type="time" class="form-control" id="hora_retorno" name="hora_retorno">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="fecha" class="form-label">Fecha</label>
                            <input type="date" class="form-control" id="fecha" name="fecha">
                        </div>
                        
                        <div class="mb-3">
                            <label for="enlace_mapa" class="form-label">Si cuentas con un mapa, agrega el enlace de la ruta</label>
                            <input type="url" class="form-control" id="enlace_mapa" name="enlace_mapa" placeholder="Ej: https://maps.google.com/...">
                        </div>
                        
                        <div class="mb-3">
                            <label for="mapa_adjunto" class="form-label">O sube un mapa en formato GPX, KML o KMZ</label>
                            <input type="file" class="form-control" id="mapa_adjunto" name="mapa_adjunto_file" accept=".gpx,.kml,.kmz">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-warning w-100 mt-4" id="guardarSolicitudBtn">
                        Solicitar Viaje
                    </button>
                    <div id="solicitud_status" class="mt-3 text-center"></div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Cancelación de Servicio -->
<div class="modal fade" id="cancelarModal" tabindex="-1" aria-labelledby="cancelarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-0">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelarModalLabel">Cancelar un Servicio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="cancelarForm">
                    <p class="mb-2"><strong>Número de Solicitud:</strong> <span id="cancel_solicitud_numero"></span></p>
                    <input type="hidden" id="cancel_solicitud_id" name="solicitud_id">
                    <div class="mb-3">
                        <label for="razon_cancelacion" class="form-label">Razón de su Cancelación</label>
                        <textarea class="form-control" id="razon_cancelacion" name="razon_cancelacion" rows="5"></textarea>
                    </div>
                    <button type="submit" class="btn btn-danger w-100">Confirmar Cancelación</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const userSiRadio = document.getElementById('user_si');
        const userNoRadio = document.getElementById('user_no');
        const userSiSection = document.getElementById('user_si_section');
        const userNoSection = document.getElementById('user_no_section');
        const formPersonal = document.getElementById('form_personal');
        const formEmpresarial = document.getElementById('form_empresarial');
        const tipoServicioNuevo = document.getElementById('tipo_servicio_nuevo');
        const viajeOpcionesSection = document.getElementById('viaje_opciones_section');
        const checkUserBtn = document.getElementById('checkUserBtn');
        const numeroUsuarioInput = document.getElementById('numero_usuario');
        const userInfoCard = document.getElementById('user_info_card');
        const solicitarViajeBtn = document.getElementById('solicitarViajeBtn');
        const consultarViajesBtn = document.getElementById('consultarViajesBtn');
        const formElement = document.getElementById('solicitudForm');
        
        // Función para manejar el estado del formulario dinámico
        function handleFormState() {
            if (userSiRadio.checked) {
                userSiSection.classList.remove('d-none');
                userNoSection.classList.add('d-none');
                userInfoCard.classList.add('d-none');
                viajeOpcionesSection.classList.add('d-none');
            } else { // userNoRadio.checked
                userSiSection.classList.add('d-none');
                userNoSection.classList.remove('d-none');
                if (tipoServicioNuevo.value === 'Particular') {
                    formPersonal.classList.remove('d-none');
                    formEmpresarial.classList.add('d-none');
                    viajeOpcionesSection.classList.remove('d-none');
                } else { // Empresarial
                    formPersonal.classList.add('d-none');
                    formEmpresarial.classList.remove('d-none');
                    viajeOpcionesSection.classList.remove('d-none'); // Mostrar viaje para empresas también
                }
            }
        }
        
        // Manejar el evento de cambio en los radios de usuario
        userSiRadio.addEventListener('change', handleFormState);
        userNoRadio.addEventListener('change', handleFormState);

        // Manejar el evento de cambio en el select de tipo de servicio (si no es cuenta)
        tipoServicioNuevo.addEventListener('change', handleFormState);

        // Lógica de verificación de usuario
        checkUserBtn.addEventListener('click', function() {
            const numeroUsuario = numeroUsuarioInput.value;
            if (!numeroUsuario) {
                alert('Por favor, ingrese un número de usuario o teléfono.');
                return;
            }
            fetch('{{ url_for("solicitud.check_user") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ numero_usuario: numeroUsuario })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('user_info_nombre').textContent = data.nombre;
                    document.getElementById('user_info_telefono').textContent = data.telefono;
                    document.getElementById('user_info_servicio').textContent = data.es_empresarial ? 'Empresarial' : 'Particular';
                    
                    userInfoCard.dataset.userId = data.id;
                    userInfoCard.dataset.userName = data.nombre;
                    userInfoCard.dataset.userLastName = data.primer_apellido;
                    userInfoCard.dataset.userSecondLastName = data.segundo_apellido;
                    userInfoCard.dataset.userPhone = data.telefono;
                    
                    userInfoCard.classList.remove('d-none');
                    viajeOpcionesSection.classList.add('d-none'); // Ocultar por defecto
                    
                    window.userViajes = data.viajes;

                } else {
                    alert(data.message);
                    userInfoCard.classList.add('d-none');
                    viajeOpcionesSection.classList.add('d-none');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ocurrió un error al verificar el usuario.');
            });
        });
        
        // Lógica para poblar y mostrar el formulario de viaje para usuarios existentes
        solicitarViajeBtn.addEventListener('click', function() {
            const userId = userInfoCard.dataset.userId;
            const userName = userInfoCard.dataset.userName;
            const userLastName = userInfoCard.dataset.userLastName;
            const userSecondLastName = userInfoCard.dataset.userSecondLastName;
            const userPhone = userInfoCard.dataset.userPhone;

            // Limpiar el formulario de viaje antes de mostrarlo
            formElement.reset();
            
            // Llenar campos ocultos o dinámicos para el envío
            const hiddenUserIdInput = document.createElement('input');
            hiddenUserIdInput.type = 'hidden';
            hiddenUserIdInput.name = 'id';
            hiddenUserIdInput.value = userId;
            formElement.appendChild(hiddenUserIdInput);
            
            const hiddenUserHasAccountInput = document.createElement('input');
            hiddenUserHasAccountInput.type = 'hidden';
            hiddenUserHasAccountInput.name = 'userHasAccount';
            hiddenUserHasAccountInput.value = 'true';
            formElement.appendChild(hiddenUserHasAccountInput);

            // Mostrar la sección de viaje
            viajeOpcionesSection.classList.remove('d-none');
        });

        // Manejar el click en "Consultar mis Viajes"
        consultarViajesBtn.addEventListener('click', function() {
            let htmlContent = '';
            const viajes = window.userViajes || [];
            const viajesPendientes = viajes.filter(viaje => viaje.estado === 'Pendiente');
            const viajesCulminados = viajes.filter(viaje => viaje.estado === 'Culminado');

            if (viajesPendientes.length > 0) {
                htmlContent += `<h4 class="text-warning mb-4">Tus Viajes Pendientes</h4>`;
                viajesPendientes.forEach(viaje => {
                    htmlContent += `
                        <div class="card mb-3">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title">${viaje.destino}</h5>
                                    <p class="card-text text-muted">Fecha: ${viaje.fecha_viaje}</p>
                                </div>
                                <div>
                                    <a href="{{ url_for('solicitud.ver_detalle_solicitud', solicitud_id=0) }}".replace('0', viaje.id)" class="btn btn-sm btn-outline-info me-2">Ver detalles</a>
                                    <button type="button" class="btn btn-sm btn-outline-danger cancelar-viaje-btn" data-id="${viaje.id}" data-bs-toggle="modal" data-bs-target="#cancelarModal">Cancelar Viaje</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            if (viajesCulminados.length > 0) {
                htmlContent += `<h4 class="text-warning mt-4 mb-4">Viajes Culminados</h4>`;
                viajesCulminados.forEach(viaje => {
                    htmlContent += `
                        <div class="card mb-3">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title">${viaje.destino}</h5>
                                    <p class="card-text text-muted">Fecha: ${viaje.fecha_viaje}</p>
                                </div>
                                <div>
                                    <a href="{{ url_for('solicitud.ver_detalle_solicitud', solicitud_id=0) }}".replace('0', viaje.id)" class="btn btn-sm btn-outline-info me-2">Ver detalles</a>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            if (viajesPendientes.length === 0 && viajesCulminados.length === 0) {
                htmlContent = '<p class="text-center text-muted fst-italic">No tienes viajes registrados.</p>';
            }
            
            viajeOpcionesSection.innerHTML = htmlContent;
            viajeOpcionesSection.classList.remove('d-none');
        });
        
        // Obtener el botón de enviar
        const guardarSolicitudBtn = document.getElementById('guardarSolicitudBtn');

        // Evento para enviar el formulario con fetch (POST)
        guardarSolicitudBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            const data = {};
            const userHasAccount = userSiRadio.checked;

            // Recopilar datos de todas las secciones visibles
            const formSections = [userSiSection, userNoSection, viajeOpcionesSection];
            formSections.forEach(section => {
                if (!section.classList.contains('d-none')) {
                    const inputs = section.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        if (input.name && input.type !== 'file') {
                            data[input.name] = input.value;
                        }
                    });
                }
            });
            
            data.userHasAccount = userHasAccount;
            
            fetch('{{ url_for("solicitud.guardar_solicitud") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('solicitud_status');
                if (data.success) {
                    statusDiv.textContent = data.message;
                    statusDiv.className = 'mt-3 text-center text-success';
                    // Redirigir al registro
                    setTimeout(() => {
                        window.location.href = '{{ url_for("solicitud.registro_solicitudes") }}';
                    }, 2000);
                } else {
                    statusDiv.textContent = data.message;
                    statusDiv.className = 'mt-3 text-center text-danger';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const statusDiv = document.getElementById('solicitud_status');
                statusDiv.textContent = 'Ocurrió un error al procesar su solicitud.';
                statusDiv.className = 'mt-3 text-center text-danger';
            });
        });

        // Llamada inicial para configurar la vista
        handleFormState();

        // Lógica de validación de cantidad de personas
        document.getElementById('cantidad_personas').addEventListener('input', function() {
            const busetaWarning = document.getElementById('buseta_warning');
            if (this.value > 17) {
                busetaWarning.classList.remove('d-none');
            } else {
                busetaWarning.classList.add('d-none');
            }
        });

        // Lógica para mostrar/ocultar el campo "Otro"
        document.getElementById('actividad_select').addEventListener('change', function() {
            const otraActividadInput = document.getElementById('otra_actividad');
            if (this.value === 'Otro') {
                otraActividadInput.classList.remove('d-none');
            } else {
                otraActividadInput.classList.add('d-none');
            }
        });

        // Lógica para el checkbox de puntos de encuentro
        document.getElementById('puntos_encuentro_checkbox').addEventListener('change', function() {
            const textarea = document.getElementById('puntos_encuentro_text');
            if (this.checked) {
                textarea.classList.remove('d-none');
            } else {
                textarea.classList.add('d-none');
            }
        });
    });
</script>
{% endblock %}
