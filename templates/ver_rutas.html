{% extends 'base.html' %}


{% block content %}
    <title>Ver Rutas</title>
    <style>
        .route-name {
            font-weight: 500;
            color: black; /* Color de enlace primario cambiado a negro */
            text-decoration: none;
            font-size: 1.1rem; /* Tamaño de fuente por defecto para pantallas más grandes */
        }
        .route-name:hover {
            text-decoration: underline;
        }

        /* Estilos para el título principal con fondo gris claro */
        .main-title {
            background-color: #f0f0f0; /* Gris claro */
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px; /* Margen inferior para separar del filtro */
        }

        /* Estilos para el encabezado de categoría (sin fondo por defecto) y márgenes */
        .card-header-category {
            padding: 10px;
            border-radius: 8px;
            margin-top: 30px; /* Margen superior más amplio */
            margin-bottom: 20px; /* Margen inferior más amplio */
            color: black; /* Color de texto por defecto para las categorías */
        }
        /* Nuevo estilo específico para el título "Otros" */
        .other-category-title-bg {
            background-color: #f0f0f0; /* Gris claro */
        }

        /* Estilos específicos para el botón flotante (FAB) de crear ruta */
        .btn-add-route {
            position: fixed;
            bottom: 70px; /* Distancia desde abajo */
            right: 20px; /* Distancia desde la derecha */
            z-index: 2000;
            width: 60px; /* Tamaño del botón */
            height: 60px; /* Tamaño del botón */
            border-radius: 50%; /* Hacerlo circular */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem; /* Tamaño del icono */
            transition: all 0.3s ease;
            background-color: #ffc107; /* Color de fondo warning */
            color: #212529; /* Color de texto oscuro para contraste */
            border: none;
            text-decoration: none;
        }
        .btn-add-route i {
            color: black;
        }
        .btn-add-route:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            background-color: #e0a800;
        }

        /* Estilos específicos para el botón flotante (FAB) de volver atrás */
        .fab-container-back {
            position: fixed;
            bottom: 70px;
            left: 20px;
            right: auto;
            z-index: 2000;
        }
        .fab-button-back {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            transition: all 0.3s ease;
            background-color: #007bff; /* Color de fondo primary (azul) */
            color: #ffffff;
            border: none;
            text-decoration: none;
        }
        .fab-button-back:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            background-color: #0056b3;
        }

        /* NUEVOS ESTILOS para los botones flotantes de exportación */
        .fab-container-export {
            position: fixed;
            right: 20px; /* Misma posición horizontal que el botón de añadir */
            z-index: 1000;
            display: flex;
            flex-direction: column; /* Apilar verticalmente */
            align-items: flex-end; /* Alinear a la derecha */
        }
        .fab-button-export {
            width: 50px; /* Un poco más pequeños que los principales */
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem; /* Aumentado para que el icono de WhatsApp se vea mejor */
            transition: all 0.3s ease;
            color: #ffffff;
            border: none;
            text-decoration: none;
            margin-bottom: 10px; /* Espacio entre botones */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .fab-button-export:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .fab-button-export.pdf { background-color: #dc3545; } /* Rojo para PDF */
        .fab-button-export.txt { background-color: #6c757d; } /* Gris para TXT */
        .fab-button-export.whatsapp { background-color: #25D366; } /* Color oficial de WhatsApp */
        .fab-button-export.copy-link { background-color: #0d6efd; } /* Azul para copiar enlace */


        /* Ajuste de posición para los botones de exportación para que no choquen con el de añadir */
        .fab-container-export {
            bottom: 140px; /* Empieza más arriba que el botón de añadir ruta */
        }
        /* Media query para pantallas pequeñas (móviles) */
        @media (max-width: 768px) {
            .route-name {
                font-size: 0.9rem; /* Tamaño de fuente más pequeño para móviles */
            }
            /* Ajuste de posición de los FABs para móviles si es necesario */
            .fab-container-export {
                bottom: 130px; /* Ajuste para móviles */
                right: 15px;
            }
            .btn-add-route {
                bottom: 40px; /* Ajuste para móviles */
                right: 15px;
            }
            .fab-container-back {
                bottom: 40px; /* Ajuste para móviles */
                left: 15px;
            }
        }
        /* Estilos para el separador de mes */
        .month-separator {
            padding: 8px;
            border-radius: 6px;
            margin-top: 25px; /* Margen superior para separar de la lista anterior */
            margin-bottom: 5px; /* Margen inferior reducido para acercar la HR */
            text-align: center;
            font-weight: bold;
            color: #343a40; /* Color de texto oscuro */
            font-size: 1.2rem;
        }
        /* Estilo para la línea horizontal de advertencia */
        .hr-warning {
            border: 0;
            height: 2px;
            background-color: #ffc107; /* Color warning de Bootstrap */
            margin-bottom: 15px; /* Margen inferior para separar de la lista siguiente */
        }
        
        /* Estilos para la notificación Toast */
        #toast-notification {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 3000;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            opacity: 0;
            transition: opacity 0.5s, visibility 0.5s;
        }

        #toast-notification.show {
            visibility: visible;
            opacity: 1;
        }

        /* Estilos para las insignias de dificultad con colores pastel */
        .badge-dificultad {
            padding: 0.4em 0.6em;
            font-size: 0.85rem;
            border-radius: 0.25rem;
            font-weight: 500;
        }
        .badge-text-light {
            color: #fff;
        }
        .badge-text-dark {
            color: #212529;
        }
        .badge-basico {
            background-color: #A8D8B9; /* Verde Pastel */
        }
        .badge-intermedio {
            background-color: #F5CBA7; /* Naranja Pastel */
        }
        .badge-dificil {
            background-color: #F5B7B1; /* Rojo Pastel */
        }
        .badge-avanzado {
            background-color: #E59866; /* Terracota/Rojo Oscuro Pastel */
        }
        .badge-tecnico {
            background-color: #C3B1E1; /* Lila Pastel */
        }
        .badge-desconocida {
            background-color: #d3d3d3; /* Gris claro */
            color: #fff;
        }

        /* NUEVO: Estilo para ocultar badges cuando el contenedor tiene la clase 'difficulty-hidden' */
        .difficulty-hidden .badge-dificultad {
            display: none !important;
        }
    </style>

<div class="container mt-4 {% if not difficulty_visible %}difficulty-hidden{% endif %}">
    <h1 class="main-title text-center mb-4 text-dark">Rutas Disponibles</h1>

    <!-- Formulario de filtro con Provincia y Dificultad -->
    <div class="mb-4">
        <form action="{{ url_for('rutas.ver_rutas') }}" method="GET" class="row g-3 align-items-end">
            <div class="col-md-6">
                <label for="categoria-filter" class="form-label">Buscar por Provincia:</label>
                <select class="form-select" id="categoria-filter" name="categoria">
                    {% for categoria in categorias_busqueda %}
                        {% if categoria == 'Otros' %}
                            <option value="{{ categoria }}" disabled class="font-weight-bold">{{ categoria }}</option>
                        {% else %}
                            <option value="{{ categoria }}" {% if provincia_seleccionada == categoria %}selected{% endif %}>{{ categoria }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="dificultad-filter" class="form-label">Buscar por Dificultad:</label>
                <select class="form-select" id="dificultad-filter" name="dificultad">
                    <option value="Todas" {% if not dificultad_seleccionada or dificultad_seleccionada == 'Todas' %}selected{% endif %}>Todas las Dificultades</option>
                    {% for d in dificultades %}
                        <option value="{{ d }}" {% if dificultad_seleccionada == d %}selected{% endif %}>{{ d }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Buscar</button>
            </div>
        </form>
    </div>

    <!-- INICIO: Control de visibilidad de dificultad -->
    <div class="mb-4 d-flex justify-content-start">
        <a href="{{ url_for('rutas.ver_rutas', toggle_difficulty='1', categoria=provincia_seleccionada, dificultad=dificultad_seleccionada) }}" class="btn btn-outline-info btn-sm">
            <i class="fas fa-retweet me-1"></i> Alternar Visibilidad de Dificultad
        </a>
    </div>
    <!-- FIN: Control de visibilidad de dificultad -->


    {% set has_any_routes = false %}
    {# Diccionario para mapear dificultad a clases CSS (color de fondo y texto) #}
    {% set dificultad_classes = {
        'Básico': 'badge-text-dark badge-basico',
        'Intermedio': 'badge-text-dark badge-intermedio',
        'Difícil': 'badge-text-dark badge-dificil',
        'Avanzado': 'badge-text-light badge-avanzado',
        'Técnico': 'badge-text-light badge-tecnico',
        'Desconocida': 'badge-text-light badge-desconocida'
    } %}

    {% for categoria_display in categorias_busqueda %}
        {% if categoria_display != 'Todas las Categorías' %}
            {% set rutas_en_categoria = rutas_por_categoria.get(categoria_display) %}

            {% if categoria_display == 'Otros' %}
                {% if rutas_por_categoria.get('Internacional') or rutas_por_categoria.get('Caminatas Programadas') or rutas_por_categoria.get('Caminatas por Reconocer') %}
                    <div class="mb-5">
                        <div class="card-header-category other-category-title-bg mt-5 text-dark">
                            <h1 class="text-center text-dark">{{ categoria_display }}</h1>
                            <hr>
                        </div>
                    </div>
                    {% if rutas_por_categoria.get('Internacional') and rutas_por_categoria.get('Internacional').get('rutas_sin_fecha') %}
                        <div class="mb-4">
                            <div class="card-header-category mt-5">
                                <h2 class="text-center text-dark">Internacional</h2>
                                <hr>
                            </div>
                            <div>
                                <ul class="list-unstyled">
                                    {% for ruta in rutas_por_categoria.get('Internacional').get('rutas_sin_fecha') %}
                                        <li class="route-item">
                                            <div>
                                                <span class="me-2 text-muted">{{ loop.index }}.</span>
                                                <a href="{{ url_for('rutas.detalle_ruta', ruta_id=ruta.id) }}" class="route-name">
                                                    {{ ruta.nombre }}
                                                    {% if ruta.dificultad and ruta.dificultad != 'Desconocida' %}
                                                        <span class="badge badge-dificultad {{ dificultad_classes.get(ruta.dificultad, 'bg-secondary') }} ms-1">{{ ruta.dificultad }}</span>
                                                    {% endif %}
                                                    {% if ruta.fecha %} - {{ ruta.fecha.strftime('%d/%m/%y') }}{% endif %}
                                                    {% if ruta.precio is not none %} - ¢{{ ruta.precio|int }}{% endif %}
                                                    {% if ruta.gpx_file_url or ruta.kml_file_url or ruta.kmz_file_url %}
                                                        <i class="fas fa-map-marker-alt ms-2 text-primary" title="Esta ruta tiene un mapa asociado"></i>
                                                    {% endif %}
                                                </a>
                                            </div>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    {% endif %}

                    {% if rutas_por_categoria.get('Caminatas por Reconocer') and rutas_por_categoria.get('Caminatas por Reconocer').get('rutas_sin_fecha') %}
                        <div class="mb-4">
                            <div class="card-header-category mt-5">
                                <h2 class="text-center text-dark">Caminatas por Reconocer</h2>
                                <hr>
                            </div>
                            <div>
                                <ul class="list-unstyled">
                                    {% for ruta in rutas_por_categoria.get('Caminatas por Reconocer').get('rutas_sin_fecha') %}
                                        <li class="route-item">
                                            <div>
                                                <span class="me-2 text-muted">{{ loop.index }}.</span>
                                                <a href="{{ url_for('rutas.detalle_ruta', ruta_id=ruta.id) }}" class="route-name">
                                                    {{ ruta.nombre }}
                                                    {% if ruta.dificultad and ruta.dificultad != 'Desconocida' %}
                                                        <span class="badge badge-dificultad {{ dificultad_classes.get(ruta.dificultad, 'bg-secondary') }} ms-1">{{ ruta.dificultad }}</span>
                                                    {% endif %}
                                                    {% if ruta.fecha %} - {{ ruta.fecha.strftime('%d/%m/%y') }}{% endif %}
                                                    {% if ruta.precio is not none %} - ¢{{ ruta.precio|int }}{% endif %}
                                                    {% if ruta.gpx_file_url or ruta.kml_file_url or ruta.kmz_file_url %}
                                                        <i class="fas fa-map-marker-alt ms-2 text-primary" title="Esta ruta tiene un mapa asociado"></i>
                                                    {% endif %}
                                                </a>
                                            </div>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>

                            {# --- INICIO: NUEVO GRÁFICO DE BARRAS --- #}
                            {% if reconocer_chart_data and reconocer_chart_data != '{"labels": [], "data": []}' %}
                            <div class="mt-5 pt-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4 id="reconocerChartTitle" class="text-dark mb-0">Dificultad de Rutas por Reconocer</h4>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-secondary" onclick="changeReconocerChartType('bar')"><i class="fas fa-chart-bar"></i></button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="changeReconocerChartType('pie')"><i class="fas fa-chart-pie"></i></button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="changeReconocerChartType('line')"><i class="fas fa-chart-line"></i></button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="toggleChartVisibility(['reconocerChartTitle', 'reconocerChartCanvasContainer'], 'reconocerChartVisible')"><i class="fas fa-eye"></i></button>
                                    </div>
                                </div>
                                <div id="reconocerChartCanvasContainer" style="width: 100%; max-width: 800px; margin: auto; padding: 0 15px;">
                                    <canvas id="reconocerBarChart"></canvas>
                                </div>
                            </div>
                            {% endif %}
                            {# --- FIN: NUEVO GRÁFICO DE BARRAS --- #}
                        </div>
                    {% endif %}

                    {% if rutas_por_categoria.get('Caminatas Programadas') %}
                        <div class="mb-4">
                            <div class="card-header-category mt-5">
                                <h2 class="text-center text-dark">Caminatas Programadas</h2>
                                <hr>
                            </div>
                            {% for mes_anio, rutas_mes in rutas_por_categoria.get('Caminatas Programadas').items() %}
                                {% if mes_anio != 'rutas_sin_fecha' %}
                                    <div class="month-separator text-end text-warning">{{ mes_anio }}</div>
                                    
                                    <div>
                                        <ul class="list-unstyled">
                                            {% for ruta in rutas_mes %}
                                                <li class="route-item">
                                                    <div>
                                                        <span class="me-2 text-muted">{{ loop.index }}.</span>
                                                        <a href="{{ url_for('rutas.detalle_ruta', ruta_id=ruta.id) }}" class="route-name">
                                                            {{ ruta.nombre }}
                                                            {% if ruta.dificultad and ruta.dificultad != 'Desconocida' %}
                                                                <span class="badge badge-dificultad {{ dificultad_classes.get(ruta.dificultad, 'bg-secondary') }} ms-1">{{ ruta.dificultad }}</span>
                                                            {% endif %}
                                                            {% if ruta.fecha %} - {{ ruta.fecha.strftime('%d/%m/%y') }}{% endif %}
                                                            {% if ruta.precio is not none %} - ¢{{ ruta.precio|int }}{% endif %}
                                                            {% if ruta.gpx_file_url or ruta.kml_file_url or ruta.kmz_file_url %}
                                                                <i class="fas fa-map-marker-alt ms-2 text-primary" title="Esta ruta tiene un mapa asociado"></i>
                                                            {% endif %}
                                                        </a>
                                                    </div>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}
                            {% endfor %}
                            {% if rutas_por_categoria.get('Caminatas Programadas').get('rutas_sin_fecha') %}
                             
                                    <ul class="list-unstyled">
                                        {% for ruta in rutas_por_categoria.get('Caminatas Programadas').get('rutas_sin_fecha') %}
                                            <li class="route-item">
                                                <div>
                                                    <span class="me-2 text-muted">{{ loop.index }}.</span>
                                                    <a href="{{ url_for('rutas.detalle_ruta', ruta_id=ruta.id) }}" class="route-name">
                                                        {{ ruta.nombre }}
                                                        {% if ruta.dificultad and ruta.dificultad != 'Desconocida' %}
                                                            <span class="badge badge-dificultad {{ dificultad_classes.get(ruta.dificultad, 'bg-secondary') }} ms-1">{{ ruta.dificultad }}</span>
                                                        {% endif %}
                                                        {% if ruta.fecha %} - {{ ruta.fecha.strftime('%d/%m/%y') }}{% endif %}
                                                        {% if ruta.precio is not none %} - ¢{{ ruta.precio|int }}{% endif %}
                                                        {% if ruta.gpx_file_url or ruta.kml_file_url or ruta.kmz_file_url %}
                                                            <i class="fas fa-map-marker-alt ms-2 text-primary" title="Esta ruta tiene un mapa asociado"></i>
                                                        {% endif %}
                                                    </a>
                                                </div>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endif %}

            {% elif categoria_display not in ['Otros', 'Internacional', 'Caminatas Programadas', 'Caminatas por Reconocer'] and rutas_en_categoria and rutas_en_categoria.get('rutas_sin_fecha') %}
                {% set has_any_routes = true %}
                <div class="mb-4">
                    <div class="card-header-category mt-5">
                        <h2 class="text-center text-dark">{{ categoria_display }}</h2>
                        <hr>
                    </div>
                    <div>
                        <ul class="list-unstyled">
                            {% for ruta in rutas_en_categoria.get('rutas_sin_fecha') %}
                                <li class="route-item">
                                    <div>
                                        <span class="me-2 text-muted">{{ loop.index }}.</span>
                                        <a href="{{ url_for('rutas.detalle_ruta', ruta_id=ruta.id) }}" class="route-name">
                                            {{ ruta.nombre }}
                                            {% if ruta.dificultad and ruta.dificultad != 'Desconocida' %}
                                                <span class="badge badge-dificultad {{ dificultad_classes.get(ruta.dificultad, 'bg-secondary') }} ms-1">{{ ruta.dificultad }}</span>
                                            {% endif %}
                                            {% if ruta.fecha %} - {{ ruta.fecha.strftime('%d/%m/%y') }}{% endif %}
                                            {% if ruta.precio is not none %} - ¢{{ ruta.precio|int }}{% endif %}
                                            {% if ruta.gpx_file_url or ruta.kml_file_url or ruta.kmz_file_url %}
                                                <i class="fas fa-map-marker-alt ms-2 text-primary" title="Esta ruta tiene un mapa asociado"></i>
                                            {% endif %}
                                        </a>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            {% endif %}
        {% endif %}
    {% endfor %}

    {% if not rutas_por_categoria and (provincia_seleccionada == 'Todas las Categorías' and dificultad_seleccionada == 'Todas') %}
        <div class="alert alert-info text-center" role="alert">
            No hay rutas disponibles. ¡Crea una nueva!
        </div>
    {% elif not rutas_por_categoria %}
        <div class="alert alert-info text-center" role="alert">
            No se encontraron rutas con los filtros seleccionados.
        </div>
    {% endif %}


    {% if session.get('role') == 'Superuser' %}
    <a href="{{ url_for('rutas.crear_ruta') }}" class="btn btn-success btn-add-route" title="Crear nueva ruta">
        <i class="fas fa-plus"></i>
    </a>
    {% endif %}

    {# --- INICIO: GRÁFICO CIRCULAR GENERAL --- #}
    {% if chart_data and chart_data != '{"labels": [], "data": []}' %}
    <div class="mt-5 pt-4">
        <hr class="hr-warning" style="height: 3px; background-color: #ffc107; opacity: 1;">
        <div class="d-flex justify-content-between align-items-center mb-3">
             <h4 id="generalChartTitle" class="text-dark mb-0">Distribución de Rutas</h4>
            <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-secondary" onclick="changeGeneralChartType('bar')"><i class="fas fa-chart-bar"></i></button>
                <button type="button" class="btn btn-outline-secondary" onclick="changeGeneralChartType('pie')"><i class="fas fa-chart-pie"></i></button>
                <button type="button" class="btn btn-outline-secondary" onclick="changeGeneralChartType('line')"><i class="fas fa-chart-line"></i></button>
                <button type="button" class="btn btn-outline-secondary" onclick="toggleChartVisibility(['generalChartTitle', 'generalChartCanvasContainer'], 'generalChartVisible')"><i class="fas fa-eye"></i></button>
            </div>
        </div>
        <div id="generalChartCanvasContainer" style="width: 100%; max-width: 600px; margin: auto; padding: 0 15px;">
            <canvas id="rutasPieChart"></canvas>
        </div>
    </div>
    {% endif %}
    {# --- FIN: GRÁFICO CIRCULAR GENERAL --- #}
</div>

{# Elemento para la notificación Toast (inicialmente oculto) #}
<div id="toast-notification">¡Enlace copiado al portapapeles!</div>

{# Botón flotante para VOLVER ATRÁS #}
<div class="fab-container-back">
    <a href="{{ url_for('caminatas.ver_caminatas') }}" class="fab-button-back" title="Volver a Caminatas">
        <i class="fas fa-arrow-left"></i>
    </a>
</div>

{# NUEVOS BOTONES FLOTANTES PARA EXPORTAR Y COMPARTIR #}
<div class="fab-container-export">
    <a href="#" id="copyLinkButton" class="fab-button-export copy-link" title="Compartir Enlace">
        <i class="fas fa-share-alt"></i>
    </a>
    <!-- <a href="#" id="whatsappShareButton" class="fab-button-export whatsapp" title="Compartir por WhatsApp">
        <i class="fab fa-whatsapp"></i>
    </a> -->
    <a href="{{ url_for('rutas.exportar_todas_rutas_pdf', categoria=provincia_seleccionada) }}" class="fab-button-export pdf" title="Exportar a PDF">
        <i class="fas fa-file-pdf"></i>
    </a>
    <a href="{{ url_for('rutas.exportar_todas_rutas_txt', categoria=provincia_seleccionada) }}" class="fab-button-export txt" title="Exportar a TXT">
        <i class="fas fa-file-alt"></i>
    </a>
</div>

{% endblock %}

{% block scripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    
    <!-- CDN de Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        let generalChart;
        const generalChartColors = [
            'rgba(168, 216, 185, 0.8)', 'rgba(245, 203, 167, 0.8)',
            'rgba(245, 183, 177, 0.8)', 'rgba(195, 177, 225, 0.8)',
            'rgba(174, 214, 241, 0.8)', 'rgba(249, 231, 159, 0.8)',
            'rgba(213, 216, 220, 0.8)', 'rgba(241, 196, 15, 0.8)',
            'rgba(130, 224, 170, 0.8)', 'rgba(245, 176, 65, 0.8)'
        ];

        // --- INICIO: LÓGICA PARA GRÁFICO GENERAL ---
        {% if chart_data and chart_data != '{"labels": [], "data": []}' %}
            const chartData = JSON.parse('{{ chart_data | safe }}');
            if (chartData.labels && chartData.labels.length > 0) {
                const ctx = document.getElementById('rutasPieChart').getContext('2d');
                generalChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: 'Número de Rutas',
                            data: chartData.data,
                            backgroundColor: generalChartColors,
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: true,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1) + '%';
                                        return `${label}: ${value} rutas (${percentage})`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        {% endif %}

        window.changeGeneralChartType = function(newType) {
            if (generalChart) {
                if (newType === 'line') {
                    generalChart.data.datasets.forEach(dataset => {
                        dataset.borderColor = '#0d6efd';
                        dataset.backgroundColor = 'rgba(13, 110, 253, 0.1)';
                        dataset.tension = 0.1;
                    });
                } else {
                    generalChart.data.datasets.forEach(dataset => {
                        dataset.backgroundColor = generalChartColors;
                        dataset.borderColor = (newType === 'pie') ? '#ffffff' : generalChartColors;
                    });
                }
                generalChart.config.type = newType;
                generalChart.update();
            }
        }
        // --- FIN: LÓGICA PARA GRÁFICO GENERAL ---

        // --- INICIO: LÓGICA PARA GRÁFICO 'POR RECONOCER' ---
        let reconocerChart;
        const reconocerChartColors = [
            'rgba(168, 216, 185, 0.7)', 'rgba(245, 203, 167, 0.7)',
            'rgba(245, 183, 177, 0.7)', 'rgba(229, 152, 102, 0.7)',
            'rgba(195, 177, 225, 0.7)', 'rgba(211, 211, 211, 0.7)'
        ];
        const reconocerChartBorders = ['#A8D8B9', '#F5CBA7', '#F5B7B1', '#E59866', '#C3B1E1', '#d3d3d3'];

        {% if reconocer_chart_data and reconocer_chart_data != '{"labels": [], "data": []}' %}
            const reconocerChartData = JSON.parse('{{ reconocer_chart_data | safe }}');
            if (reconocerChartData.labels && reconocerChartData.labels.length > 0) {
                const ctxReconocer = document.getElementById('reconocerBarChart').getContext('2d');
                reconocerChart = new Chart(ctxReconocer, {
                    type: 'bar',
                    data: {
                        labels: reconocerChartData.labels,
                        datasets: [{
                            label: 'Número de Rutas',
                            data: reconocerChartData.data,
                            backgroundColor: reconocerChartColors,
                            borderColor: reconocerChartBorders,
                            borderWidth: 1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false }, title: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            }
        {% endif %}

        window.changeReconocerChartType = function(newType) {
            if (reconocerChart) {
                if (newType === 'line') {
                    reconocerChart.data.datasets.forEach(dataset => {
                        dataset.borderColor = '#fd7e14';
                        dataset.backgroundColor = 'rgba(253, 126, 20, 0.1)';
                        dataset.tension = 0.1;
                    });
                } else {
                    reconocerChart.data.datasets.forEach(dataset => {
                        dataset.backgroundColor = reconocerChartColors;
                        dataset.borderColor = (newType === 'pie') ? '#ffffff' : reconocerChartBorders;
                    });
                }
                reconocerChart.config.type = newType;
                reconocerChart.update();
            }
        }
        // --- FIN: LÓGICA PARA GRÁFICO 'POR RECONOCER' ---

        // --- INICIO: LÓGICA PARA VISIBILIDAD DE GRÁFICOS ---
        window.toggleChartVisibility = function(elementIds, storageKey) {
            const icon = event.currentTarget.querySelector('i');
            let isVisible = localStorage.getItem(storageKey) !== 'false';

            elementIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = isVisible ? 'none' : 'block';
                }
            });

            localStorage.setItem(storageKey, !isVisible);
            icon.classList.toggle('fa-eye', !isVisible);
            icon.classList.toggle('fa-eye-slash', isVisible);
        };

        // Restaurar estado de visibilidad al cargar la página
        function restoreVisibility(elementIds, storageKey) {
            const isVisible = localStorage.getItem(storageKey) !== 'false';
            const buttonIcon = document.querySelector(`button[onclick*="${storageKey}"] i`);

            if (!isVisible) {
                elementIds.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.style.display = 'none';
                });
                if (buttonIcon) {
                    buttonIcon.classList.remove('fa-eye');
                    buttonIcon.classList.add('fa-eye-slash');
                }
            }
        }

        restoreVisibility(['generalChartTitle', 'generalChartCanvasContainer'], 'generalChartVisible');
        restoreVisibility(['reconocerChartTitle', 'reconocerChartCanvasContainer'], 'reconocerChartVisible');
        // --- FIN: LÓGICA PARA VISIBILIDAD DE GRÁFICOS ---


        // --- INICIO: LÓGICA PARA BOTONES DE COMPARTIR ---
        const whatsappShareButton = document.getElementById('whatsappShareButton');
        if (whatsappShareButton) {
            whatsappShareButton.addEventListener('click', (event) => {
                event.preventDefault();
                const text = '¡Hola! Te comparto este enlace para que veas las rutas de La Tribu CR:';
                const url = 'https://www.latribucr.site/rutas/rutas';
                const message = encodeURIComponent(`${text} ${url}`);
                const whatsappUrl = `https://wa.me/?text=${message}`;
                window.open(whatsappUrl, '_blank');
            });
        }

        const copyLinkButton = document.getElementById('copyLinkButton');
        if (copyLinkButton) {
            copyLinkButton.addEventListener('click', async (event) => {
                event.preventDefault();
                const shareData = {
                    title: 'Rutas de La Tribu CR',
                    text: 'Descubre todas las rutas y caminatas disponibles.',
                    url: 'https://www.latribucr.site/rutas/rutas'
                };

                try {
                    if (navigator.share) {
                        await navigator.share(shareData);
                    } else {
                        throw new Error('Share API not supported');
                    }
                } catch (err) {
                    try {
                        const textArea = document.createElement('textarea');
                        textArea.value = shareData.url;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-9999px';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);

                        const toast = document.getElementById('toast-notification');
                        toast.className = 'show';
                        setTimeout(function(){ toast.className = toast.className.replace('show', ''); }, 3000);
                    } catch (copyErr) {
                        console.error('Error al copiar al portapapeles:', copyErr);
                    }
                }
            });
        }
        // --- FIN: LÓGICA PARA BOTONES DE COMPARTIR ---
    });
    </script>
{% endblock %}
