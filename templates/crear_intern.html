{% extends 'base.html' %}

{% block title %}Crear Plan de Viaje Internacional{% endblock %}

{% block head_content %}
<style>
    .main-container {
        padding-top: 80px;
        padding-bottom: 80px;
    }
    .section-container {
        margin-bottom: 2.5rem;
        border: 1px solid #dee2e6;
        border-radius: .375rem;
        padding: 1.5rem;
        background-color: #fff;
    }
    .section-header {
        font-weight: bold;
        padding: 0.75rem 1.25rem;
        margin: -1.5rem -1.5rem 1.5rem -1.5rem;
        border-bottom: 1px solid #dee2e6;
        border-top-left-radius: .375rem;
        border-top-right-radius: .375rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .bg-warning {
        background-color: #ffc107 !important;
        color: #000;
    }
    .total-field {
        font-weight: bold;
        font-size: 1.2rem;
        text-align: right;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #dee2e6;
    }
    .dynamic-item {
        border: 1px dashed #ccc;
        padding: 1.5rem;
        padding-top: 2rem;
        margin-bottom: 1rem;
        background-color: #f8f9fa;
        position: relative;
        border-radius: .375rem;
    }
    .item-counter {
        position: absolute;
        top: -12px;
        left: -12px;
        background-color: #ffc107;
        color: black;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        border: 2px solid white;
    }
    .btn-remove-item {
        position: absolute;
        top: 10px;
        right: 10px;
    }
    .details-toggle {
        margin-top: 1rem;
    }
    .fab-container-back {
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 1000;
    }
    .fab-button-back {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        transition: all 0.3s ease;
        background-color: #6c757d;
        color: white;
        border: none;
        text-decoration: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .fab-button-back:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        background-color: #5c636a;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5 mb-5 main-container">
    <h1 class="mb-4 text-center">Crear Nuevo Plan de Viaje Internacional</h1>
    
    <form action="{{ url_for('intern.crear_intern') }}" method="POST" enctype="multipart/form-data">
        
        <!-- SECCIÓN DESTINO -->
        <div class="section-container">
            <div class="section-header bg-warning">DESTINO</div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="nombre_viaje" class="form-label">Nombre del Viaje</label>
                    <input type="text" class="form-control" id="nombre_viaje" name="nombre_viaje" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="flyer_file" class="form-label">Flyer (Imagen)</label>
                    <input type="file" class="form-control" id="flyer_file" name="flyer_file" accept="image/png, image/jpeg, image/gif">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="precio_paquete" class="form-label">Precio Paquete (por persona)</label>
                    <input type="number" step="0.01" class="form-control" id="precio_paquete" name="precio_paquete" value="0" oninput="updateGrandTotals()">
                </div>
                <div class="col-md-6 mb-3" id="tipo-cambio-wrapper">
                    <label for="tipo_cambio" class="form-label">Tipo de Cambio (USD a CRC)</label>
                    <input type="number" step="0.01" class="form-control" id="tipo_cambio" name="tipo_cambio" value="500" oninput="updateGrandTotals()">
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="pais" class="form-label">País</label>
                    <select class="form-select" id="pais" name="pais" required>
                        <option value="" disabled selected>Seleccione un destino</option>
                        {% for p in paises %}
                        <option value="{{ p }}">{{ p }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- SECCIÓN PRE-ALERTAS -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>LLAMADO PRE-ALERTA</span>
                <button type="button" class="btn btn-sm btn-dark" onclick="addPreAlerta()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="prealertas-container"></div>
        </div>

        <!-- SECCIÓN LUGARES A VISITAR -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>Atracciones</span>
                 <button type="button" class="btn btn-sm btn-dark" onclick="addLugar()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="lugares-container"></div>
            <div class="total-field">TOTAL DE ATRACCIONES POR PERSONA: <span class="currency-label">USD</span> <span id="total-atracciones">0.00</span></div>
        </div>

        <!-- SECCIÓN TRANSPORTES LOCALES -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>Transportes Locales</span>
                <button type="button" class="btn btn-sm btn-dark" onclick="addTransporte()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="transportes-container"></div>
            <div class="total-field">TOTAL DE TRANSPORTE POR PERSONA: <span class="currency-label">USD</span> <span id="total-transporte">0.00</span></div>
        </div>

        <!-- SECCIÓN GUÍAS -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>Guías</span>
                <button type="button" class="btn btn-sm btn-dark" onclick="addGuia()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="guias-container"></div>
            <div class="total-field">TOTAL DE GUÍAS POR PERSONA: <span class="currency-label">USD</span> <span id="total-guias">0.00</span></div>
        </div>
        
        <!-- SECCIÓN ESTADÍAS -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>Estadías</span>
                <button type="button" class="btn btn-sm btn-dark" onclick="addEstadia()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="estadias-container"></div>
            <div class="total-field">TOTAL DE ESTADÍA POR PERSONA: <span class="currency-label">USD</span> <span id="total-estadia">0.00</span></div>
        </div>

        <!-- SECCIÓN AEROLÍNEA / TRANSPORTE PRINCIPAL -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>Aerolínea / Transporte Principal</span>
                <button type="button" class="btn btn-sm btn-dark" onclick="addAerolinea()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="aerolineas-container"></div>
            <div class="total-field">TOTAL DE TRANSPORTE PRINCIPAL POR PERSONA: <span class="currency-label">USD</span> <span id="total-aerolinea">0.00</span></div>
        </div>

        <!-- SECCIÓN DE TOTALES GENERALES -->
        <div class="section-container text-center">
            <div class="section-header bg-warning justify-content-center">TOTALES GENERALES POR PERSONA</div>
            <div class="row">
                <div class="col-md-6" id="total-crc-wrapper">
                    <p class="total-field" style="border-top: none; text-align: center;">TOTAL INDIVIDUAL (CRC): <span class="badge bg-success fs-5" id="total-crc">0.00</span></p>
                </div>
                <div class="col-md-6" id="total-usd-wrapper">
                    <p class="total-field" style="border-top: none; text-align: center;">TOTAL INDIVIDUAL (USD): <span class="badge bg-primary fs-5" id="total-usd">0.00</span></p>
                </div>
            </div>
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-warning btn-lg">Crear Plan de Viaje</button>
        </div>
    </form>
    
    <!-- Botón Flotante para Volver -->
    <div class="fab-container-back">
        <a href="{{ url_for('intern.index') }}" class="fab-button-back" title="Volver al Listado">
            <i class="fas fa-arrow-left"></i>
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // --- Contadores inicializados para evitar colisiones de ID ---
    let preAlertaCount = 0;
    let lugarCount = 0;
    let transporteCount = 0;
    let guiaCount = 0;
    let estadiaCount = 0;
    let aerolineaCount = 0;
    
    // Asumiendo que AEROLINEA_OPTIONS se pasa desde el backend (Flask)
    // Asegúrate de que tu ruta Flask en intern.py que renderiza crear_intern.html
    // pase esta variable, por ejemplo:
    // return render_template('crear_intern.html', aerolineas_opciones=aerolineas_opciones, ...)
    // Y en el HTML de crear_intern.html:
    // const AEROLINEA_OPTIONS = {{ aerolineas_opciones | tojson | safe }};
    // Si no tienes el `tojson` filtro disponible, puedes hacer un arreglo simple manualmente:
    const AEROLINEA_OPTIONS = ["Avianca", "American Airlines", "Copa", "Volaris", "Jetblue", "Sansa", "Spirit", "United", "Wingo", "KLM", "Iberia", "Lufthansa", "Latam Airlines", "IberoJet", "Delta", "AirFrance", "Alaska", "AeroMéxico", "Arajet", "Air Canadá", "Airtransat", "Green Airways", "Southwest", "Edelweiss", "Frontier", "GOL"];


    // --- LÓGICA DE MONEDA (Simplificada a USD como base) ---
    const tipoCambioInput = document.getElementById('tipo_cambio');
    const totalCRCWrapper = document.getElementById('total-crc-wrapper');
    const totalUSDWrapper = document.getElementById('total-usd-wrapper');

    // La función handleCurrencyChange ya no es necesaria ya que la moneda base es fija (USD)
    // y solo se ajusta el tipo de cambio.
    // Se mantiene la lógica de visibilidad de los totales en updateGrandTotals.
    
    // --- INICIALIZAR TOTALES AL CARGAR LA PÁGINA ---
    document.addEventListener('DOMContentLoaded', function() {
        recalculateAllTotals();
        // Ajustar la visibilidad de los totales al cargar la página
        totalCRCWrapper.style.display = 'block'; // Siempre visible si hay conversión
        totalUSDWrapper.classList.remove('col-md-12');
        totalUSDWrapper.classList.add('col-md-6');
    });

    // --- FUNCIONES PARA AÑADIR ELEMENTOS ---
    function addPreAlerta() {
        preAlertaCount++;
        const container = document.getElementById('prealertas-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `prealerta-${preAlertaCount}`;
        newItem.innerHTML = `
            <span class="item-counter">${preAlertaCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('prealerta-${preAlertaCount}')"></button>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Banco</label>
                    <select name="prealerta_banco[]" class="form-select">
                        <option selected disabled>Seleccione un banco</option>
                        {% for banco in bancos %}
                        <option value="{{ banco }}">{{ banco }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Teléfono Entidad Financiera</label>
                    <input type="text" name="prealerta_telefono[]" class="form-control">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Fecha de la prealerta</label>
                    <input type="date" name="prealerta_fecha[]" class="form-control">
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Nombre del Asesor Bancario</label>
                    <input type="text" name="prealerta_asesor[]" class="form-control">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Hora de la Prealerta</label>
                    <input type="time" name="prealerta_hora[]" class="form-control">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Número de la prealerta</label>
                    <input type="text" name="prealerta_numero[]" class="form-control">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Fecha prealertada desde</label>
                    <input type="date" name="prealerta_desde[]" class="form-control">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Fecha prealertada hasta</label>
                    <input type="date" name="prealerta_hasta[]" class="form-control">
                </div>
            </div>
        `;
        container.appendChild(newItem);
    }

    function addLugar() {
        lugarCount++;
        const container = document.getElementById('lugares-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `lugar-${lugarCount}`;
        const currency = "USD"; // Moneda base fija
        newItem.innerHTML = `
            <span class="item-counter">${lugarCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('lugar-${lugarCount}', updateTotalAtracciones)"></button>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Tipo de Lugar</label>
                    <select name="lugar_tipo[]" class="form-select">
                        <option>Volcán</option><option>Montaña</option><option>Playa</option><option>Ciudad</option><option>Parque Nacional</option><option>Camino</option><option>Otros</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Nombre de Sitio</label>
                    <input type="text" name="lugar_nombre[]" class="form-control">
                </div>
            </div>
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label price-label">Precio Entrada (${currency})</label>
                    <input type="number" step="0.01" name="lugar_precio[]" class="form-control price-atraccion-base" value="0" oninput="handleAtraccionInput(this.closest('.dynamic-item'), event)">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Cant. C/GUIAS</label>
                    <input type="number" step="1" name="lugar_cant_c_guias[]" class="form-control cant-c-guias" value="" min="0" oninput="handleAtraccionInput(this.closest('.dynamic-item'), event)">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Cant. S/GUIAS</label>
                    <input type="number" step="1" name="lugar_cant_s_guias[]" class="form-control cant-s-guias" value="" min="0" oninput="handleAtraccionInput(this.closest('.dynamic-item'), event)">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Individual (${currency})</label>
                    <input type="number" step="0.01" name="lugar_total_individual[]" class="form-control price-atraccion-individual" value="" oninput="handleAtraccionInput(this.closest('.dynamic-item'), event)">
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary details-toggle" data-bs-toggle="collapse" data-bs-target="#lugar-details-${lugarCount}">
                Más Detalles <i class="fas fa-chevron-down"></i>
            </button>
            <div class="collapse mt-3" id="lugar-details-${lugarCount}">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Fecha de Reserva</label>
                        <input type="date" name="lugar_fecha_reserva[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Teléfono del Lugar</label>
                        <input type="text" name="lugar_telefono_lugar[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Teléfono de Contacto</label>
                        <input type="text" name="lugar_telefono_contacto[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">WhatsApp</label>
                        <input type="text" name="lugar_whatsapp_contacto[]" class="form-control">
                    </div>
                    <div class="col-md-8 mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="lugar_email[]" class="form-control">
                    </div>
                </div>
                 <div class="row">
                    <div class="col-md-12 mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="lugar_guia_local_checkbox" value="lugar-${lugarCount}-guia-local" id="guia-local-check-${lugarCount}" onchange="toggleGuiaLocal(this, 'guia-local-nombre-${lugarCount}')">
                            <label class="form-check-label" for="guia-local-check-${lugarCount}">¿Incluye Guía Local?</label>
                        </div>
                    </div>
                    <div class="col-md-12 mb-3" id="guia-local-nombre-${lugarCount}" style="display: none;">
                        <label class="form-label">Nombre del Guía</label>
                        <input type="text" name="lugar_nombre_guia[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Enlaces de Interés</label>
                        <textarea name="lugar_enlaces[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Notas</label>
                        <textarea name="lugar_nota[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(newItem);
        // Recalcular para que el campo individual se inicialice correctamente
        handleAtraccionInput(newItem, {target: newItem.querySelector('.price-atraccion-individual')}); 
    }
    
    function addTransporte() {
        transporteCount++;
        const container = document.getElementById('transportes-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `transporte-${transporteCount}`;
        const currency = "USD"; // Moneda base fija
        newItem.innerHTML = `
            <span class="item-counter">${transporteCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('transporte-${transporteCount}', updateTotalTransporte)"></button>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Tipo</label>
                    <select name="transporte_tipo[]" class="form-select">
                        <option>Buseta</option><option>Bus</option><option>Taxi</option><option>Uber</option><option>Auto</option><option>Lancha</option><option>Avión</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Nombre del Transporte</label>
                    <input type="text" name="transporte_nombre[]" class="form-control">
                </div>
            </div>
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label price-label">Precio Transporte (${currency})</label>
                    <input type="number" step="0.01" name="transporte_precio[]" class="form-control price-transporte-base" value="0" readonly tabindex="-1">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Cant. C/GUIAS</label>
                    <input type="number" step="1" name="transporte_cant_c_guias[]" class="form-control cant-c-guias" value="" min="0" oninput="handleTransporteInput(this.closest('.dynamic-item'), event)">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Cant. S/GUIAS</label>
                    <input type="number" step="1" name="transporte_cant_s_guias[]" class="form-control cant-s-guias" value="" min="0" oninput="handleTransporteInput(this.closest('.dynamic-item'), event)">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Individual (${currency})</label>
                    <input type="number" step="0.01" name="transporte_total_individual[]" class="form-control price-transporte-individual" value="" oninput="handleTransporteInput(this.closest('.dynamic-item'), event)">
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Agregar Tipo de Cambio</label>
                    <input type="number" step="0.01" name="transporte_tipo_cambio[]" class="form-control transporte-tipo-cambio" value="" oninput="handleTransporteInput(this.closest('.dynamic-item'), event)">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Agregar Colones</label>
                    <input type="number" step="0.01" name="transporte_colones[]" class="form-control transporte-colones" value="" oninput="handleTransporteInput(this.closest('.dynamic-item'), event)">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Total TC</label>
                    <input type="number" step="0.01" name="transporte_total_tc[]" class="form-control transporte-total-tc" value="" readonly tabindex="-1">
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary details-toggle" data-bs-toggle="collapse" data-bs-target="#transporte-details-${transporteCount}">
                Más Detalles <i class="fas fa-chevron-down"></i>
            </button>
            <div class="collapse mt-3" id="transporte-details-${transporteCount}">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Nombre del Conductor</label>
                        <input type="text" name="transporte_conductor[]" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Fecha de Contratación</label>
                        <input type="date" name="transporte_fecha_contratacion[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Teléfono del Lugar</label>
                        <input type="text" name="transporte_telefono_lugar[]" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Teléfono de Contacto</label>
                        <input type="text" name="transporte_telefono_contacto[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">WhatsApp del Contacto</label>
                        <input type="text" name="transporte_whatsapp[]" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="transporte_email[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Enlaces</label>
                        <textarea name="transporte_enlaces[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Nota</label>
                        <textarea name="transporte_nota[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(newItem);
        handleTransporteInput(newItem, {target: newItem.querySelector('.price-transporte-individual')});
    }

    function addGuia() {
        guiaCount++;
        const container = document.getElementById('guias-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `guia-${guiaCount}`;
        const currency = "USD"; // Moneda base fija
        newItem.innerHTML = `
            <span class="item-counter">${guiaCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('guia-${guiaCount}', updateTotalGuias)"></button>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Nombre</label>
                    <input type="text" name="guia_nombre[]" class="form-control">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label price-label">Precio Guía PP (${currency})</label>
                    <input type="number" step="0.01" name="guia_precio_pp[]" class="form-control price-guia-pp" value="" oninput="handleGuiaInput(this.closest('.dynamic-item'), event)">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label price-label">Precio Acarreo (${currency})</label>
                    <input type="number" step="0.01" name="guia_acarreo[]" class="form-control price-guia-acarreo" value="" oninput="handleGuiaInput(this.closest('.dynamic-item'), event)">
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label class="form-label">Individual (${currency})</label>
                    <input type="number" step="0.01" name="guia_total_individual[]" class="form-control price-guia-individual" value="" oninput="handleGuiaInput(this.closest('.dynamic-item'), event)">
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary details-toggle" data-bs-toggle="collapse" data-bs-target="#guia-details-${guiaCount}">
                Más Detalles <i class="fas fa-chevron-down"></i>
            </button>
            <div class="collapse mt-3" id="guia-details-${guiaCount}">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Operador</label>
                        <input type="text" name="guia_operador[]" class="form-control">
                    </div>
                     <div class="col-md-4 mb-3">
                        <label class="form-label">Teléfono</label>
                        <input type="text" name="guia_telefono[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">WhatsApp</label>
                        <input type="text" name="guia_whatsapp[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="guia_email[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">CPL</label>
                        <input type="text" name="guia_cpl[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Fecha Disponible</label>
                        <input type="date" name="guia_fecha_disponible[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Fecha Reserva</label>
                        <input type="date" name="guia_fecha_reserva[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Reserva</label>
                        <input type="text" name="guia_reserva[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Enlaces</label>
                        <textarea name="guia_enlaces[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Nota</label>
                        <textarea name="guia_nota[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(newItem);
        handleGuiaInput(newItem, {target: newItem.querySelector('.price-guia-individual')});
    }

    function addEstadia() {
        estadiaCount++;
        const container = document.getElementById('estadias-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `estadia-${estadiaCount}`;
        const currency = "USD"; // Moneda base fija
        newItem.innerHTML = `
            <span class="item-counter">${estadiaCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('estadia-${estadiaCount}', updateTotalEstadia)"></button>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Nombre</label>
                    <input type="text" name="estadia_nombre[]" class="form-control">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Tipo de Estadía</label>
                    <select name="estadia_tipo[]" class="form-select">
                        <option>Hotel</option><option>Hostel</option><option>Airbnb</option><option>Casa/Apto</option><option>Otro</option>
                    </select>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label price-label">Precio PP Noche (${currency})</label>
                    <input type="number" step="0.01" name="estadia_precio_pp[]" class="form-control price-estadia-pp" value="" oninput="handleEstadiaInput(this.closest('.dynamic-item'), event)">
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label"># Noches</label>
                    <input type="number" step="1" name="estadia_noches[]" class="form-control noches-estadia" value="" min="1" oninput="handleEstadiaInput(this.closest('.dynamic-item'), event)">
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label class="form-label">Individual (${currency})</label>
                    <input type="number" step="0.01" name="estadia_total_individual[]" class="form-control price-estadia-individual" value="" oninput="handleEstadiaInput(this.closest('.dynamic-item'), event)">
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary details-toggle" data-bs-toggle="collapse" data-bs-target="#estadia-details-${estadiaCount}">
                Más Detalles <i class="fas fa-chevron-down"></i>
            </button>
            <div class="collapse mt-3" id="estadia-details-${estadiaCount}">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Fecha Check-in</label>
                        <input type="date" name="estadia_checkin[]" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Fecha Check-out</label>
                        <input type="date" name="estadia_checkout[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Teléfono del Lugar</label>
                        <input type="text" name="estadia_telefono_lugar[]" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Teléfono de Contacto</label>
                        <input type="text" name="estadia_telefono_contacto[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">WhatsApp</label>
                        <input type="text" name="estadia_whatsapp[]" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="estadia_email[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                     <div class="col-md-12 mb-3">
                        <label class="form-label">Número de Reserva</label>
                        <input type="text" name="estadia_reserva[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Enlaces</label>
                        <textarea name="estadia_enlaces[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Nota</label>
                        <textarea name="estadia_nota[]" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(newItem);
        handleEstadiaInput(newItem, {target: newItem.querySelector('.price-estadia-individual')});
    }

    function addAerolinea() {
        aerolineaCount++;
        const container = document.getElementById('aerolineas-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `aerolinea-${aerolineaCount}`;
        const currency = "USD"; // Moneda base fija

        // Create options for the airline select
        let aerolineaOptions = AEROLINEA_OPTIONS.map(name => `<option value="${name}">${name}</option>`).join('');

        newItem.innerHTML = `
            <span class="item-counter">${aerolineaCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('aerolinea-${aerolineaCount}', updateTotalAerolinea)"></button>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Tipo de Transporte</label>
                    <select name="aerolinea_tipo_transporte[]" class="form-select tipo-transporte-aerolinea" onchange="toggleAerolineaFields(this)">
                        <option>Avión</option><option>Bus</option><option>Buseta</option><option>Auto</option><option>Moto</option><option>Barco</option>
                    </select>
                </div>
                <div class="col-md-8 mb-3 aerolinea-field-group">
                    <label class="form-label">Aerolínea / Compañía</label>
                    <select name="aerolinea_nombre[]" class="form-select">
                        <option value="" disabled selected>Seleccione una aerolínea</option>
                        ${aerolineaOptions}
                        <option value="Otra">Otra</option>
                    </select>
                </div>
            </div>

            <div class="aerolinea-details-wrapper">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Teléfono Aerolínea</label>
                        <input type="text" name="aerolinea_telefono[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="aerolinea_email[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">WhatsApp</label>
                        <input type="text" name="aerolinea_whatsapp[]" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Teléfono de Pre-alerta</label>
                        <input type="text" name="aerolinea_tel_prealerta[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Fecha Pre-alerta</label>
                        <input type="date" name="aerolinea_fecha_prealerta[]" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Enlace para Pre-alertar</label>
                        <input type="text" name="aerolinea_enlace_prealerta[]" class="form-control">
                    </div>
                </div>
                <hr>
                <h6>Precios y Tarifas (por persona)</h6>
                <div class="row">
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Precio Asientos</label><input type="number" step="0.01" name="aerolinea_precio_asientos[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Precio Maletas Doc.</label><input type="number" step="0.01" name="aerolinea_precio_maletas[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Equipaje de Mano</label><input type="number" step="0.01" name="aerolinea_equipaje_mano[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Precio Impuestos</label><input type="number" step="0.01" name="aerolinea_impuestos[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Precio Estandar</label><input type="number" step="0.01" name="aerolinea_precio_estandar[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Precio Mas Equipo</label><input type="number" step="0.01" name="aerolinea_precio_equipo[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Precio Salida Rápida</label><input type="number" step="0.01" name="aerolinea_precio_salida_rapida[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Precio Premium</label><input type="number" step="0.01" name="aerolinea_precio_premium[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Precio VIP</label><input type="number" step="0.01" name="aerolinea_precio_vip[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Precio Basic</label><input type="number" step="0.01" name="aerolinea_precio_basic[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Precio Classic</label><input type="number" step="0.01" name="aerolinea_precio_classic[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Precio Flexible</label><input type="number" step="0.01" name="aerolinea_precio_flexible[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                </div>
                <hr>
                <h6>Otros Costos Adicionales (por persona)</h6>
                ${[1,2,3,4].map(i => `
                <div class="row align-items-end">
                    <div class="col-md-6 mb-3"><label class="form-label">Descripción #${i}</label><input type="text" name="aerolinea_otro_desc_${i}[]" class="form-control"></div>
                    <div class="col-md-3 mb-3"><label class="form-label price-label">Costo #${i}</label><input type="number" step="0.01" name="aerolinea_otro_costo_${i}[]" class="form-control price-aerolinea" value="0" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label">Cantidad</label><input type="number" name="aerolinea_otro_cant_${i}[]" class="form-control" value="1" oninput="updateTotalAerolinea()"></div>
                </div>
                `).join('')}
            </div>
        `;
        container.appendChild(newItem);
        // Asegúrate de llamar a toggleAerolineaFields para el nuevo elemento
        toggleAerolineaFields(newItem.querySelector('.tipo-transporte-aerolinea'));
    }

    // Función para eliminar elementos dinámicos
    function removeItem(id, callback) {
        const item = document.getElementById(id);
        if (item) {
            item.remove();
            // Reindexar los contadores visuales después de eliminar un elemento
            updateItemCounters();
            if (callback) {
                callback();
            }
        }
    }

    // Función para reindexar los contadores visuales
    function updateItemCounters() {
        document.querySelectorAll('.section-container').forEach(section => {
            let currentSectionId;
            if (section.querySelector('#prealertas-container')) currentSectionId = 'prealerta';
            else if (section.querySelector('#lugares-container')) currentSectionId = 'lugar';
            else if (section.querySelector('#transportes-container')) currentSectionId = 'transporte';
            else if (section.querySelector('#guias-container')) currentSectionId = 'guia';
            else if (section.querySelector('#estadias-container')) currentSectionId = 'estadia';
            else if (section.querySelector('#aerolineas-container')) currentSectionId = 'aerolinea';
            
            if (currentSectionId) {
                let index = 1;
                section.querySelectorAll(`.dynamic-item[id^="${currentSectionId}-"]`).forEach(item => {
                    item.querySelector('.item-counter').textContent = index;
                    // También actualiza los data-bs-target para los detalles colapsables
                    const detailsToggle = item.querySelector('.details-toggle');
                    if (detailsToggle) {
                        detailsToggle.setAttribute('data-bs-target', `#${currentSectionId}-details-${index}`);
                    }
                    const detailsCollapse = item.querySelector(`.collapse`);
                    if (detailsCollapse) {
                        detailsCollapse.id = `${currentSectionId}-details-${index}`;
                    }

                    // Actualizar IDs para el checkbox del guía local (si aplica)
                    if (currentSectionId === 'lugar') {
                        const guiaLocalCheck = item.querySelector('[id^="guia-local-check-"]');
                        const guiaLocalNombreDiv = item.querySelector('[id^="guia-local-nombre-"]');
                        if (guiaLocalCheck && guiaLocalNombreDiv) {
                            guiaLocalCheck.id = `guia-local-check-${index}`;
                            guiaLocalCheck.setAttribute('onchange', `toggleGuiaLocal(this, 'guia-local-nombre-${index}')`);
                            guiaLocalNombreDiv.id = `guia-local-nombre-${index}`;
                        }
                    }

                    index++;
                });
                // Actualizar los contadores JavaScript a la cantidad correcta
                if (currentSectionId === 'prealerta') preAlertaCount = index - 1;
                else if (currentSectionId === 'lugar') lugarCount = index - 1;
                else if (currentSectionId === 'transporte') transporteCount = index - 1;
                else if (currentSectionId === 'guia') guiaCount = index - 1;
                else if (currentSectionId === 'estadia') estadiaCount = index - 1;
                else if (currentSectionId === 'aerolinea') aerolineaCount = index - 1;
            }
        });
    }

    function toggleGuiaLocal(checkbox, divId) {
        const div = document.getElementById(divId);
        if (checkbox.checked) {
            div.style.display = 'block';
        } else {
            div.style.display = 'none';
        }
    }
    
    function toggleAerolineaFields(selectElement) {
        const parentItem = selectElement.closest('.dynamic-item');
        const detailsWrapper = parentItem.querySelector('.aerolinea-details-wrapper');
        // Asegúrate de que detailsWrapper no sea null antes de intentar acceder a style
        if (detailsWrapper) {
            if (selectElement.value === 'Avión') {
                detailsWrapper.style.display = 'block';
            } else {
                detailsWrapper.style.display = 'none';
                // Restablecer los valores de los campos ocultos a 0 para que no se envíen datos no deseados
                detailsWrapper.querySelectorAll('input[type="number"]').forEach(input => {
                    input.value = 0;
                });
                // Restablecer otros campos si es necesario (ej. texto, fechas)
                detailsWrapper.querySelectorAll('input[type="text"], input[type="date"], input[type="datetime-local"], input[type="email"], textarea').forEach(input => {
                    input.value = '';
                });
            }
        }
        updateTotalAerolinea();
    }

    // --- FUNCIONES PARA ACTUALIZAR TOTALES ---
    function recalculateAllTotals() {
        updateTotalAtracciones();
        updateTotalTransporte();
        updateTotalGuias();
        updateTotalEstadia();
        updateTotalAerolinea();
    }

    // Nueva función para manejar la lógica de habilitación/deshabilitación y cálculo de cada atracción
    function handleAtraccionInput(item, event) {
        const precioEntradaInput = item.querySelector('.price-atraccion-base');
        const cantCGuiasInput = item.querySelector('.cant-c-guias');
        const cantSGuiasInput = item.querySelector('.cant-s-guias');
        const individualInput = item.querySelector('.price-atraccion-individual');

        const precioEntrada = parseFloat(precioEntradaInput.value) || 0;
        const cantCGuias = parseInt(cantCGuiasInput.value) || 0;
        const cantSGuias = parseInt(cantSGuiasInput.value) || 0;
        const individualValue = parseFloat(individualInput.value);

        const changedInput = event.target;

        if (changedInput === individualInput) {
            // If individual input was changed manually
            if (individualInput.value !== "" && individualValue !== 0) {
                // If individual has a value, disable and clear formula inputs
                precioEntradaInput.disabled = true;
                cantCGuiasInput.disabled = true;
                cantSGuiasInput.disabled = true;
                precioEntradaInput.value = "0"; // Set to "0" for price input
                cantCGuiasInput.value = ""; // Set to "" for quantity input
                cantSGuiasInput.value = ""; // Set to "" for quantity input
            } else {
                // Individual input is cleared or 0, re-enable formula inputs
                precioEntradaInput.disabled = false;
                cantCGuiasInput.disabled = false;
                cantSGuiasInput.disabled = false;
                // Now, re-evaluate based on formula inputs (if they have values)
                if (precioEntrada !== 0 || cantCGuias !== 0 || cantSGuias !== 0) {
                    const calculatedValue = precioEntrada * cantCGuias / (cantSGuias === 0 ? 1 : cantSGuias);
                    individualInput.value = calculatedValue.toFixed(2);
                    individualInput.disabled = true;
                } else {
                    // All fields are empty/0, ensure individual is enabled and clear
                    individualInput.value = "";
                    individualInput.disabled = false;
                }
            }
        } else {
            // If a formula input (precioEntrada, cantCGuias, cantSGuias) was changed
            if (precioEntrada !== 0 || cantCGuias !== 0 || cantSGuias !== 0) {
                // If any formula input has a value, calculate individual and disable it
                const calculatedValue = precioEntrada * cantCGuias / (cantSGuias === 0 ? 1 : cantSGuias);
                individualInput.value = calculatedValue.toFixed(2);
                individualInput.disabled = true;
                // Ensure formula inputs are enabled
                precioEntradaInput.disabled = false;
                cantCGuiasInput.disabled = false;
                cantSGuiasInput.disabled = false;
            } else {
                // All formula inputs are empty/0, clear individual and enable it
                individualInput.value = "";
                individualInput.disabled = false;
                // Ensure formula inputs are enabled
                precioEntradaInput.disabled = false;
                cantCGuiasInput.disabled = false;
                cantSGuiasInput.disabled = false;
            }
        }
        updateTotalAtracciones();
    }


    function updateTotalAtracciones() {
        let total = 0;
        document.querySelectorAll('.dynamic-item[id^="lugar-"]').forEach(item => {
            const individualInput = item.querySelector('.price-atraccion-individual');
            total += parseFloat(individualInput.value) || 0;
        });
        document.getElementById('total-atracciones').textContent = total.toFixed(2);
        updateGrandTotals();
    }
    
    // Nueva función para manejar la lógica de habilitación/deshabilitación y cálculo de cada transporte
    function handleTransporteInput(item, event) {
        const precioTransporteInput = item.querySelector('.price-transporte-base'); // This is now a calculated field
        const cantCGuiasInput = item.querySelector('.cant-c-guias'); 
        const cantSGuiasInput = item.querySelector('.cant-s-guias'); 
        const tipoCambioTransporteInput = item.querySelector('.transporte-tipo-cambio');
        const colonesTransporteInput = item.querySelector('.transporte-colones');
        const totalTCDisplay = item.querySelector('.transporte-total-tc'); // Read-only
        const individualTransporteInput = item.querySelector('.price-transporte-individual');

        const cantCGuias = parseInt(cantCGuiasInput.value) || 0; 
        const cantSGuias = parseInt(cantSGuiasInput.value) || 0; 
        const tipoCambioTransporte = parseFloat(tipoCambioTransporteInput.value) || 0;
        const colonesTransporte = parseFloat(colonesTransporteInput.value) || 0;
        const individualTransporteValue = parseFloat(individualTransporteInput.value);

        const changedInput = event.target;

        // Reset calculated fields before new calculations
        let calculatedPrecioTransporte = 0;
        let calculatedTotalTC = 0;
        let calculatedIndividual = 0;
        let isIndividualCalculated = false;

        // Lógica principal: Individual (USD) tiene la máxima prioridad
        if (changedInput === individualTransporteInput) {
            if (individualTransporteInput.value !== "" && individualTransporteValue !== 0) {
                // Si Individual se modificó manualmente y tiene valor, deshabilitar y limpiar todo lo demás
                precioTransporteInput.disabled = true;
                cantCGuiasInput.disabled = true;
                cantSGuiasInput.disabled = true;
                tipoCambioTransporteInput.disabled = true;
                colonesTransporteInput.disabled = true;

                precioTransporteInput.value = "0";
                cantCGuiasInput.value = "";
                cantSGuiasInput.value = "";
                tipoCambioTransporteInput.value = "";
                colonesTransporteInput.value = "";
                totalTCDisplay.value = "";
            } else {
                // Individual se borró o es 0, re-habilitar campos de cálculo y re-evaluar
                precioTransporteInput.disabled = false; // Will be set readonly later if calculated
                cantCGuiasInput.disabled = false;
                cantSGuiasInput.disabled = false;
                tipoCambioTransporteInput.disabled = false;
                colonesTransporteInput.disabled = false;

                // Re-evaluar los cálculos
                if (colonesTransporte !== 0 && tipoCambioTransporte !== 0) {
                    calculatedTotalTC = colonesTransporte / tipoCambioTransporte;
                    totalTCDisplay.value = calculatedTotalTC.toFixed(2);
                    
                    calculatedPrecioTransporte = calculatedTotalTC * cantCGuias / (cantSGuias === 0 ? 1 : cantSGuias);
                    precioTransporteInput.value = calculatedPrecioTransporte.toFixed(2);
                    precioTransporteInput.disabled = true; // Disable as it's calculated
                    
                    individualTransporteInput.value = calculatedPrecioTransporte.toFixed(2);
                    individualTransporteInput.disabled = true; // Disable as it's calculated
                    isIndividualCalculated = true;

                    // Disable other primary inputs if this path is taken
                    cantCGuiasInput.disabled = false; // Keep these enabled as they are part of the formula
                    cantSGuiasInput.disabled = false; // Keep these enabled as they are part of the formula

                } else if (precioTransporteInput.value !== "" && (cantCGuias !== 0 || cantSGuias !== 0)) { // Fallback if TC/Colones not used
                    // This path is now less likely if precioTransporteInput is always calculated.
                    // Re-think this part: if precioTransporteInput is always calculated, this branch is unreachable.
                    // The only way precioTransporteInput has a value *not* from TC/Colones is if it was manually set (which it shouldn't be now).
                    // So, if colones/TC are empty, then individual should be empty too.
                    individualTransporteInput.value = "";
                    individualTransporteInput.disabled = false;
                    totalTCDisplay.value = "";
                    precioTransporteInput.value = "0"; // Ensure it's reset if no calculation applies
                    precioTransporteInput.disabled = false; // Re-enable if no calculation applies
                    cantCGuiasInput.value = "";
                    cantSGuiasInput.value = "";
                } else {
                    // Si no hay valores para calcular, Individual se habilita para entrada manual
                    individualTransporteInput.value = "";
                    individualTransporteInput.disabled = false;
                    totalTCDisplay.value = "";
                    precioTransporteInput.value = "0";
                    precioTransporteInput.disabled = false;
                    cantCGuiasInput.value = "";
                    cantSGuiasInput.value = "";
                }
            }
        } else {
            // Si un campo de cálculo (no Individual) fue modificado
            // Habilitar todos los campos de cálculo primero, luego deshabilitar según la lógica
            precioTransporteInput.disabled = false;
            cantCGuiasInput.disabled = false;
            cantSGuiasInput.disabled = false;
            tipoCambioTransporteInput.disabled = false;
            colonesTransporteInput.disabled = false;
            individualTransporteInput.disabled = false; // Temporarily enable individual

            if (colonesTransporte !== 0 && tipoCambioTransporte !== 0) {
                calculatedTotalTC = colonesTransporte / tipoCambioTransporte;
                totalTCDisplay.value = calculatedTotalTC.toFixed(2);
                
                calculatedPrecioTransporte = calculatedTotalTC * cantCGuias / (cantSGuias === 0 ? 1 : cantSGuias);
                precioTransporteInput.value = calculatedPrecioTransporte.toFixed(2);
                precioTransporteInput.disabled = true; // Disable as it's calculated
                
                individualTransporteInput.value = calculatedPrecioTransporte.toFixed(2);
                individualTransporteInput.disabled = true; // Disable as it's calculated
                isIndividualCalculated = true;

                // Disable the alternative calculation path inputs
                // No need to disable cantCGuias/cantSGuias as they are part of the formula for precioTransporteInput
                // Keep tipoCambioTransporteInput and colonesTransporteInput enabled as they are inputs for this path
            } else {
                // If Colones/TC are not used, clear their calculated outputs
                totalTCDisplay.value = "";
                precioTransporteInput.value = "0"; // Reset calculated price
                precioTransporteInput.disabled = false; // Re-enable if no calculation applies

                // Now, check if cantCGuias or cantSGuias have values to calculate individual
                if (cantCGuias !== 0 || cantSGuias !== 0) {
                    // This scenario is now only if precioTransporteInput is manually entered (which it shouldn't be)
                    // Or if precioTransporteInput was calculated by a previous step and now colones/TC are cleared.
                    // Let's assume if colones/TC are empty, then individual should be empty.
                    // This means the only way individual gets a value is through colones/TC.
                    individualTransporteInput.value = "";
                    individualTransporteInput.disabled = false;
                } else {
                    individualTransporteInput.value = "";
                    individualTransporteInput.disabled = false;
                }
            }
        }
        updateTotalTransporte();
    }

    function updateTotalTransporte() {
        let total = 0;
        document.querySelectorAll('.dynamic-item[id^="transporte-"]').forEach(item => {
            const individualTransporteInput = item.querySelector('.price-transporte-individual');
            total += parseFloat(individualTransporteInput.value) || 0;
        });
        document.getElementById('total-transporte').textContent = total.toFixed(2);
        updateGrandTotals();
    }

    // Nueva función para manejar la lógica de habilitación/deshabilitación y cálculo de cada guía
    function handleGuiaInput(item, event) {
        const precioGuiaPPInput = item.querySelector('.price-guia-pp');
        const precioAcarreoInput = item.querySelector('.price-guia-acarreo');
        const individualGuiaInput = item.querySelector('.price-guia-individual');

        const precioGuiaPP = parseFloat(precioGuiaPPInput.value) || 0;
        const precioAcarreo = parseFloat(precioAcarreoInput.value) || 0;
        const individualGuiaValue = parseFloat(individualGuiaInput.value);

        const changedInput = event.target;

        if (changedInput === individualGuiaInput) {
            // If individual input was changed manually
            if (individualGuiaInput.value !== "" && individualGuiaValue !== 0) {
                // If individual has a value, disable and clear formula inputs
                precioGuiaPPInput.disabled = true;
                precioAcarreoInput.disabled = true;
                precioGuiaPPInput.value = "0"; // Set to "0" for price input
                precioAcarreoInput.value = "0"; // Set to "0" for price input
            } else {
                // Individual input is cleared or 0, re-enable formula inputs
                precioGuiaPPInput.disabled = false;
                precioAcarreoInput.disabled = false;
                // Now, re-evaluate based on formula inputs (if they have values)
                if (precioGuiaPP !== 0 || precioAcarreo !== 0) {
                    const calculatedValue = precioGuiaPP + precioAcarreo;
                    individualGuiaInput.value = calculatedValue.toFixed(2);
                    individualGuiaInput.disabled = true;
                } else {
                    // All fields are empty/0, ensure individual is enabled and clear
                    individualGuiaInput.value = "";
                    individualGuiaInput.disabled = false;
                }
            }
        } else {
            // If a formula input (precioGuiaPP, precioAcarreo) was changed
            if (precioGuiaPP !== 0 || precioAcarreo !== 0) {
                // If any formula input has a value, calculate individual and disable it
                const calculatedValue = precioGuiaPP + precioAcarreo;
                individualGuiaInput.value = calculatedValue.toFixed(2);
                individualGuiaInput.disabled = true;
                // Ensure formula inputs are enabled
                precioGuiaPPInput.disabled = false;
                precioAcarreoInput.disabled = false;
            } else {
                // All formula inputs are empty/0, clear individual and enable it
                individualGuiaInput.value = "";
                individualGuiaInput.disabled = false;
                // Ensure formula inputs are enabled
                precioGuiaPPInput.disabled = false;
                precioAcarreoInput.disabled = false;
            }
        }
        updateTotalGuias();
    }

    function updateTotalGuias() {
        let total = 0;
        document.querySelectorAll('.dynamic-item[id^="guia-"]').forEach(item => {
            const individualGuiaInput = item.querySelector('.price-guia-individual');
            total += parseFloat(individualGuiaInput.value) || 0;
        });
        document.getElementById('total-guias').textContent = total.toFixed(2);
        updateGrandTotals();
    }

    // Nueva función para manejar la lógica de habilitación/deshabilitación y cálculo de cada estadía
    function handleEstadiaInput(item, event) {
        const precioPPNocheInput = item.querySelector('.price-estadia-pp');
        const nochesInput = item.querySelector('.noches-estadia');
        const individualEstadiaInput = item.querySelector('.price-estadia-individual');

        const precioPPNoche = parseFloat(precioPPNocheInput.value) || 0;
        const noches = parseInt(nochesInput.value) || 0;
        const individualEstadiaValue = parseFloat(individualEstadiaInput.value);

        const changedInput = event.target;

        if (changedInput === individualEstadiaInput) {
            // If individual input was changed manually
            if (individualEstadiaInput.value !== "" && individualEstadiaValue !== 0) {
                // If individual has a value, disable and clear formula inputs
                precioPPNocheInput.disabled = true;
                nochesInput.disabled = true;
                precioPPNocheInput.value = "0"; // Set to "0" for price input
                nochesInput.value = ""; // Set to "" for quantity input
            } else {
                // Individual input is cleared or 0, re-enable formula inputs
                precioPPNocheInput.disabled = false;
                nochesInput.disabled = false;
                // Now, re-evaluate based on formula inputs (if they have values)
                if (precioPPNoche !== 0 || noches !== 0) {
                    const calculatedValue = precioPPNoche * noches;
                    individualEstadiaInput.value = calculatedValue.toFixed(2);
                    individualEstadiaInput.disabled = true;
                } else {
                    // All fields are empty/0, ensure individual is enabled and clear
                    individualEstadiaInput.value = "";
                    individualEstadiaInput.disabled = false;
                }
            }
        } else {
            // If a formula input (precioPPNoche, noches) was changed
            if (precioPPNoche !== 0 || noches !== 0) {
                // If any formula input has a value, calculate individual and disable it
                const calculatedValue = precioPPNoche * noches;
                individualEstadiaInput.value = calculatedValue.toFixed(2);
                individualEstadiaInput.disabled = true;
                // Ensure formula inputs are enabled
                precioPPNocheInput.disabled = false;
                nochesInput.disabled = false;
            } else {
                // All formula inputs are empty/0, clear individual and enable it
                individualEstadiaInput.value = "";
                individualEstadiaInput.disabled = false;
                // Ensure formula inputs are enabled
                precioPPNocheInput.disabled = false;
                nochesInput.disabled = false;
            }
        }
        updateTotalEstadia();
    }

    function updateTotalAerolinea() {
        let total = 0;
        document.querySelectorAll('.dynamic-item[id^="aerolinea-"]').forEach(item => {
            const tipo = item.querySelector('.tipo-transporte-aerolinea').value;
            // Solo sumar si el tipo es 'Avión' para los campos específicos de avión
            if (tipo === 'Avión') {
                // Sumar todos los precios de tarifas aéreas
                item.querySelectorAll('.price-aerolinea').forEach(input => {
                    total += parseFloat(input.value) || 0;
                });

                // Sumar otros costos (costo * cantidad)
                for (let i = 1; i <= 4; i++) {
                    const costoInput = item.querySelector(`[name="aerolinea_otro_costo_${i}[]"]`);
                    const cantInput = item.querySelector(`[name="aerolinea_otro_cant_${i}[]"]`);
                    const costo = parseFloat(costoInput ? costoInput.value : 0) || 0;
                    const cant = parseInt(cantInput ? cantInput.value : 0) || 0;
                    total += costo * cant;
                }
            } else {
                // Para otros tipos de transporte principal (Bus, Buseta, etc.), solo consideramos el primer campo de precio
                const precioPorPersonaInput = item.querySelector('.price-aerolinea');
                if (precioPorPersonaInput) {
                    total += parseFloat(precioPorPersonaInput.value) || 0;
                }
            }
        });
        document.getElementById('total-aerolinea').textContent = total.toFixed(2);
        updateGrandTotals();
    }
    
    function updateGrandTotals() {
        // Precio Paquete (por persona) no se incluye en el TOTAL INDIVIDUAL (USD) según la nueva especificación.
        // const precioPaquete = parseFloat(document.getElementById('precio_paquete').value) || 0; 
        const totalAtracciones = parseFloat(document.getElementById('total-atracciones').textContent) || 0;
        const totalTransporte = parseFloat(document.getElementById('total-transporte').textContent) || 0;
        const totalGuias = parseFloat(document.getElementById('total-guias').textContent) || 0;
        const totalEstadia = parseFloat(document.getElementById('total-estadia').textContent) || 0;
        const totalAerolinea = parseFloat(document.getElementById('total-aerolinea').textContent) || 0;
        
        // Calcular el TOTAL INDIVIDUAL (USD) sumando los campos especificados
        const totalUSDCalculated = totalAtracciones + totalTransporte + totalGuias + totalEstadia + totalAerolinea;
        
        const tipoCambio = parseFloat(document.getElementById('tipo_cambio').value) || 1;
        
        // Actualizar el campo TOTAL INDIVIDUAL (USD)
        document.getElementById('total-usd').textContent = totalUSDCalculated.toFixed(2);
        
        // Calcular y actualizar el campo TOTAL INDIVIDUAL (CRC)
        document.getElementById('total-crc').textContent = (totalUSDCalculated * tipoCambio).toFixed(2);
    }
</script>
{% endblock %}
