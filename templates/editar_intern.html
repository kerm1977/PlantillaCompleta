{% extends "base.html" %}

{% block title %}Editar Viaje: {{ viaje.nombre_viaje }}{% endblock %}

{% block head_content %}
<style>
    .card {
        box-shadow: none !important;
        border: 1px solid #dee2e6;
    }
    .form-section-separator {
        border-top: 2px solid #ffc107;
        margin-top: 2rem;
        margin-bottom: 2rem;
    }
    .dynamic-item {
        border-left: 3px solid #ffc107;
        padding-left: 15px;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4 text-center">Editando: {{ viaje.nombre_viaje }}</h1>

    <form action="{{ url_for('intern.editar_intern', id=viaje.id) }}" method="POST" enctype="multipart/form-data">
        
        <!-- SECCIÓN DESTINO -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h4 class="mb-0">Destino</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="titulo_destino" class="form-label">Título Destino</label>
                        <input type="text" class="form-control" id="titulo_destino" name="titulo_destino" value="{{ viaje.titulo_destino or '' }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="nombre_viaje" class="form-label">Nombre del Viaje</label>
                        <input type="text" class="form-control" id="nombre_viaje" name="nombre_viaje" value="{{ viaje.nombre_viaje or '' }}" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="flyer" class="form-label">Cambiar Flyer (Imagen)</label>
                        <input type="file" class="form-control" id="flyer" name="flyer" accept="image/*">
                        {% if viaje.flyer_url %}
                        <small class="form-text text-muted">Flyer actual: {{ viaje.flyer_url }}</small>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="pais" class="form-label">País</label>
                        <select class="form-select" id="pais" name="pais" required>
                            <option disabled>Seleccionar país...</option>
                            <option value="Panama" {% if viaje.pais == 'Panama' %}selected{% endif %}>Panamá</option>
                            <option value="Nicaragua" {% if viaje.pais == 'Nicaragua' %}selected{% endif %}>Nicaragua</option>
                            <option value="Honduras" {% if viaje.pais == 'Honduras' %}selected{% endif %}>Honduras</option>
                            <option value="El Salvador" {% if viaje.pais == 'El Salvador' %}selected{% endif %}>El Salvador</option>
                            <option value="Guatemala" {% if viaje.pais == 'Guatemala' %}selected{% endif %}>Guatemala</option>
                            <option value="Mexico" {% if viaje.pais == 'Mexico' %}selected{% endif %}>México</option>
                            <option value="Peru" {% if viaje.pais == 'Peru' %}selected{% endif %}>Perú</option>
                            <option value="Spain" {% if viaje.pais == 'Spain' %}selected{% endif %}>España</option>
                        </select>
                    </div>
                </div>
                 <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="precio_paquete" class="form-label">Precio del Paquete</label>
                        <input type="number" step="0.01" class="form-control" id="precio_paquete" name="precio_paquete" value="{{ viaje.precio_paquete or 0 }}">
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="capacidad" class="form-label">Capacidad</label>
                        <input type="number" class="form-control" id="capacidad" name="capacidad" value="{{ viaje.capacidad or 0 }}">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="tipo_moneda" class="form-label">Tipo de Moneda</label>
                        <select class="form-select" id="tipo_moneda" name="tipo_moneda">
                            <option value="CRC" {% if viaje.tipo_moneda == 'CRC' %}selected{% endif %}>Colones (CRC)</option>
                            <option value="USD" {% if viaje.tipo_moneda == 'USD' %}selected{% endif %}>Dólares (USD)</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="tipo_cambio" class="form-label">Tipo de Cambio (a USD)</label>
                        <input type="number" step="0.01" class="form-control" id="tipo_cambio" name="tipo_cambio" value="{{ viaje.tipo_cambio or 520.00 }}" oninput="calculateTotals()">
                    </div>
                </div>
            </div>
        </div>

        <!-- SEPARADOR ADMINISTRACIÓN DE VIAJE -->
        <hr class="form-section-separator">
        <h2 class="text-center mb-4">Administración de Viaje</h2>

        <!-- SECCIÓN PRE-ALERTA -->
        <div class="card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Pre-Alerta Bancaria</h5>
                <button type="button" class="btn btn-sm btn-outline-warning" onclick="addDynamicForm('prealerta-container', 'prealerta-template')">
                    <i class="fas fa-plus"></i> Agregar Pre-Alerta
                </button>
            </div>
            <div class="card-body" id="prealerta-container">
                {% for prealerta in viaje.prealertas %}
                <div class="dynamic-item p-3 mb-3 border rounded">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Pre-Alerta #<span class="item-number">{{ loop.index }}</span></h6>
                        <button type="button" class="btn-close" aria-label="Close" onclick="this.closest('.dynamic-item').remove()"></button>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Entidad Financiera</label>
                            <input type="text" name="prealerta_banco[]" class="form-control" value="{{ prealerta.banco or '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Teléfono Entidad Financiera</label>
                            <input type="tel" name="prealerta_telefono[]" class="form-control" value="{{ prealerta.telefono_entidad or '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fecha de la prealerta</label>
                            <input type="date" name="prealerta_fecha[]" class="form-control" value="{{ prealerta.fecha_prealerta.strftime('%Y-%m-%d') if prealerta.fecha_prealerta }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre del Asesor Bancario</label>
                            <input type="text" name="prealerta_asesor[]" class="form-control" value="{{ prealerta.nombre_asesor or '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Hora de la Prealerta</label>
                            <input type="time" name="prealerta_hora[]" class="form-control" value="{{ prealerta.hora_prealerta.strftime('%H:%M') if prealerta.hora_prealerta }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Número de la prealerta</label>
                            <input type="text" name="prealerta_numero[]" class="form-control" value="{{ prealerta.numero_prealerta or '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fecha prealertada (Desde)</label>
                            <input type="date" name="prealerta_desde[]" class="form-control" value="{{ prealerta.fecha_desde.strftime('%Y-%m-%d') if prealerta.fecha_desde }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fecha prealertada (Hasta)</label>
                            <input type="date" name="prealerta_hasta[]" class="form-control" value="{{ prealerta.fecha_hasta.strftime('%Y-%m-%d') if prealerta.fecha_hasta }}">
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- SEPARADOR LUGARES A VISITAR -->
        <hr class="form-section-separator">
        <h2 class="text-center mb-4">Lugares a Visitar</h2>
        <div class="card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Atracciones</h5>
                 <button type="button" class="btn btn-sm btn-outline-warning" onclick="addDynamicForm('lugar-container', 'lugar-template')">
                    <i class="fas fa-plus"></i> Agregar Lugar
                </button>
            </div>
            <div class="card-body" id="lugar-container">
                {% for lugar in viaje.lugares %}
                <div class="dynamic-item p-3 mb-3 border rounded">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Lugar #<span class="item-number">{{ loop.index }}</span></h6>
                        <button type="button" class="btn-close" aria-label="Close" onclick="this.closest('.dynamic-item').remove(); calculateTotals();"></button>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tipo</label>
                            <select name="lugar_tipo[]" class="form-select">
                                <option {% if lugar.tipo_lugar == 'Volcán' %}selected{% endif %}>Volcán</option>
                                <option {% if lugar.tipo_lugar == 'Montaña' %}selected{% endif %}>Montaña</option>
                                <option {% if lugar.tipo_lugar == 'Playa' %}selected{% endif %}>Playa</option>
                                <option {% if lugar.tipo_lugar == 'Ciudad' %}selected{% endif %}>Ciudad</option>
                                <option {% if lugar.tipo_lugar == 'Parque Nacional' %}selected{% endif %}>Parque Nacional</option>
                                <option {% if lugar.tipo_lugar == 'Camino' %}selected{% endif %}>Camino</option>
                                <option {% if lugar.tipo_lugar == 'Otros' %}selected{% endif %}>Otros</option>
                            </select>
                        </div>
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Nombre del Sitio</label>
                            <input type="text" name="lugar_nombre[]" class="form-control" value="{{ lugar.nombre_sitio or '' }}">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Precio Entrada (CRC)</label>
                            <input type="number" step="0.01" name="lugar_precio[]" class="form-control price-field" value="{{ lugar.precio_entrada or 0 }}" oninput="calculateTotals()">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Fecha Reserva</label>
                            <input type="date" name="lugar_fecha_reserva[]" class="form-control" value="{{ lugar.fecha_reserva.strftime('%Y-%m-%d') if lugar.fecha_reserva }}">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Guía Local</label>
                            <select name="lugar_guia_local[]" class="form-select">
                                <option value="No" {% if lugar.guia_local == 'No' %}selected{% endif %}>No</option>
                                <option value="Si" {% if lugar.guia_local == 'Si' %}selected{% endif %}>Si</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Nombre Guía</label>
                            <input type="text" name="lugar_nombre_guia[]" class="form-control" value="{{ lugar.nombre_guia or '' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Teléfono del Lugar</label>
                            <input type="tel" name="lugar_telefono_lugar[]" class="form-control" value="{{ lugar.telefono_lugar or '' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Teléfono del Contacto</label>
                            <input type="tel" name="lugar_telefono_contacto[]" class="form-control" value="{{ lugar.telefono_contacto or '' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Whatsapp del Contacto</label>
                            <input type="tel" name="lugar_whatsapp_contacto[]" class="form-control" value="{{ lugar.whatsapp_contacto or '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" name="lugar_email[]" class="form-control" value="{{ lugar.email or '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Enlaces</label>
                            <input type="text" name="lugar_enlaces[]" class="form-control" value="{{ lugar.enlaces or '' }}">
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Nota</label>
                            <textarea name="lugar_nota[]" class="form-control" rows="2">{{ lugar.nota or '' }}</textarea>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="card-footer bg-light">
                <strong>TOTAL DE ATRACCIONES: <span id="total-atracciones">0.00</span> CRC</strong>
            </div>
        </div>
        
        <!-- SEPARADOR TRANSPORTES -->
        <hr class="form-section-separator">
        <h2 class="text-center mb-4">Transportes</h2>
        <div class="card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Transporte Local</h5>
                 <button type="button" class="btn btn-sm btn-outline-warning" onclick="addDynamicForm('transporte-container', 'transporte-template')">
                    <i class="fas fa-plus"></i> Agregar Transporte
                </button>
            </div>
            <div class="card-body" id="transporte-container">
                {% for transporte in viaje.transportes %}
                <div class="dynamic-item p-3 mb-3 border rounded">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Transporte #<span class="item-number">{{ loop.index }}</span></h6>
                        <button type="button" class="btn-close" aria-label="Close" onclick="this.closest('.dynamic-item').remove(); calculateTotals();"></button>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tipo</label>
                            <select name="transporte_tipo[]" class="form-select">
                                <option {% if transporte.tipo_transporte == 'Buseta' %}selected{% endif %}>Buseta</option>
                                <option {% if transporte.tipo_transporte == 'Bus' %}selected{% endif %}>Bus</option>
                                <option {% if transporte.tipo_transporte == 'Taxi' %}selected{% endif %}>Taxi</option>
                                <option {% if transporte.tipo_transporte == 'Uber' %}selected{% endif %}>Uber</option>
                                <option {% if transporte.tipo_transporte == 'Auto' %}selected{% endif %}>Auto</option>
                                <option {% if transporte.tipo_transporte == 'Lancha' %}selected{% endif %}>Lancha</option>
                                <option {% if transporte.tipo_transporte == 'Avión' %}selected{% endif %}>Avión</option>
                            </select>
                        </div>
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Nombre del Transporte</label>
                            <input type="text" name="transporte_nombre[]" class="form-control" value="{{ transporte.nombre_transporte or '' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Precio del Transporte (CRC)</label>
                            <input type="number" step="0.01" name="transporte_precio[]" class="form-control price-field" value="{{ transporte.precio or 0 }}" oninput="calculateTotals()">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Nombre Conductor</label>
                            <input type="text" name="transporte_conductor[]" class="form-control" value="{{ transporte.conductor or '' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Fecha Contratación</label>
                            <input type="date" name="transporte_fecha_contratacion[]" class="form-control" value="{{ transporte.fecha_contratacion.strftime('%Y-%m-%d') if transporte.fecha_contratacion }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Teléfono del Lugar</label>
                            <input type="tel" name="transporte_telefono_lugar[]" class="form-control" value="{{ transporte.telefono_lugar or '' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Teléfono del contacto</label>
                            <input type="tel" name="transporte_telefono_contacto[]" class="form-control" value="{{ transporte.telefono_contacto or '' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Whatsapp del Contacto</label>
                            <input type="tel" name="transporte_whatsapp_contacto[]" class="form-control" value="{{ transporte.whatsapp_contacto or '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" name="transporte_email[]" class="form-control" value="{{ transporte.email or '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Enlaces</label>
                            <input type="text" name="transporte_enlaces[]" class="form-control" value="{{ transporte.enlaces or '' }}">
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Nota</label>
                            <textarea name="transporte_nota[]" class="form-control" rows="2">{{ transporte.nota or '' }}</textarea>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="card-footer bg-light">
                <strong>TOTAL DE TRANSPORTE: <span id="total-transporte">0.00</span> CRC</strong>
            </div>
        </div>
        
        <!-- SEPARADOR GUÍAS -->
        <hr class="form-section-separator">
        <h2 class="text-center mb-4">Guías</h2>
        <div class="card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Guías Turísticos</h5>
                 <button type="button" class="btn btn-sm btn-outline-warning" onclick="addDynamicForm('guia-container', 'guia-template')">
                    <i class="fas fa-plus"></i> Agregar Guía
                </button>
            </div>
            <div class="card-body" id="guia-container">
                {% for guia in viaje.guias %}
                <div class="dynamic-item p-3 mb-3 border rounded">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Guía #<span class="item-number">{{ loop.index }}</span></h6>
                        <button type="button" class="btn-close" aria-label="Close" onclick="this.closest('.dynamic-item').remove(); calculateTotals();"></button>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre</label>
                            <input type="text" name="guia_nombre[]" class="form-control" value="{{ guia.nombre or '' }}">
                        </div>
                         <div class="col-md-3 mb-3">
                            <label class="form-label">Precio Guía PP (CRC)</label>
                            <input type="number" step="0.01" name="guia_precio_pp[]" class="form-control price-field" value="{{ guia.precio_guia_pp or 0 }}" oninput="calculateTotals()">
                        </div>
                         <div class="col-md-3 mb-3">
                            <label class="form-label">Precio Acarreo (CRC)</label>
                            <input type="number" step="0.01" name="guia_precio_acarreo[]" class="form-control price-field" value="{{ guia.precio_acarreo or 0 }}" oninput="calculateTotals()">
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="card-footer bg-light">
                <strong>TOTAL DE GUÍAS POR PERSONA: <span id="total-guias">0.00</span> CRC</strong>
            </div>
        </div>

        <!-- SEPARADOR ESTADÍAS -->
        <hr class="form-section-separator">
        <h2 class="text-center mb-4">Estadías</h2>
        <div class="card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Hospedaje</h5>
                 <button type="button" class="btn btn-sm btn-outline-warning" onclick="addDynamicForm('estadia-container', 'estadia-template')">
                    <i class="fas fa-plus"></i> Agregar Estadía
                </button>
            </div>
            <div class="card-body" id="estadia-container">
                {% for estadia in viaje.estadias %}
                <div class="dynamic-item p-3 mb-3 border rounded">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Estadía #<span class="item-number">{{ loop.index }}</span></h6>
                        <button type="button" class="btn-close" aria-label="Close" onclick="this.closest('.dynamic-item').remove(); calculateTotals();"></button>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre</label>
                            <input type="text" name="estadia_nombre[]" class="form-control" value="{{ estadia.nombre or '' }}">
                        </div>
                         <div class="col-md-3 mb-3">
                            <label class="form-label">Precio PP por Noche (CRC)</label>
                            <input type="number" step="0.01" name="estadia_precio_pp[]" class="form-control price-field" value="{{ estadia.precio_pp or 0 }}" oninput="calculateTotals()">
                        </div>
                         <div class="col-md-3 mb-3">
                            <label class="form-label">Cantidad de Noches</label>
                            <input type="number" name="estadia_noches[]" class="form-control" value="{{ estadia.cantidad_noches or 1 }}" oninput="calculateTotals()">
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="card-footer bg-light">
                <strong>TOTAL DE ESTADÍA POR PERSONA: <span id="total-estadia">0.00</span> CRC</strong>
            </div>
        </div>

        <!-- SEPARADOR AEROLINEA -->
        <hr class="form-section-separator">
        <h2 class="text-center mb-4">Aerolínea / Transporte Principal</h2>
        <div class="card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Transporte Principal</h5>
                 <button type="button" class="btn btn-sm btn-outline-warning" onclick="addDynamicForm('aerolinea-container', 'aerolinea-template')">
                    <i class="fas fa-plus"></i> Agregar Aerolínea/Transporte
                </button>
            </div>
            <div class="card-body" id="aerolinea-container">
                {% for aerolinea in viaje.aerolineas %}
                <div class="dynamic-item p-3 mb-3 border rounded">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Aerolínea/Transporte #<span class="item-number">{{ loop.index }}</span></h6>
                        <button type="button" class="btn-close" aria-label="Close" onclick="this.closest('.dynamic-item').remove(); calculateTotals();"></button>
                    </div>
                    <div class="row">
                         <div class="col-md-6 mb-3">
                            <label class="form-label">Aerolínea</label>
                            <input type="text" name="aerolinea_nombre[]" class="form-control" value="{{ aerolinea.nombre_aerolinea or '' }}">
                        </div>
                         <div class="col-md-6 mb-3">
                            <label class="form-label">Precio Vuelo (CRC)</label>
                            <input type="number" step="0.01" name="aerolinea_precio[]" class="form-control price-field" value="{{ aerolinea.precio_estandar or 0 }}" oninput="calculateTotals()">
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="card-footer bg-light">
                <strong>TOTAL DE AEROLÍNEA POR PERSONA: <span id="total-aerolinea">0.00</span> CRC</strong>
            </div>
        </div>

        <!-- TOTALES GENERALES -->
        <div class="card mt-5">
            <div class="card-header bg-dark text-white">
                <h3 class="mb-0">Totales Individuales Estimados</h3>
            </div>
            <div class="card-body fs-5">
                <div class="row">
                    <div class="col-md-6">
                        <strong>TOTAL INDIVIDUAL CRC:</strong>
                        <p class="text-success fw-bold" id="total-individual-crc">0.00 CRC</p>
                    </div>
                    <div class="col-md-6">
                        <strong>TOTAL INDIVIDUAL USD:</strong>
                        <p class="text-primary fw-bold" id="total-individual-usd">0.00 USD</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="d-grid gap-2 mt-4">
            <button type="submit" class="btn btn-warning btn-lg">Guardar Cambios</button>
        </div>
    </form>
</div>

<!-- =========== TEMPLATES (Igual que en crear_intern.html) =========== -->
<template id="prealerta-template">
    <div class="dynamic-item p-3 mb-3 border rounded">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Pre-Alerta #<span class="item-number">1</span></h6>
            <button type="button" class="btn-close" aria-label="Close" onclick="this.closest('.dynamic-item').remove()"></button>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Entidad Financiera</label>
                <select name="prealerta_banco[]" class="form-select">
                    <option selected disabled value="">Seleccionar...</option>
                    <option>Banco de Costa Rica (BCR)</option>
                    <option>Banco Nacional de Costa Rica (BNCR)</option>
                    <option>Banco Popular</option>
                    <option>Mucap</option>
                    <option>Mutual</option>
                    <option>BAC Credomatic</option>
                    <option>Banco Cathay</option>
                    <option>Banco BCT</option>
                    <option>Banco CMB</option>
                    <option>Banco Davivienda</option>
                    <option>Banco General</option>
                    <option>Banco Improsa</option>
                    <option>Banco Lafise</option>
                    <option>Banco Promérica</option>
                    <option>Prival Bank</option>
                    <option>Scotiabank</option>
                    <option>Coopealianza</option>
                    <option>Coopeande</option>
                    <option>CoopeAnde No. 1</option>
                    <option>CoopeAnde No. 2</option>
                    <option>CoopeAnde No. 3</option>
                    <option>CoopeAnde No. 4</option>
                    <option>CoopeAnde No. 5</option>
                    <option>CoopeAnde No. 6</option>
                    <option>CoopeAnde No. 7</option>
                    <option>CoopeAnde No. 8</option>
                    <option>CoopeAnde No. 9</option>
                    <option>CoopeAnde No. 10</option>
                    <option>CoopeAnde No. 11</option>
                    <option>CoopeCaja</option>
                    <option>Caja de ANDE</option>
                    <option>COOPENAE</option>
                    <option>COOPEUCHA</option>
                    <option>COOPESANRAMON</option>
                    <option>COOPESERVIDORES</option>
                    <option>COOPEUNA</option>
                    <option>CREDECOOP</option>
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Teléfono Entidad Financiera</label>
                <input type="tel" name="prealerta_telefono[]" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Fecha de la prealerta</label>
                <input type="date" name="prealerta_fecha[]" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Nombre del Asesor Bancario</label>
                <input type="text" name="prealerta_asesor[]" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Hora de la Prealerta</label>
                <input type="time" name="prealerta_hora[]" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Número de la prealerta</label>
                <input type="text" name="prealerta_numero[]" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Fecha prealertada (Desde)</label>
                <input type="date" name="prealerta_desde[]" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Fecha prealertada (Hasta)</label>
                <input type="date" name="prealerta_hasta[]" class="form-control">
            </div>
        </div>
    </div>
</template>

<template id="lugar-template">
    <div class="dynamic-item p-3 mb-3 border rounded">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Lugar #<span class="item-number">1</span></h6>
            <button type="button" class="btn-close" aria-label="Close" onclick="this.closest('.dynamic-item').remove(); calculateTotals();"></button>
        </div>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label">Tipo</label>
                <select name="lugar_tipo[]" class="form-select">
                    <option>Volcán</option><option>Montaña</option><option>Playa</option><option>Ciudad</option><option>Parque Nacional</option><option>Camino</option><option>Otros</option>
                </select>
            </div>
            <div class="col-md-8 mb-3">
                <label class="form-label">Nombre del Sitio</label>
                <input type="text" name="lugar_nombre[]" class="form-control">
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Precio Entrada (CRC)</label>
                <input type="number" step="0.01" name="lugar_precio[]" class="form-control price-field" value="0" oninput="calculateTotals()">
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Fecha Reserva</label>
                <input type="date" name="lugar_fecha_reserva[]" class="form-control">
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Guía Local</label>
                <select name="lugar_guia_local[]" class="form-select">
                    <option value="No">No</option>
                    <option value="Si">Si</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Nombre Guía</label>
                <input type="text" name="lugar_nombre_guia[]" class="form-control">
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Teléfono del Lugar</label>
                <input type="tel" name="lugar_telefono_lugar[]" class="form-control">
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Teléfono del Contacto</label>
                <input type="tel" name="lugar_telefono_contacto[]" class="form-control">
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Whatsapp del Contacto</label>
                <input type="tel" name="lugar_whatsapp_contacto[]" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Email</label>
                <input type="email" name="lugar_email[]" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Enlaces</label>
                <input type="text" name="lugar_enlaces[]" class="form-control">
            </div>
            <div class="col-12 mb-3">
                <label class="form-label">Nota</label>
                <textarea name="lugar_nota[]" class="form-control" rows="2"></textarea>
            </div>
        </div>
    </div>
</template>

<template id="transporte-template">
     <div class="dynamic-item p-3 mb-3 border rounded">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Transporte #<span class="item-number">1</span></h6>
            <button type="button" class="btn-close" aria-label="Close" onclick="this.closest('.dynamic-item').remove(); calculateTotals();"></button>
        </div>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label">Tipo</label>
                <select name="transporte_tipo[]" class="form-select">
                    <option>Buseta</option><option>Bus</option><option>Taxi</option><option>Uber</option><option>Auto</option><option>Lancha</option><option>Avión</option>
                </select>
            </div>
            <div class="col-md-8 mb-3">
                <label class="form-label">Nombre del Transporte</label>
                <input type="text" name="transporte_nombre[]" class="form-control">
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Precio del Transporte (CRC)</label>
                <input type="number" step="0.01" name="transporte_precio[]" class="form-control price-field" value="0" oninput="calculateTotals()">
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Nombre Conductor</label>
                <input type="text" name="transporte_conductor[]" class="form-control">
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Fecha Contratación</label>
                <input type="date" name="transporte_fecha_contratacion[]" class="form-control">
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Teléfono del Lugar</label>
                <input type="tel" name="transporte_telefono_lugar[]" class="form-control">
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Teléfono del contacto</label>
                <input type="tel" name="transporte_telefono_contacto[]" class="form-control">
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Whatsapp del Contacto</label>
                <input type="tel" name="transporte_whatsapp_contacto[]" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Email</label>
                <input type="email" name="transporte_email[]" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Enlaces</label>
                <input type="text" name="transporte_enlaces[]" class="form-control">
            </div>
            <div class="col-12 mb-3">
                <label class="form-label">Nota</label>
                <textarea name="transporte_nota[]" class="form-control" rows="2"></textarea>
            </div>
        </div>
    </div>
</template>

<!-- ... (Otras plantillas) ... -->

{% endblock %}

{% block scripts %}
<script>
    function addDynamicForm(containerId, templateId) {
        const container = document.getElementById(containerId);
        const template = document.getElementById(templateId);
        if (!template) {
            console.error("Template not found:", templateId);
            return;
        }
        const clone = template.content.cloneNode(true);
        
        const itemNumber = container.querySelectorAll('.dynamic-item').length + 1;
        const numberSpan = clone.querySelector('.item-number');
        if (numberSpan) {
            numberSpan.textContent = itemNumber;
        }
        
        container.appendChild(clone);
    }

    function calculateTotals() {
        // Total Atracciones
        let totalAtracciones = 0;
        document.querySelectorAll('#lugar-container .price-field').forEach(input => {
            totalAtracciones += parseFloat(input.value) || 0;
        });
        document.getElementById('total-atracciones').textContent = totalAtracciones.toFixed(2);

        // Total Transporte
        let totalTransporte = 0;
        document.querySelectorAll('#transporte-container .price-field').forEach(input => {
            totalTransporte += parseFloat(input.value) || 0;
        });
        document.getElementById('total-transporte').textContent = totalTransporte.toFixed(2);
        
        // Total Guías PP
        let totalGuias = 0;
        document.querySelectorAll('#guia-container .dynamic-item').forEach(item => {
            const precioPP = parseFloat(item.querySelector('input[name="guia_precio_pp[]"]').value) || 0;
            const precioAcarreo = parseFloat(item.querySelector('input[name="guia_precio_acarreo[]"]').value) || 0;
            totalGuias += precioPP + precioAcarreo;
        });
        document.getElementById('total-guias').textContent = totalGuias.toFixed(2);

        // Total Estadía PP
        let totalEstadia = 0;
        document.querySelectorAll('#estadia-container .dynamic-item').forEach(item => {
            const precioPP = parseFloat(item.querySelector('input[name="estadia_precio_pp[]"]').value) || 0;
            const noches = parseInt(item.querySelector('input[name="estadia_noches[]"]').value) || 1;
            totalEstadia += precioPP * noches;
        });
        document.getElementById('total-estadia').textContent = totalEstadia.toFixed(2);

        // Total Aerolínea PP
        let totalAerolinea = 0;
        document.querySelectorAll('#aerolinea-container .price-field').forEach(input => {
            totalAerolinea += parseFloat(input.value) || 0;
        });
        document.getElementById('total-aerolinea').textContent = totalAerolinea.toFixed(2);
        
        // Gran Total Individual
        const totalIndividualCRC = totalAtracciones + totalTransporte + totalGuias + totalEstadia + totalAerolinea;
        document.getElementById('total-individual-crc').textContent = totalIndividualCRC.toFixed(2) + ' CRC';

        const tipoCambio = parseFloat(document.getElementById('tipo_cambio').value) || 1;
        const totalIndividualUSD = totalIndividualCRC / tipoCambio;
        document.getElementById('total-individual-usd').textContent = totalIndividualUSD.toFixed(2) + ' USD';
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        calculateTotals();
    });
</script>
{% endblock %}
