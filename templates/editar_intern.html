{% extends 'base.html' %}
{% block title %}Editar Viaje{% endblock %}
{% block head_content %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            border: 1px solid #dee2e6;
            box-shadow: none !important;
        }
        .card-header {
            background-color: #ffc107;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
        }
        .btn-add {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .total-field {
            font-size: 1.1rem;
            font-weight: 500;
        }
        .form-control:disabled, .form-control[readonly] {
            background-color: #e9ecef;
            opacity: 1;
        }
        .current-flyer {
            max-width: 150px;
            height: auto;
            border-radius: .25rem;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container my-5">
        <h1 class="text-center mb-4">Editando Viaje: {{ viaje.nombre_viaje }}</h1>

        <form action="{{ url_for('intern.editar_intern', viaje_id=viaje.id) }}" method="POST" enctype="multipart/form-data" id="viajeForm">
            <!-- Card Principal del Viaje -->
            <div class="card mb-4">
                <div class="card-header">
                    Información General del Viaje
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="nombre_viaje" class="form-label">Nombre del Viaje</label>
                            <input type="text" class="form-control" id="nombre_viaje" name="nombre_viaje" value="{{ viaje.nombre_viaje }}" required>
                        </div>
                        <div class="col-md-6">
                            <label for="pais" class="form-label">País de Destino</label>
                            <select class="form-select" id="pais" name="pais" required>
                                <option value="Panama" {% if viaje.pais == 'Panama' %}selected{% endif %}>Panamá</option>
                                <option value="Nicaragua" {% if viaje.pais == 'Nicaragua' %}selected{% endif %}>Nicaragua</option>
                                <option value="Honduras" {% if viaje.pais == 'Honduras' %}selected{% endif %}>Honduras</option>
                                <option value="El Salvador" {% if viaje.pais == 'El Salvador' %}selected{% endif %}>El Salvador</option>
                                <option value="Guatemala" {% if viaje.pais == 'Guatemala' %}selected{% endif %}>Guatemala</option>
                                <option value="Mexico" {% if viaje.pais == 'Mexico' %}selected{% endif %}>México</option>
                                <option value="Peru" {% if viaje.pais == 'Peru' %}selected{% endif %}>Perú</option>
                                <option value="Espana" {% if viaje.pais == 'Espana' %}selected{% endif %}>España</option>
                            </select>
                        </div>
                        <div class="col-md-12">
                            <label for="flyer" class="form-label">Cambiar Flyer del Viaje</label>
                            <input class="form-control" type="file" id="flyer" name="flyer">
                            {% if viaje.flyer_url and viaje.flyer_url != 'None' %}
                            <div class="mt-2">
                                <small class="text-muted">Flyer actual:</small><br>
                                <img src="{{ url_for('static', filename=viaje.flyer_url) }}" alt="Flyer actual" class="current-flyer">
                            </div>
                            {% endif %}
                        </div>
                         <div class="col-md-6">
                            <label for="fecha_viaje" class="form-label">Fecha del Viaje</label>
                            <input type="date" class="form-control" id="fecha_viaje" name="fecha_viaje" value="{{ viaje.fecha_viaje }}" required>
                        </div>
                        <div class="col-md-6">
                            <label for="fecha_regreso" class="form-label">Fecha de Regreso</label>
                            <input type="date" class="form-control" id="fecha_regreso" name="fecha_regreso" value="{{ viaje.fecha_regreso }}" required>
                        </div>
                        <div class="col-md-6">
                            <label for="cantidad_dias" class="form-label">Cantidad de Días</label>
                            <input type="number" class="form-control" id="cantidad_dias" name="cantidad_dias" min="1" value="{{ viaje.cantidad_dias }}" required>
                        </div>
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-6">
                                    <label for="precio_viaje" class="form-label">Precio del Viaje (USD)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="precio_viaje" name="precio_viaje" step="1" min="0" value="{{ viaje.precio_viaje_usd|int }}" required>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label for="precio_viaje_crc" class="form-label">Precio de Viaje (CRC)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">₡</span>
                                        <input type="text" class="form-control" id="precio_viaje_crc" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="capacidad_sg" class="form-label">Capacidad S/G (Sin Guía)</label>
                            <input type="number" class="form-control" id="capacidad_sg" name="capacidad_sg" min="0" value="{{ viaje.capacidad_sg }}" required>
                        </div>
                        <div class="col-md-6">
                            <label for="capacidad_cg" class="form-label">Capacidad C/G (Con Guía)</label>
                            <input type="number" class="form-control" id="capacidad_cg" name="capacidad_cg" min="0" value="{{ viaje.capacidad_cg }}" required>
                        </div>
                        <div class="col-md-6">
                            <label for="tipo_moneda" class="form-label">Tipo de Moneda Base</label>
                            <select class="form-select" id="tipo_moneda" name="tipo_moneda">
                                <option value="USD" {% if viaje.tipo_moneda_base == 'USD' %}selected{% endif %}>USD</option>
                                <option value="CRC" {% if viaje.tipo_moneda_base == 'CRC' %}selected{% endif %}>CRC</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="tipo_cambio" class="form-label">Tipo de Cambio (USD a CRC)</label>
                             <div class="input-group">
                                <span class="input-group-text">₡</span>
                                <input type="number" class="form-control" id="tipo_cambio" name="tipo_cambio" step="1" min="0" value="{{ viaje.tipo_cambio_a_crc|int }}" required>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección de Pagos -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Registro de Pagos y Servicios</span>
                    <button type="button" class="btn btn-primary btn-sm btn-add" id="addPagoBtn">
                        <i class="bi bi-plus-circle"></i> Agregar Nuevo Pago
                    </button>
                </div>
                <div class="card-body" id="pagosContainer">
                    <!-- Bucle para renderizar los pagos existentes -->
                    {% for pago in viaje.pagos_y_servicios %}
                    {% set pago_index = loop.index %}
                    <div class="card mb-3 pago-item">
                        <div class="card-body">
                            <h6 class="card-title">Detalle del Pago #{{ pago_index }}</h6>
                            <div class="row g-3">
                               <div class="col-md-4">
                                    <label class="form-label">Tipo de Pago</label>
                                    <select class="form-select tipo-pago-select" name="pagos[{{ pago_index }}][tipo_pago]">
                                        <option {% if pago.tipo_pago == 'Estadía' %}selected{% endif %}>Estadía</option>
                                        <option {% if pago.tipo_pago == 'Transporte' %}selected{% endif %}>Transporte</option>
                                        <option {% if pago.tipo_pago == 'Bancario' %}selected{% endif %}>Bancario</option>
                                        <option {% if pago.tipo_pago == 'Guía' %}selected{% endif %}>Guía</option>
                                        <option {% if pago.tipo_pago == 'Operador' %}selected{% endif %}>Operador</option>
                                        <option {% if pago.tipo_pago == 'Agencia' %}selected{% endif %}>Agencia</option>
                                        <option {% if pago.tipo_pago == 'Aéreo' %}selected{% endif %}>Aéreo</option>
                                        <option {% if pago.tipo_pago == 'Alimentación' %}selected{% endif %}>Alimentación</option>
                                        <option {% if pago.tipo_pago == 'Otro' %}selected{% endif %}>Otro</option>
                                    </select>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label">Nombre del Contacto o Empresa</label>
                                    <input type="text" class="form-control" name="pagos[{{ pago_index }}][nombre_contacto]" value="{{ pago.get('nombre_contacto', '') }}">
                                </div>
                                
                                <div class="col-md-12 aerolineas-container" style="display: {% if pago.tipo_pago == 'Aéreo' %}block{% else %}none{% endif %};">
                                    <label class="form-label">Aerolinea</label>
                                    <select class="form-select" name="pagos[{{ pago_index }}][aerolinea]">
                                        {% set aerolineas = ['ARAJET', 'AEROMEXICO', 'AIR CANADA', 'AIRFRANCE', 'AIRTRANSAT', 'ALASKA', 'AMERICAN AIRLINES', 'AVIANCA', 'BRITISH AIRWAYS', 'COSTA RICA GREEN AIRWAYS', 'COPA', 'DELTA', 'EDELWEISS', 'FRONTIER', 'GOL', 'IBERIA', 'IBEROJET', 'JETBLUE', 'KLM', 'LATAM', 'LUFTHANSA', 'SANSA', 'SOUTHWEST', 'SPIRIT', 'UNITED AIRLINES', 'VOLARIS', 'WINGO'] %}
                                        {% for aerolinea in aerolineas %}
                                        <option {% if pago.aerolinea == aerolinea %}selected{% endif %}>{{ aerolinea }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="col-md-12 aereo-fields-container" style="display: {% if pago.tipo_pago == 'Aéreo' %}block{% else %}none{% endif %};">
                                    <div class="row g-3 mt-1">
                                        <div class="col-md-3">
                                            <label class="form-label">Precio IDA</label>
                                            <input type="number" class="form-control" name="pagos[{{ pago_index }}][precio_ida]" step="1" min="0" value="{{ pago.get('precio_ida', '') }}">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Precio Vuelta</label>
                                            <input type="number" class="form-control" name="pagos[{{ pago_index }}][precio_vuelta]" step="1" min="0" value="{{ pago.get('precio_vuelta', '') }}">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">I.V.I</label>
                                            <select class="form-select ivi-select" name="pagos[{{ pago_index }}][ivi]">
                                                <option {% if pago.ivi == 'Si' %}selected{% endif %}>Si</option>
                                                <option {% if pago.ivi == 'No' %}selected{% endif %}>No</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3 impuesto-container" style="display: {% if pago.ivi == 'No' %}block{% else %}none{% endif %};">
                                            <label class="form-label">Precio Impuesto</label>
                                            <input type="number" class="form-control" name="pagos[{{ pago_index }}][precio_impuesto]" step="1" min="0" value="{{ pago.get('precio_impuesto', '') }}">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Total Neto por persona</label>
                                            <input type="text" class="form-control total-neto-persona-aereo" readonly>
                                        </div>
                                    </div>
                                </div>

                                <div class="pago-regular-fields-wrapper" style="display: {% if pago.tipo_pago != 'Aéreo' %}block{% else %}none{% endif %};">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Cantidad de Días/Eventos</label>
                                            <input type="number" class="form-control cantidad-dias-evento" name="pagos[{{ pago_index }}][cantidad_dias_evento]" value="{{ pago.get('cantidad_dias_evento', '') }}" min="0">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Precio USD | Día P.P.</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control precio-nuevo-pago" name="pagos[{{ pago_index }}][precio]" step="1" min="0" value="{{ pago.get('precio', '') }}">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Total USD P.P.</label>
                                            <input type="text" class="form-control total-nuevo-pago" readonly>
                                        </div>
                                    </div>
                                    <hr class="my-3">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Precio Grupal</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control precio-grupal" name="pagos[{{ pago_index }}][precio_grupal]" step="1" min="0" value="{{ pago.get('precio_grupal', '') }}">
                                            </div>
                                        </div>
                                         <div class="col-md-4">
                                            <label class="form-label">Total Grupal USD</label>
                                            <input type="text" class="form-control total-pago-individual" readonly>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Neto P.P.</label>
                                            <input type="text" class="form-control neto-pp" readonly>
                                        </div>
                                    </div>
                                </div>
                                 <div class="col-md-4">
                                    <label class="form-label">Póliza</label>
                                    <select class="form-select" name="pagos[{{ pago_index }}][poliza]">
                                        <option {% if pago.poliza == 'No Aplica' %}selected{% endif %}>No Aplica</option>
                                        <option {% if pago.poliza == 'Si' %}selected{% endif %}>Si</option>
                                        <option {% if pago.poliza == 'No' %}selected{% endif %}>No</option>
                                    </select>
                                </div>
                            </div>
                            <hr>
                            <div class="dynamic-fields-container mt-3">
                                <div id="telefonosContainer_{{ pago_index }}">
                                    {% for tel in pago.get('telefonos', []) %}
                                    {% set timestamp = loop.index0 %}
                                    <div class="input-group mb-2">
                                        <select class="input-group-text" name="pagos[{{ pago_index }}][telefonos][{{ timestamp }}][tipo]">
                                            <option {% if tel.tipo == 'WHATSAPP' %}selected{% endif %}>WHATSAPP</option>
                                            <option {% if tel.tipo == 'PERSONAL' %}selected{% endif %}>PERSONAL</option>
                                            <option {% if tel.tipo == 'EMPRESA' %}selected{% endif %}>EMPRESA</option>
                                        </select>
                                        <input type="text" class="form-control" placeholder="Código País" name="pagos[{{ pago_index }}][telefonos][{{ timestamp }}][codigo]" value="{{ tel.get('codigo', '') }}">
                                        <input type="tel" class="form-control" placeholder="Número" name="pagos[{{ pago_index }}][telefonos][{{ timestamp }}][numero]" value="{{ tel.get('numero', '') }}">
                                        <input type="text" class="form-control" placeholder="Contacto/Empresa" name="pagos[{{ pago_index }}][telefonos][{{ timestamp }}][contacto]" value="{{ tel.get('contacto', '') }}">
                                        <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()"><i class="bi bi-x-lg"></i></button>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="d-flex flex-wrap gap-2 mt-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm btn-add" onclick="addDynamicField('telefono', '{{ pago_index }}')"><i class="bi bi-telephone-plus"></i> Teléfono</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm btn-add" onclick="addDynamicField('email', '{{ pago_index }}')"><i class="bi bi-envelope-plus"></i> Email</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm btn-add" onclick="addDynamicField('url', '{{ pago_index }}')"><i class="bi bi-link-45deg"></i> Enlace URL</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm btn-add" onclick="addDynamicField('servicio', '{{ pago_index }}')"><i class="bi bi-card-text"></i> Servicio</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm btn-add" onclick="addDynamicField('fecha', '{{ pago_index }}')"><i class="bi bi-calendar-plus"></i> Fecha</button>
                                <button type="button" class="btn btn-danger btn-sm float-end" onclick="this.closest('.pago-item').remove(); calcularTodosLosTotales();"><i class="bi bi-trash"></i></button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                 <div class="card-footer">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Precio P.P. USD C/Guias:</strong> <span id="precioConCoordinadoresUSD" class="total-field">$0</span></p>
                            <p class="mb-0"><strong>Precio General USD C/Guias:</strong> <span id="precioGeneralCoordinadoresUSD" class="total-field">$0</span></p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Precio P.P. CRC C/Guia:</strong> <span id="precioConCoordinadoresCRC" class="total-field">₡0</span></p>
                            <p class="mb-0"><strong>Precio General CRC C/Guias:</strong> <span id="precioGeneralCoordinadoresCRC" class="total-field">₡0</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Totales -->
            <div class="card">
                <div class="card-header">
                    Resumen Financiero
                </div>
                <div class="card-body">
                     <div class="row g-4">
                        <div class="col-lg-12">
                            <h5>Excedente (Ganancia)</h5>
                             <ul class="list-group">
                                <li class="list-group-item d-flex justify-content-between align-items-center">Excedente General (USD):<span class="badge bg-success rounded-pill total-field" id="excedenteGeneralUSD">$0</span></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">Excedente General (CRC):<span class="badge bg-success rounded-pill total-field" id="excedenteGeneralCRC">₡0</span></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">Excedente Individual (USD):<span class="badge bg-warning text-dark rounded-pill total-field" id="excedenteIndividualUSD">$0</span></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">Excedente Individual (CRC):<span class="badge bg-warning text-dark rounded-pill total-field" id="excedenteIndividualCRC">₡0</span></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-warning btn-lg">Guardar Cambios</button>
            </div>
        </form>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let pagoIndex = {{ viaje.pagos_y_servicios|length }};

            document.getElementById('addPagoBtn').addEventListener('click', addPago);
            document.getElementById('viajeForm').addEventListener('input', calcularTodosLosTotales);
            
            const pagosContainer = document.getElementById('pagosContainer');

            pagosContainer.addEventListener('input', function(e) {
                const pagoItem = e.target.closest('.pago-item');
                if (!pagoItem) return;

                const cantidadInput = pagoItem.querySelector('.cantidad-dias-evento');
                const precioInput = pagoItem.querySelector('.precio-nuevo-pago');
                const precioGrupalInput = pagoItem.querySelector('.precio-grupal');

                if (e.target === precioGrupalInput) {
                    if (precioGrupalInput.value) {
                        cantidadInput.disabled = true;
                        precioInput.disabled = true;
                        cantidadInput.value = '';
                        precioInput.value = '';
                    } else {
                        cantidadInput.disabled = false;
                        precioInput.disabled = false;
                    }
                } else if (e.target === cantidadInput || e.target === precioInput) {
                    if (cantidadInput.value || precioInput.value) {
                        precioGrupalInput.disabled = true;
                        precioGrupalInput.value = '';
                    } else {
                        precioGrupalInput.disabled = false;
                    }
                }
            });

            pagosContainer.addEventListener('change', function(e) {
                const pagoItem = e.target.closest('.pago-item');
                if (!pagoItem) return;

                if (e.target.classList.contains('tipo-pago-select')) {
                    const aerolineasContainer = pagoItem.querySelector('.aerolineas-container');
                    const aereoFieldsContainer = pagoItem.querySelector('.aereo-fields-container');
                    const regularFieldsContainer = pagoItem.querySelector('.pago-regular-fields-wrapper');

                    if (e.target.value === 'Aéreo') {
                        aerolineasContainer.style.display = 'block';
                        aereoFieldsContainer.style.display = 'block';
                        regularFieldsContainer.style.display = 'none';
                    } else {
                        aerolineasContainer.style.display = 'none';
                        aereoFieldsContainer.style.display = 'none';
                        regularFieldsContainer.style.display = 'block';
                    }
                }

                if (e.target.classList.contains('ivi-select')) {
                    const impuestoContainer = pagoItem.querySelector('.impuesto-container');
                    if (e.target.value === 'No') {
                        impuestoContainer.style.display = 'block';
                    } else {
                        impuestoContainer.style.display = 'none';
                    }
                }
            });

            function addPago() {
                pagoIndex++;
                const newIndex = 'new_' + pagoIndex;
                const container = document.getElementById('pagosContainer');
                const newPagoDiv = document.createElement('div');
                newPagoDiv.className = 'card mb-3 pago-item';

                const randomHue = Math.floor(Math.random() * 20) + 25;
                newPagoDiv.style.backgroundColor = `hsl(${randomHue}, 100%, 97%)`;

                newPagoDiv.innerHTML = `
                    <div class="card-body">
                        <h6 class="card-title">Detalle del Nuevo Pago</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Tipo de Pago</label>
                                <select class="form-select tipo-pago-select" name="pagos[${newIndex}][tipo_pago]">
                                    <option>Estadía</option><option>Transporte</option><option>Bancario</option><option>Guía</option><option>Operador</option><option>Agencia</option><option>Aéreo</option><option>Alimentación</option><option>Otro</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Nombre del Contacto o Empresa</label>
                                <input type="text" class="form-control" name="pagos[${newIndex}][nombre_contacto]">
                            </div>
                             <div class="col-md-12 aerolineas-container" style="display: none;">
                                <label class="form-label">Aerolinea</label>
                                <select class="form-select" name="pagos[${newIndex}][aerolinea]">
                                    <option>ARAJET</option><option>AEROMEXICO</option><option>AIR CANADA</option><option>AIRFRANCE</option><option>AIRTRANSAT</option><option>ALASKA</option><option>AMERICAN AIRLINES</option><option>AVIANCA</option><option>BRITISH AIRWAYS</option><option>COSTA RICA GREEN AIRWAYS</option><option>COPA</option><option>DELTA</option><option>EDELWEISS</option><option>FRONTIER</option><option>GOL</option><option>IBERIA</option><option>IBEROJET</option><option>JETBLUE</option><option>KLM</option><option>LATAM</option><option>LUFTHANSA</option><option>SANSA</option><option>SOUTHWEST</option><option>SPIRIT</option><option>UNITED AIRLINES</option><option>VOLARIS</option><option>WINGO</option>
                                </select>
                            </div>
                            <div class="col-md-12 aereo-fields-container" style="display: none;">
                                <div class="row g-3 mt-1">
                                    <div class="col-md-3"><label class="form-label">Precio IDA</label><input type="number" class="form-control" name="pagos[${newIndex}][precio_ida]" step="1" min="0"></div>
                                    <div class="col-md-3"><label class="form-label">Precio Vuelta</label><input type="number" class="form-control" name="pagos[${newIndex}][precio_vuelta]" step="1" min="0"></div>
                                    <div class="col-md-3"><label class="form-label">I.V.I</label><select class="form-select ivi-select" name="pagos[${newIndex}][ivi]"><option>Si</option><option>No</option></select></div>
                                    <div class="col-md-3 impuesto-container" style="display: none;"><label class="form-label">Precio Impuesto</label><input type="number" class="form-control" name="pagos[${newIndex}][precio_impuesto]" step="1" min="0"></div>
                                    <div class="col-md-4"><label class="form-label">Total Neto por persona</label><input type="text" class="form-control total-neto-persona-aereo" readonly></div>
                                </div>
                            </div>
                            <div class="pago-regular-fields-wrapper">
                                <div class="row g-3">
                                    <div class="col-md-4"><label class="form-label">Cantidad de Días/Eventos</label><input type="number" class="form-control cantidad-dias-evento" name="pagos[${newIndex}][cantidad_dias_evento]" value="" min="0"></div>
                                    <div class="col-md-4"><label class="form-label">Precio USD | Día P.P.</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control precio-nuevo-pago" name="pagos[${newIndex}][precio]" step="1" min="0" value=""></div></div>
                                    <div class="col-md-4"><label class="form-label">Total USD P.P.</label><input type="text" class="form-control total-nuevo-pago" readonly></div>
                                </div>
                                <hr class="my-3">
                                <div class="row g-3">
                                    <div class="col-md-4"><label class="form-label">Precio Grupal</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control precio-grupal" name="pagos[${newIndex}][precio_grupal]" step="1" min="0" value=""></div></div>
                                    <div class="col-md-4"><label class="form-label">Total Grupal USD</label><input type="text" class="form-control total-pago-individual" readonly></div>
                                    <div class="col-md-4"><label class="form-label">Neto P.P.</label><input type="text" class="form-control neto-pp" readonly></div>
                                </div>
                            </div>
                            <div class="col-md-4"><label class="form-label">Póliza</label><select class="form-select" name="pagos[${newIndex}][poliza]"><option>No Aplica</option><option>Si</option><option>No</option></select></div>
                        </div>
                        <hr>
                        <div class="dynamic-fields-container mt-3">
                            <div id="telefonosContainer_${newIndex}"></div><div id="emailsContainer_${newIndex}"></div><div id="urlsContainer_${newIndex}"></div><div id="serviciosContainer_${newIndex}"></div><div id="fechasContainer_${newIndex}"></div>
                        </div>
                        <div class="d-flex flex-wrap gap-2 mt-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm btn-add" onclick="addDynamicField('telefono', '${newIndex}')"><i class="bi bi-telephone-plus"></i> Teléfono</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm btn-add" onclick="addDynamicField('email', '${newIndex}')"><i class="bi bi-envelope-plus"></i> Email</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm btn-add" onclick="addDynamicField('url', '${newIndex}')"><i class="bi bi-link-45deg"></i> Enlace URL</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm btn-add" onclick="addDynamicField('servicio', '${newIndex}')"><i class="bi bi-card-text"></i> Servicio</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm btn-add" onclick="addDynamicField('fecha', '${newIndex}')"><i class="bi bi-calendar-plus"></i> Fecha</button>
                            <button type="button" class="btn btn-danger btn-sm float-end" onclick="this.closest('.pago-item').remove(); calcularTodosLosTotales();"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>`;
                container.appendChild(newPagoDiv);
            }

            window.addDynamicField = function(type, pagoId) {
                const timestamp = Date.now();
                let container, newFieldHtml;
                if (type === 'telefono') {
                    container = document.getElementById(`telefonosContainer_${pagoId}`);
                    newFieldHtml = `<div class="input-group mb-2"><select class="input-group-text" name="pagos[${pagoId}][telefonos][${timestamp}][tipo]"><option>WHATSAPP</option><option>PERSONAL</option><option>EMPRESA</option></select><input type="text" class="form-control" placeholder="Código País" name="pagos[${pagoId}][telefonos][${timestamp}][codigo]"><input type="tel" class="form-control" placeholder="Número" name="pagos[${pagoId}][telefonos][${timestamp}][numero]"><input type="text" class="form-control" placeholder="Contacto/Empresa" name="pagos[${pagoId}][telefonos][${timestamp}][contacto]"><button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()"><i class="bi bi-x-lg"></i></button></div>`;
                } else if (type === 'email') {
                    container = document.getElementById(`emailsContainer_${pagoId}`);
                    newFieldHtml = `<div class="input-group mb-2"><span class="input-group-text"><i class="bi bi-envelope"></i></span><input type="email" class="form-control" placeholder="correo@ejemplo.com" name="pagos[${pagoId}][emails][${timestamp}][email]"><button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()"><i class="bi bi-x-lg"></i></button></div>`;
                } else if (type === 'url') {
                    container = document.getElementById(`urlsContainer_${pagoId}`);
                    newFieldHtml = `<div class="input-group mb-2"><span class="input-group-text"><i class="bi bi-link-45deg"></i></span><input type="url" class="form-control" placeholder="https://ejemplo.com" name="pagos[${pagoId}][urls][${timestamp}][url]"><button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()"><i class="bi bi-x-lg"></i></button></div>`;
                } else if (type === 'servicio') {
                    container = document.getElementById(`serviciosContainer_${pagoId}`);
                    newFieldHtml = `<div class="input-group mb-2"><span class="input-group-text"><i class="bi bi-card-text"></i></span><input type="text" class="form-control" placeholder="Descripción del servicio" name="pagos[${pagoId}][servicios][${timestamp}][descripcion]"><button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()"><i class="bi bi-x-lg"></i></button></div>`;
                } else if (type === 'fecha') {
                    container = document.getElementById(`fechasContainer_${pagoId}`);
                    newFieldHtml = `<div class="input-group mb-2"><span class="input-group-text"><i class="bi bi-calendar-plus"></i></span><input type="date" class="form-control" name="pagos[${pagoId}][fechas][${timestamp}][fecha]"><button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()"><i class="bi bi-x-lg"></i></button></div>`;
                }
                if (container) container.insertAdjacentHTML('beforeend', newFieldHtml);
            }

            function formatCurrency(value, currency = 'USD') {
                const options = { style: 'currency', currency: currency, minimumFractionDigits: 0, maximumFractionDigits: 0 };
                if (isNaN(value) || !isFinite(value)) value = 0;
                return new Intl.NumberFormat('es-CR', options).format(value);
            }

            function calcularTodosLosTotales() {
                const tipoCambio = parseFloat(document.getElementById('tipo_cambio').value) || 0;
                const precioViaje = parseFloat(document.getElementById('precio_viaje').value) || 0;
                const capacidadSG = parseFloat(document.getElementById('capacidad_sg').value) || 0;
                const capacidadCG = parseFloat(document.getElementById('capacidad_cg').value) || 0;
                
                let totalNetoUSD = 0;
                let precioCoordsUSD = 0;
                
                document.querySelectorAll('.pago-item').forEach(pago => {
                    const tipoPago = pago.querySelector('.tipo-pago-select').value;
                    const precioGrupalInput = pago.querySelector('.precio-grupal');
                    let totalIndividual = 0;
                    let totalRegular = 0;
                    let netoPP = 0;
                    let totalNetoPersonaAereo = 0;

                    if (tipoPago === 'Aéreo') {
                        const precioIda = parseFloat(pago.querySelector('input[name*="[precio_ida]"]').value) || 0;
                        const precioVuelta = parseFloat(pago.querySelector('input[name*="[precio_vuelta]"]').value) || 0;
                        let precioImpuesto = 0;
                        const iviSelect = pago.querySelector('.ivi-select');
                        if (iviSelect.value === 'No') {
                            precioImpuesto = parseFloat(pago.querySelector('input[name*="[precio_impuesto]"]').value) || 0;
                        }
                        const totalAereoBase = precioIda + precioVuelta + precioImpuesto;
                        totalNetoPersonaAereo = capacidadSG > 0 ? (totalAereoBase * capacidadCG) / capacidadSG : 0;
                        totalNetoUSD += totalNetoPersonaAereo;
                        precioCoordsUSD += totalNetoPersonaAereo;
                    
                    } else if (!precioGrupalInput.disabled && precioGrupalInput.value) {
                        const precioGrupal = parseFloat(precioGrupalInput.value) || 0;
                        totalIndividual = capacidadSG > 0 ? (precioGrupal * capacidadCG) / capacidadSG : 0;
                        netoPP = capacidadSG > 0 ? totalIndividual / capacidadSG : 0;
                        
                        totalNetoUSD += totalIndividual;
                        precioCoordsUSD += netoPP;
                    } else {
                        const cantidad = parseFloat(pago.querySelector('.cantidad-dias-evento').value) || 0;
                        const precio = parseFloat(pago.querySelector('.precio-nuevo-pago').value) || 0;
                        totalRegular = capacidadSG > 0 ? (cantidad * precio * capacidadCG) / capacidadSG : 0;
                        
                        totalNetoUSD += totalRegular;
                        precioCoordsUSD += totalRegular;
                    }

                    pago.querySelector('.total-nuevo-pago').value = formatCurrency(totalRegular);
                    pago.querySelector('.total-pago-individual').value = formatCurrency(totalIndividual);
                    pago.querySelector('.neto-pp').value = formatCurrency(netoPP);
                    if(pago.querySelector('.total-neto-persona-aereo')) {
                       pago.querySelector('.total-neto-persona-aereo').value = formatCurrency(totalNetoPersonaAereo);
                    }
                });
                
                const excedenteGeneralUSD = precioViaje - totalNetoUSD;
                const excedenteIndividualUSD = capacidadSG > 0 ? excedenteGeneralUSD / capacidadSG : 0;
                const excedenteGeneralCRC = excedenteGeneralUSD * tipoCambio;
                const excedenteIndividualCRC = excedenteIndividualUSD * tipoCambio;
                const precioConCoordinadoresUSD = precioCoordsUSD;
                const precioConCoordinadoresCRC = precioConCoordinadoresUSD * tipoCambio;
                const precioGeneralCoordinadoresUSD = precioConCoordinadoresUSD * capacidadSG;
                const precioGeneralCoordinadoresCRC = precioGeneralCoordinadoresUSD * tipoCambio;

                document.getElementById('excedenteGeneralUSD').textContent = formatCurrency(excedenteGeneralUSD, 'USD');
                document.getElementById('excedenteGeneralCRC').textContent = formatCurrency(excedenteGeneralCRC, 'CRC');
                document.getElementById('excedenteIndividualUSD').textContent = formatCurrency(excedenteIndividualUSD, 'USD');
                document.getElementById('excedenteIndividualCRC').textContent = formatCurrency(excedenteIndividualCRC, 'CRC');
                document.getElementById('precioConCoordinadoresUSD').textContent = formatCurrency(precioConCoordinadoresUSD, 'USD');
                document.getElementById('precioConCoordinadoresCRC').textContent = formatCurrency(precioConCoordinadoresCRC, 'CRC');
                document.getElementById('precioGeneralCoordinadoresUSD').textContent = formatCurrency(precioGeneralCoordinadoresUSD, 'USD');
                document.getElementById('precioGeneralCoordinadoresCRC').textContent = formatCurrency(precioGeneralCoordinadoresCRC, 'CRC');
            }
            
            calcularTodosLosTotales();
        });
    </script>
{% endblock %}
