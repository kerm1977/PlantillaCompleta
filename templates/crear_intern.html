{% extends 'base.html' %}

{% block title %}Crear Plan de Viaje Internacional{% endblock %}

{% block head_content %}
<style>
    .main-container {
        padding-top: 80px;
        padding-bottom: 40px;
    }
    .section-container {
        margin-bottom: 2.5rem;
        border: 1px solid #dee2e6;
        border-radius: .375rem;
        padding: 1.5rem;
        background-color: #fff;
    }
    .section-header {
        font-weight: bold;
        padding: 0.75rem 1.25rem;
        margin: -1.5rem -1.5rem 1.5rem -1.5rem;
        border-bottom: 1px solid #dee2e6;
        border-top-left-radius: .375rem;
        border-top-right-radius: .375rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .bg-warning {
        background-color: #ffc107 !important;
        color: #000;
    }
    .total-field {
        font-weight: bold;
        font-size: 1.2rem;
        text-align: right;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #dee2e6;
    }
    .dynamic-item {
        border: 1px dashed #ccc;
        padding: 1.5rem;
        padding-top: 2rem;
        margin-bottom: 1rem;
        background-color: #f8f9fa;
        position: relative;
        border-radius: .375rem;
    }
    .item-counter {
        position: absolute;
        top: -12px;
        left: -12px;
        background-color: #ffc107;
        color: black;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        border: 2px solid white;
    }
    .btn-remove-item {
        position: absolute;
        top: 10px;
        right: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5 mb-5 main-container">
    <h1 class="mb-4 text-center">Planificador de Viaje Internacional</h1>
    
    <form action="{{ url_for('intern.crear_intern') }}" method="POST" enctype="multipart/form-data">
        
        <!-- SECCIÓN DESTINO -->
        <div class="section-container">
            <div class="section-header bg-warning">DESTINO</div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="nombre_viaje" class="form-label">Nombre del Viaje</label>
                    <input type="text" class="form-control" id="nombre_viaje" name="nombre_viaje" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="flyer_file" class="form-label">Flyer del Viaje (Imagen)</label>
                    <input type="file" class="form-control" id="flyer_file" name="flyer_file" accept="image/png, image/jpeg, image/gif">
                </div>
            </div>
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label for="precio_paquete" class="form-label">Precio del Paquete</label>
                    <input type="number" step="0.01" class="form-control" id="precio_paquete" name="precio_paquete">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="capacidad" class="form-label">Capacidad</label>
                    <input type="number" class="form-control" id="capacidad" name="capacidad">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="tipo_moneda" class="form-label">Tipo de Moneda</label>
                    <select class="form-select" id="tipo_moneda" name="tipo_moneda">
                        <option value="CRC">Colones (CRC)</option>
                        <option value="USD">Dólares (USD)</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="tipo_cambio" class="form-label">Tipo de Cambio (a CRC)</label>
                    <input type="number" step="0.01" class="form-control" id="tipo_cambio" name="tipo_cambio" value="500">
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="pais" class="form-label">País</label>
                    <select class="form-select" id="pais" name="pais" required>
                        <option value="" disabled selected>Seleccione un destino</option>
                        {% for p in paises %}
                        <option value="{{ p }}">{{ p }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- SECCIÓN PRE-ALERTAS -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>LLAMADO PRE-ALERTA</span>
                <button type="button" class="btn btn-sm btn-dark" onclick="addPreAlerta()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="prealertas-container">
                <!-- Las pre-alertas se agregarán aquí dinámicamente -->
            </div>
        </div>

        <!-- SECCIÓN LUGARES A VISITAR -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>Atracciones</span>
                 <button type="button" class="btn btn-sm btn-dark" onclick="addLugar()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="lugares-container">
                <!-- Los lugares se agregarán aquí dinámicamente -->
            </div>
            <div class="total-field">TOTAL DE ATRACCIONES: CRC <span id="total-atracciones">0.00</span></div>
        </div>

        <!-- SECCIÓN TRANSPORTES -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>Transportes</span>
                <button type="button" class="btn btn-sm btn-dark" onclick="addTransporte()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="transportes-container">
                <!-- Los transportes se agregarán aquí dinámicamente -->
            </div>
            <div class="total-field">TOTAL DE TRANSPORTE: CRC <span id="total-transporte">0.00</span></div>
        </div>

        <!-- SECCIÓN GUÍAS -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>Guías</span>
                <button type="button" class="btn btn-sm btn-dark" onclick="addGuia()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="guias-container">
                <!-- Los guías se agregarán aquí dinámicamente -->
            </div>
            <div class="total-field">TOTAL DE GUÍAS POR PERSONA: CRC <span id="total-guias">0.00</span></div>
        </div>
        
        <!-- SECCIÓN ESTADÍAS -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>Estadías</span>
                <button type="button" class="btn btn-sm btn-dark" onclick="addEstadia()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="estadias-container">
                <!-- Las estadías se agregarán aquí dinámicamente -->
            </div>
            <div class="total-field">TOTAL DE ESTADÍA POR PERSONA: CRC <span id="total-estadia">0.00</span></div>
        </div>

        <!-- SECCIÓN AEROLÍNEA -->
        <div class="section-container">
            <div class="section-header bg-warning">
                <span>Aerolínea / Transporte Principal</span>
                <button type="button" class="btn btn-sm btn-dark" onclick="addAerolinea()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div id="aerolineas-container">
                <!-- Las aerolíneas se agregarán aquí dinámicamente -->
            </div>
            <div class="total-field">TOTAL DE AEROLÍNEA POR PERSONA: CRC <span id="total-aerolinea">0.00</span></div>
        </div>

        <!-- SECCIÓN DE TOTALES GENERALES -->
        <div class="section-container text-center">
            <div class="section-header bg-warning justify-content-center">TOTALES GENERALES</div>
            <div class="row">
                <div class="col-md-6">
                    <p class="total-field" style="border-top: none; text-align: center;">TOTAL INDIVIDUAL (CRC): <span class="badge bg-success fs-5" id="total-crc">0.00</span></p>
                </div>
                <div class="col-md-6">
                    <p class="total-field" style="border-top: none; text-align: center;">TOTAL INDIVIDUAL (USD): <span class="badge bg-primary fs-5" id="total-usd">0.00</span></p>
                </div>
            </div>
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-warning btn-lg">Crear Plan de Viaje</button>
        </div>
    </form>

    <!-- SECCIÓN CALCULADORA -->
    <div class="section-container mt-5">
        <div class="section-header bg-warning justify-content-center">Calculadora de Divisas</div>
        <div class="row align-items-center">
            <div class="col-md-3">
                <label for="calc-amount" class="form-label">Monto</label>
                <input type="number" class="form-control" id="calc-amount" placeholder="100">
            </div>
            <div class="col-md-3">
                <label for="calc-from" class="form-label">De:</label>
                <select class="form-select" id="calc-from">
                    <option value="USD">Dólar USA (USD)</option>
                    <option value="CRC" selected>Colón (CRC)</option>
                    <option value="GTQ">Quetzal (GTQ)</option>
                    <option value="HNL">Lempira (HNL)</option>
                    <option value="NIO">Córdoba (NIO)</option>
                    <option value="PAB">Balboa (PAB)</option>
                </select>
            </div>
            <div class="col-md-1 text-center">
                <i class="fas fa-exchange-alt fs-4"></i>
            </div>
            <div class="col-md-3">
                <label for="calc-to" class="form-label">A:</label>
                <select class="form-select" id="calc-to">
                    <option value="USD" selected>Dólar USA (USD)</option>
                    <option value="CRC">Colón (CRC)</option>
                    <option value="GTQ">Quetzal (GTQ)</option>
                    <option value="HNL">Lempira (HNL)</option>
                    <option value="NIO">Córdoba (NIO)</option>
                    <option value="PAB">Balboa (PAB)</option>
                </select>
            </div>
            <div class="col-md-2 d-grid">
                 <button class="btn btn-primary mt-3" onclick="convertCurrency()">Convertir</button>
            </div>
        </div>
        <div class="mt-3 text-center">
            <h4>Resultado: <span id="calc-result" class="badge bg-success">0.00</span></h4>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Contadores para los elementos dinámicos
    let preAlertaCount = 0;
    let lugarCount = 0;
    let transporteCount = 0;
    let guiaCount = 0;
    let estadiaCount = 0;
    let aerolineaCount = 0;

    // --- FUNCIONES PARA AÑADIR ELEMENTOS ---

    function addPreAlerta() {
        preAlertaCount++;
        const container = document.getElementById('prealertas-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `prealerta-${preAlertaCount}`;
        newItem.innerHTML = `
            <span class="item-counter">${preAlertaCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('prealerta-${preAlertaCount}')"></button>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Banco</label>
                    <select name="prealerta_banco[]" class="form-select">
                        <option selected disabled>Seleccione un banco</option>
                        {% for banco in bancos %}
                        <option value="{{ banco }}">{{ banco }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Teléfono Entidad Financiera</label>
                    <input type="text" name="prealerta_telefono[]" class="form-control">
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Fecha de la prealerta</label>
                    <input type="date" name="prealerta_fecha[]" class="form-control">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Nombre del Asesor Bancario</label>
                    <input type="text" name="prealerta_asesor[]" class="form-control">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Hora de la Prealerta</label>
                    <input type="time" name="prealerta_hora[]" class="form-control">
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Número de la prealerta</label>
                    <input type="text" name="prealerta_numero[]" class="form-control">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Fecha prealertada desde</label>
                    <input type="date" name="prealerta_desde[]" class="form-control">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Fecha prealertada hasta</label>
                    <input type="date" name="prealerta_hasta[]" class="form-control">
                </div>
            </div>
        `;
        container.appendChild(newItem);
    }

    function addLugar() {
        lugarCount++;
        const container = document.getElementById('lugares-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `lugar-${lugarCount}`;
        newItem.innerHTML = `
            <span class="item-counter">${lugarCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('lugar-${lugarCount}', updateTotalAtracciones)"></button>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Tipo de Lugar</label>
                    <select name="lugar_tipo[]" class="form-select">
                        <option>Volcán</option><option>Montaña</option><option>Playa</option><option>Ciudad</option><option>Parque Nacional</option><option>Camino</option><option>Otros</option>
                    </select>
                </div>
                <div class="col-md-5 mb-3">
                    <label class="form-label">Nombre de Sitio</label>
                    <input type="text" name="lugar_nombre[]" class="form-control">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Precio de Entrada (CRC)</label>
                    <input type="number" step="0.01" name="lugar_precio[]" class="form-control price-atraccion" oninput="updateTotalAtracciones()">
                </div>
            </div>
        `;
        container.appendChild(newItem);
    }
    
    function addTransporte() {
        transporteCount++;
        const container = document.getElementById('transportes-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `transporte-${transporteCount}`;
        newItem.innerHTML = `
            <span class="item-counter">${transporteCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('transporte-${transporteCount}', updateTotalTransporte)"></button>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Tipo</label>
                    <select name="transporte_tipo[]" class="form-select">
                        <option>Buseta</option><option>Bus</option><option>Taxi</option><option>Uber</option><option>Auto</option><option>Lancha</option><option>Avión</option>
                    </select>
                </div>
                <div class="col-md-5 mb-3">
                    <label class="form-label">Nombre del Transporte</label>
                    <input type="text" name="transporte_nombre[]" class="form-control">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Precio (CRC)</label>
                    <input type="number" step="0.01" name="transporte_precio[]" class="form-control price-transporte" oninput="updateTotalTransporte()">
                </div>
            </div>
        `;
        container.appendChild(newItem);
    }

    function addGuia() {
        guiaCount++;
        const container = document.getElementById('guias-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `guia-${guiaCount}`;
        newItem.innerHTML = `
            <span class="item-counter">${guiaCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('guia-${guiaCount}', updateTotalGuias)"></button>
            <div class="row">
                <div class="col-md-8 mb-3">
                    <label class="form-label">Nombre</label>
                    <input type="text" name="guia_nombre[]" class="form-control">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Precio Guía PP (CRC)</label>
                    <input type="number" step="0.01" name="guia_precio_pp[]" class="form-control price-guia-pp" oninput="updateTotalGuias()">
                </div>
            </div>
            <div class="row">
                <div class="col-md-8 mb-3">
                    <label class="form-label">Operador</label>
                    <input type="text" name="guia_operador[]" class="form-control">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Precio Acarreo (CRC)</label>
                    <input type="number" step="0.01" name="guia_acarreo[]" class="form-control price-guia-acarreo" oninput="updateTotalGuias()">
                </div>
            </div>
        `;
        container.appendChild(newItem);
    }

    function addEstadia() {
        estadiaCount++;
        const container = document.getElementById('estadias-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `estadia-${estadiaCount}`;
        newItem.innerHTML = `
            <span class="item-counter">${estadiaCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('estadia-${estadiaCount}', updateTotalEstadia)"></button>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Nombre</label>
                    <input type="text" name="estadia_nombre[]" class="form-control">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Precio PP por Noche (CRC)</label>
                    <input type="number" step="0.01" name="estadia_precio_pp[]" class="form-control price-estadia-pp" oninput="updateTotalEstadia()">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Cantidad de Noches</label>
                    <input type="number" name="estadia_noches[]" class="form-control noches-estadia" value="1" oninput="updateTotalEstadia()">
                </div>
            </div>
        `;
        container.appendChild(newItem);
    }

    function addAerolinea() {
        aerolineaCount++;
        const container = document.getElementById('aerolineas-container');
        const newItem = document.createElement('div');
        newItem.className = 'dynamic-item';
        newItem.id = `aerolinea-${aerolineaCount}`;
        newItem.innerHTML = `
            <span class="item-counter">${aerolineaCount}</span>
            <button type="button" class="btn-close btn-remove-item" aria-label="Close" onclick="removeItem('aerolinea-${aerolineaCount}', updateTotalAerolinea)"></button>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Tipo de Transporte</label>
                    <select name="aerolinea_tipo_transporte[]" class="form-select tipo-transporte-aerolinea" onchange="toggleAerolineaFields(this)">
                        <option>Avión</option><option>Bus</option><option>Buseta</option><option>Auto</option><option>Moto</option><option>Barco</option>
                    </select>
                </div>
                <div class="col-md-8 mb-3 aerolinea-fields">
                    <label class="form-label">Aerolínea</label>
                    <select name="aerolinea_nombre[]" class="form-select">
                        <option selected disabled>Seleccione una aerolínea</option>
                        {% for aerolinea in aerolineas_opciones %}
                        <option value="{{ aerolinea }}">{{ aerolinea }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="aerolinea-fields">
                <div class="row">
                    <div class="col-md-3 mb-3"><label class="form-label">Precio Asientos</label><input type="number" step="0.01" name="aerolinea_precio_asientos[]" class="form-control price-aerolinea" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label">Precio Maletas Doc.</label><input type="number" step="0.01" name="aerolinea_precio_maletas[]" class="form-control price-aerolinea" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label">Equipaje de Mano</label><input type="number" step="0.01" name="aerolinea_equipaje_mano[]" class="form-control price-aerolinea" oninput="updateTotalAerolinea()"></div>
                    <div class="col-md-3 mb-3"><label class="form-label">Precio Impuestos</label><input type="number" step="0.01" name="aerolinea_impuestos[]" class="form-control price-aerolinea" oninput="updateTotalAerolinea()"></div>
                </div>
            </div>
        `;
        container.appendChild(newItem);
    }

    function removeItem(id, callback) {
        const item = document.getElementById(id);
        if (item) {
            item.remove();
            if (callback) {
                callback();
            }
        }
    }
    
    function toggleAerolineaFields(selectElement) {
        const parentItem = selectElement.closest('.dynamic-item');
        const aerolineaFields = parentItem.querySelectorAll('.aerolinea-fields');
        if (selectElement.value === 'Avión') {
            aerolineaFields.forEach(field => field.style.display = 'block');
        } else {
            aerolineaFields.forEach(field => field.style.display = 'none');
        }
    }

    // --- FUNCIONES PARA ACTUALIZAR TOTALES ---

    function updateTotalAtracciones() {
        let total = 0;
        document.querySelectorAll('.price-atraccion').forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        document.getElementById('total-atracciones').textContent = total.toFixed(2);
        updateGrandTotals();
    }

    function updateTotalTransporte() {
        let total = 0;
        document.querySelectorAll('.price-transporte').forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        document.getElementById('total-transporte').textContent = total.toFixed(2);
        updateGrandTotals();
    }

    function updateTotalGuias() {
        let total = 0;
        document.querySelectorAll('.dynamic-item[id^="guia-"]').forEach(item => {
            const precioPP = parseFloat(item.querySelector('.price-guia-pp').value) || 0;
            const acarreo = parseFloat(item.querySelector('.price-guia-acarreo').value) || 0;
            total += precioPP + acarreo;
        });
        document.getElementById('total-guias').textContent = total.toFixed(2);
        updateGrandTotals();
    }

    function updateTotalEstadia() {
        let total = 0;
        document.querySelectorAll('.dynamic-item[id^="estadia-"]').forEach(item => {
            const precioPP = parseFloat(item.querySelector('.price-estadia-pp').value) || 0;
            const noches = parseInt(item.querySelector('.noches-estadia').value) || 1;
            total += precioPP * noches;
        });
        document.getElementById('total-estadia').textContent = total.toFixed(2);
        updateGrandTotals();
    }

    function updateTotalAerolinea() {
        let total = 0;
        document.querySelectorAll('.price-aerolinea').forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        document.getElementById('total-aerolinea').textContent = total.toFixed(2);
        updateGrandTotals();
    }

    function updateGrandTotals() {
        const totalAtracciones = parseFloat(document.getElementById('total-atracciones').textContent) || 0;
        const totalTransporte = parseFloat(document.getElementById('total-transporte').textContent) || 0;
        const totalGuias = parseFloat(document.getElementById('total-guias').textContent) || 0;
        const totalEstadia = parseFloat(document.getElementById('total-estadia').textContent) || 0;
        const totalAerolinea = parseFloat(document.getElementById('total-aerolinea').textContent) || 0;
        
        const totalCRC = totalAtracciones + totalTransporte + totalGuias + totalEstadia + totalAerolinea;
        const tipoCambio = parseFloat(document.getElementById('tipo_cambio').value) || 1;
        const totalUSD = totalCRC / tipoCambio;

        document.getElementById('total-crc').textContent = totalCRC.toFixed(2);
        document.getElementById('total-usd').textContent = totalUSD.toFixed(2);
    }

    // --- LÓGICA DE LA CALCULADORA ---
    function convertCurrency() {
        const amount = parseFloat(document.getElementById('calc-amount').value);
        const fromCurrency = document.getElementById('calc-from').value;
        const toCurrency = document.getElementById('calc-to').value;
        const resultSpan = document.getElementById('calc-result');

        if (isNaN(amount)) {
            resultSpan.textContent = "Monto inválido";
            resultSpan.className = 'badge bg-danger';
            return;
        }

        // Tipos de cambio aproximados (idealmente se obtendrían de una API)
        const rates = {
            'USD': 1.0,
            'CRC': 500.0, // 1 USD = 500 CRC
            'GTQ': 7.8,   // 1 USD = 7.8 GTQ
            'HNL': 24.7,  // 1 USD = 24.7 HNL
            'NIO': 36.6,  // 1 USD = 36.6 NIO
            'PAB': 1.0    // 1 USD = 1 PAB
        };

        const amountInUSD = amount / rates[fromCurrency];
        const convertedAmount = amountInUSD * rates[toCurrency];

        resultSpan.textContent = `${convertedAmount.toFixed(2)} ${toCurrency}`;
        resultSpan.className = 'badge bg-success';
    }
</script>
{% endblock %}
